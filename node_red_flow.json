[
    {
        "id": "7351bc4077f8b06d",
        "type": "group",
        "z": "606aeeb2baf6caa6",
        "style": {
            "stroke": "#999999",
            "stroke-opacity": "1",
            "fill": "none",
            "fill-opacity": "1",
            "label": true,
            "label-position": "nw",
            "color": "#a4a4a4"
        },
        "nodes": [
            "324147cf77ee66de",
            "d6b6db502565868a",
            "97e2353b34d2ff35",
            "400147b2a7c1bccf",
            "e052d07866326de3",
            "22143cf47a240b92",
            "f5859804d4cb24fa",
            "8b90af6fc5e86017",
            "425c5212a151b142",
            "e7d7ca38660b595b",
            "3f0fdcf240a11d38",
            "f3cc3cb5807b98cc",
            "46840aae0f0153d2",
            "e68a879fe5e9ae6d",
            "3d43d3b42da87cb8",
            "fe2aabeba7061bf6",
            "b32328e98310a432",
            "02d870e848997f02",
            "41a814b251b3d9c1",
            "b028d24f4566ecc8",
            "691f4ec5ad460365",
            "6656abfed82220f2",
            "1484cab31fed3268"
        ],
        "x": 14,
        "y": 53,
        "w": 3258,
        "h": 4534
    },
    {
        "id": "324147cf77ee66de",
        "type": "group",
        "z": "606aeeb2baf6caa6",
        "g": "7351bc4077f8b06d",
        "style": {
            "stroke": "#999999",
            "stroke-opacity": "1",
            "fill": "none",
            "fill-opacity": "1",
            "label": true,
            "label-position": "nw",
            "color": "#a4a4a4"
        },
        "nodes": [
            "fe4908f269cee856",
            "d03d3b7889fe0c9f",
            "c1fb1a61865ed10b",
            "b9fc9e1ca3bae262",
            "56c281045d74147c",
            "f468e05bf48dadfb",
            "da2e9d5c82f73ece",
            "cd72fb68bafeb66f",
            "9390389ff277b9b2",
            "8e7a9a0599c735e5",
            "13aea0ed91e906af",
            "ae428e7b3cc74e71",
            "e62e4f05298c8374",
            "ceb5f1cb327fe884",
            "461f1ed5de1b4d24",
            "2c928571fefa512e",
            "c91edeea2856ee0b",
            "4fadd2c29a6a3b3e"
        ],
        "x": 574,
        "y": 479,
        "w": 1112,
        "h": 322
    },
    {
        "id": "fe4908f269cee856",
        "type": "function",
        "z": "606aeeb2baf6caa6",
        "g": "324147cf77ee66de",
        "name": "Model",
        "func": "\nif (Array.isArray(msg.payload)) {\n    \n    \n    var match = msg.payload.find(item => item.machine === \"1200/2\");\n\n    if (match) {\n        msg.payload = match.detail_g; \n        msg.topic = \"model\"; \n        return msg;\n    }\n}\n\nreturn null;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 770,
        "y": 640,
        "wires": [
            [
                "ae428e7b3cc74e71"
            ]
        ]
    },
    {
        "id": "d03d3b7889fe0c9f",
        "type": "function",
        "z": "606aeeb2baf6caa6",
        "g": "324147cf77ee66de",
        "name": "Total Pcs.",
        "func": "// 1. ตรวจสอบก่อนว่าเป็น Array (รายการ) หรือไม่ เพื่อกัน Error\nif (!Array.isArray(msg.payload)) {\n    // ถ้าไม่ใช่ List รายการ ให้ข้ามไป\n    return null; \n}\n\n// 2. ค้นหาเครื่องจักรชื่อ \"1200/1\" (แก้ชื่อตรงนี้ได้ตามจริง)\nvar match = msg.payload.find(item => item.machine === \"1200/2\");\n\nif (match) {\n    // 3. ดึงค่าผลรวม Z มาใส่ payload\n    msg.payload = match.detail_z; \n\n    // 4. --- กำหนดชื่อหัวข้อ (สำคัญมาก) ---\n    // เพื่อให้ Join Node รู้ว่าค่านี่คือ \"detail_z\"\n    msg.topic = \"total_pcs\"; \n\n    return msg;\n}\n\n// ถ้าหาไม่เจอ ให้คืนค่า null\nreturn null;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 780,
        "y": 680,
        "wires": [
            [
                "ae428e7b3cc74e71"
            ]
        ]
    },
    {
        "id": "c1fb1a61865ed10b",
        "type": "comment",
        "z": "606aeeb2baf6caa6",
        "g": "324147cf77ee66de",
        "name": "2",
        "info": "",
        "x": 1030,
        "y": 720,
        "wires": []
    },
    {
        "id": "b9fc9e1ca3bae262",
        "type": "modbus-read",
        "z": "606aeeb2baf6caa6",
        "g": "324147cf77ee66de",
        "name": "40002",
        "topic": "",
        "showStatusActivities": false,
        "logIOActivities": false,
        "showErrors": false,
        "showWarnings": true,
        "unitid": "",
        "dataType": "HoldingRegister",
        "adr": "1",
        "quantity": "1",
        "rate": "1",
        "rateUnit": "s",
        "delayOnStart": false,
        "enableDeformedMessages": false,
        "startDelayTime": "",
        "server": "0c4c5f7d19292b8b",
        "useIOFile": false,
        "ioFile": "",
        "useIOForPayload": false,
        "emptyMsgOnFail": false,
        "x": 670,
        "y": 520,
        "wires": [
            [],
            [
                "56c281045d74147c"
            ]
        ]
    },
    {
        "id": "56c281045d74147c",
        "type": "function",
        "z": "606aeeb2baf6caa6",
        "g": "324147cf77ee66de",
        "name": "Present cycle",
        "func": "// ดึงค่าจาก msg.payload.data[0]\nlet rawValue = msg.payload.data[0];\n\n// หาร 10 เพื่อแปลงเป็นค่าทศนิยม\nlet displayValue = rawValue / 10;\n\n// ใส่ค่าใน msg.payload สำหรับแสดงบน dashboard\nmsg.payload = displayValue;\n\nmsg.topic = \"present_cycle\";\n\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 800,
        "y": 520,
        "wires": [
            [
                "ae428e7b3cc74e71"
            ]
        ]
    },
    {
        "id": "f468e05bf48dadfb",
        "type": "modbus-read",
        "z": "606aeeb2baf6caa6",
        "g": "324147cf77ee66de",
        "name": "40003",
        "topic": "",
        "showStatusActivities": false,
        "logIOActivities": false,
        "showErrors": false,
        "showWarnings": true,
        "unitid": "",
        "dataType": "HoldingRegister",
        "adr": "2",
        "quantity": "1",
        "rate": "1",
        "rateUnit": "s",
        "delayOnStart": false,
        "enableDeformedMessages": false,
        "startDelayTime": "",
        "server": "0c4c5f7d19292b8b",
        "useIOFile": false,
        "ioFile": "",
        "useIOForPayload": false,
        "emptyMsgOnFail": false,
        "x": 670,
        "y": 560,
        "wires": [
            [],
            [
                "da2e9d5c82f73ece"
            ]
        ]
    },
    {
        "id": "da2e9d5c82f73ece",
        "type": "function",
        "z": "606aeeb2baf6caa6",
        "g": "324147cf77ee66de",
        "name": "Last cycle",
        "func": "// ดึงค่าจาก msg.payload.data[0]\nlet rawValue = msg.payload.data[0];\n\n// หาร 10 เพื่อแปลงเป็นค่าทศนิยม\nlet displayValue = rawValue / 10;\n\n// ใส่ค่าใน msg.payload สำหรับแสดงบน dashboard\nmsg.payload = displayValue;\nmsg.topic = \"last_cycle\";\n\n\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 790,
        "y": 560,
        "wires": [
            [
                "ae428e7b3cc74e71"
            ]
        ]
    },
    {
        "id": "cd72fb68bafeb66f",
        "type": "function",
        "z": "606aeeb2baf6caa6",
        "g": "324147cf77ee66de",
        "name": "CAVITY",
        "func": "// ดึงค่าจาก msg.payload.data[0]\nlet rawValue = msg.payload.data[0];\n\n// หาร 10 เพื่อแปลงเป็นค่าทศนิยม\nlet displayValue = rawValue ;\n\n// ใส่ค่าใน msg.payload สำหรับแสดงบน dashboard\nmsg.payload = displayValue;\nmsg.topic = \"cavity\";\n\n\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 780,
        "y": 720,
        "wires": [
            [
                "ae428e7b3cc74e71"
            ]
        ]
    },
    {
        "id": "9390389ff277b9b2",
        "type": "modbus-read",
        "z": "606aeeb2baf6caa6",
        "g": "324147cf77ee66de",
        "name": "40017",
        "topic": "",
        "showStatusActivities": false,
        "logIOActivities": false,
        "showErrors": false,
        "showWarnings": true,
        "unitid": "",
        "dataType": "HoldingRegister",
        "adr": "16",
        "quantity": "1",
        "rate": "1",
        "rateUnit": "s",
        "delayOnStart": false,
        "enableDeformedMessages": false,
        "startDelayTime": "",
        "server": "0c4c5f7d19292b8b",
        "useIOFile": false,
        "ioFile": "",
        "useIOForPayload": false,
        "emptyMsgOnFail": false,
        "x": 670,
        "y": 760,
        "wires": [
            [],
            [
                "8e7a9a0599c735e5"
            ]
        ]
    },
    {
        "id": "8e7a9a0599c735e5",
        "type": "function",
        "z": "606aeeb2baf6caa6",
        "g": "324147cf77ee66de",
        "name": "STD CYCLE ",
        "func": "// ดึงค่าจาก msg.payload.data[0]\nlet rawValue = msg.payload.data[0];\n\n// หาร 10 เพื่อแปลงเป็นค่าทศนิยม\nlet displayValue = rawValue ;\n\n// ใส่ค่าใน msg.payload สำหรับแสดงบน dashboard\nmsg.payload = displayValue;\nmsg.topic = \"std_cycle\";\n\n\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 790,
        "y": 760,
        "wires": [
            [
                "ae428e7b3cc74e71"
            ]
        ]
    },
    {
        "id": "13aea0ed91e906af",
        "type": "modbus-read",
        "z": "606aeeb2baf6caa6",
        "g": "324147cf77ee66de",
        "name": "40016",
        "topic": "",
        "showStatusActivities": false,
        "logIOActivities": false,
        "showErrors": false,
        "showWarnings": true,
        "unitid": "",
        "dataType": "HoldingRegister",
        "adr": "15",
        "quantity": "1",
        "rate": "1",
        "rateUnit": "s",
        "delayOnStart": false,
        "enableDeformedMessages": false,
        "startDelayTime": "",
        "server": "0c4c5f7d19292b8b",
        "useIOFile": false,
        "ioFile": "",
        "useIOForPayload": false,
        "emptyMsgOnFail": false,
        "x": 670,
        "y": 720,
        "wires": [
            [],
            [
                "cd72fb68bafeb66f"
            ]
        ]
    },
    {
        "id": "ae428e7b3cc74e71",
        "type": "join",
        "z": "606aeeb2baf6caa6",
        "g": "324147cf77ee66de",
        "name": "รวมข้อมูล (Join)",
        "mode": "custom",
        "build": "object",
        "property": "payload",
        "propertyType": "msg",
        "key": "topic",
        "joiner": "\\n",
        "joinerType": "str",
        "useparts": true,
        "accumulate": true,
        "timeout": "15",
        "count": "7",
        "reduceRight": false,
        "reduceExp": "",
        "reduceInit": "",
        "reduceInitType": "",
        "reduceFixup": "",
        "x": 1030,
        "y": 640,
        "wires": [
            [
                "c91edeea2856ee0b"
            ]
        ]
    },
    {
        "id": "e62e4f05298c8374",
        "type": "function",
        "z": "606aeeb2baf6caa6",
        "g": "324147cf77ee66de",
        "name": "ตั้งค่า Data & Save Global",
        "func": "// 1. --- ตั้งค่า Config (ต้องประกาศตัวแปรที่นี่เพื่อแก้ Error) ---\nvar mySheetID = \"1RJ9OI8Bz8Xy_7HW7fZVQnjeYshDd0BZUZrkG3ycJfy0\"; \nvar machineID = 2;\nvar machineName = \"1200-2\"; // เปลี่ยนชื่อตามเครื่องนั้นๆ\n\n// รับข้อมูลจาก Node Join\nvar data = msg.payload;\nvar now = new Date().toLocaleString(\"th-TH\", { timeZone: \"Asia/Bangkok\" });\n\n// กำหนดค่า Status ให้เป็นเลข 1 หรือ 0 (เช็คจาก Topic M200 หรือชื่อ status_mc_on)\nvar currentStatus = (data.status_mc_on == 1 || data.M200 == 1) ? 1 : 0;\n\n// 2. --- อัปเดตข้อมูลสำหรับ React (Global Variable) ---\nvar reactData = {\n    id: machineID,\n    name: machineName,\n    machine_no: machineName,\n    status: currentStatus,\n    present_cycle: parseFloat(data.present_cycle || data.D250 || 0),\n    last_cycle: parseFloat(data.last_cycle || data.D251 || 0),\n    std_cycle: parseFloat(data.std_cycle || data.D433 || 0),\n    model: data.model || 0, \n    cavity: parseFloat(data.cavity || data.D432 || 0),\n    total_pcs: parseFloat(data.total_pcs || 0),\n    timestamp: now\n};\n\n// เก็บลงตัวแปร Global\nvar allMachines = global.get(\"machineData\") || [];\nvar idx = allMachines.findIndex(m => m.id === machineID);\nif (idx !== -1) allMachines[idx] = Object.assign(allMachines[idx], reactData);\nelse allMachines.push(reactData);\nglobal.set(\"machineData\", allMachines);\n\n// 3. --- เตรียมข้อมูลส่งไป Google Sheet ---\n// สร้าง Payload ใหม่ส่งไป เพื่อให้ชื่อคอลัมน์ใน Excel เรียงสวยและถูกต้อง\nmsg.payload = {\n    \"spreadsheetId\": mySheetID,\n    \"timestamp\": now,\n    \"machine_no\": machineName,\n    \"status_mc_on\": currentStatus,\n    \"model\": reactData.model,\n    \"present_cycle\": reactData.present_cycle,\n    \"last_cycle\": reactData.last_cycle,\n    \"std_cycle\": reactData.std_cycle,\n    \"cavity\": reactData.cavity,\n    \"total_pcs\": reactData.total_pcs\n};\n\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1250,
        "y": 720,
        "wires": [
            []
        ]
    },
    {
        "id": "ceb5f1cb327fe884",
        "type": "modbus-read",
        "z": "606aeeb2baf6caa6",
        "g": "324147cf77ee66de",
        "name": "40001",
        "topic": "",
        "showStatusActivities": false,
        "logIOActivities": false,
        "showErrors": false,
        "showWarnings": true,
        "unitid": "",
        "dataType": "HoldingRegister",
        "adr": "0",
        "quantity": "1",
        "rate": "1",
        "rateUnit": "s",
        "delayOnStart": false,
        "enableDeformedMessages": false,
        "startDelayTime": "",
        "server": "0c4c5f7d19292b8b",
        "useIOFile": false,
        "ioFile": "",
        "useIOForPayload": false,
        "emptyMsgOnFail": false,
        "x": 670,
        "y": 600,
        "wires": [
            [],
            [
                "461f1ed5de1b4d24"
            ]
        ]
    },
    {
        "id": "461f1ed5de1b4d24",
        "type": "function",
        "z": "606aeeb2baf6caa6",
        "g": "324147cf77ee66de",
        "name": "status Mc on",
        "func": "let value = msg.payload.data[0];\n\nif (value === 1) {\n    msg.payload = \"ON\";\n} else if (value === 0) {\n    msg.payload = \"OFF\";\n} else {\n    msg.payload = \"Unknown\";  // กรณีที่ค่าไม่ใช่ 1 หรือ 0\n}\n msg.topic = \"status_mc_on\"; \nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 790,
        "y": 600,
        "wires": [
            [
                "ae428e7b3cc74e71"
            ]
        ]
    },
    {
        "id": "2c928571fefa512e",
        "type": "function",
        "z": "606aeeb2baf6caa6",
        "g": "324147cf77ee66de",
        "name": "ตั้งค่า Data & Save Global V2",
        "func": "// 1. --- ตั้งค่า Config ---\nvar mySheetID = \"1RJ9OI8Bz8Xy_7HW7fZVQnjeYshDd0BZUZrkG3ycJfy0\"; // ใส่ ID Sheet\nvar machineID = 2;\nvar machineName = \"1200-2\"; // <--- ชื่อที่จะไปโชว์ใน Excel ช่อง B\n\n// รับข้อมูลรวมจาก Join\nvar data = msg.payload;\nvar now = new Date().toLocaleString(\"th-TH\", { timeZone: \"Asia/Bangkok\" });\n\n// 2. --- อัปเดตข้อมูลสำหรับ React (Global Variable) ---\nvar reactData = {\n    id: machineID,\n    name: machineName,\n    machine_no: machineName,\n    status: (data.status_mc_on == 1) ? 1 : 0,\n    present_cycle: parseFloat(data.present_cycle || 0),\n    last_cycle: parseFloat(data.last_cycle || 0),\n    std_cycle: parseFloat(data.std_cycle || 0),\n    \n    // *** แก้ตรงนี้ด้วยนิดนึงครับ ***\n    // Model มักเป็นตัวหนังสือ (เช่น HC00443E) ห้ามใช้ parseFloat ไม่งั้นค่าจะเพี้ยนเป็น NaN หรือ 0\n    model: data.model || \"-\", \n    \n    cavity: parseFloat(data.cavity || 0),\n    total_pcs: parseFloat(data.total_pcs || 0),\n    timestamp: now\n};\n\n// เก็บลงตัวแปรกลาง\nvar allMachines = global.get(\"machineData\") || [];\nvar idx = allMachines.findIndex(m => m.id === machineID);\nif (idx !== -1) allMachines[idx] = Object.assign(allMachines[idx], reactData);\nelse allMachines.push(reactData);\nglobal.set(\"machineData\", allMachines);\n\n// 3. --- เตรียมข้อมูลส่ง Google Sheet ---\ndata.spreadsheetId = mySheetID;\ndata.timestamp = now;\n\n// >>> เติมบรรทัดนี้ครับ เพื่อให้ Google Sheet รู้จักชื่อเครื่อง <<<\ndata.machine_no = machineName; \n\nmsg.payload = data;\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1480,
        "y": 640,
        "wires": [
            [
                "4fadd2c29a6a3b3e"
            ]
        ]
    },
    {
        "id": "c91edeea2856ee0b",
        "type": "function",
        "z": "606aeeb2baf6caa6",
        "g": "324147cf77ee66de",
        "name": "เช็คความครบ",
        "func": "// รายชื่อหัวข้อข้อมูลที่ต้องมีให้ครบ 7 ตัว\nvar requiredKeys = [\n    \"present_cycle\", \n    \"last_cycle\", \n    \"cavity\", \n    \"std_cycle\", \n    \"status_mc_on\", \n    \"model\", \n    \"total_pcs\"\n];\n\n// ดึงคีย์ที่มีอยู่ใน msg.payload ตอนนี้\nvar currentKeys = Object.keys(msg.payload);\n\n// เช็คว่าขาดตัวไหนไปบ้าง\nvar missing = requiredKeys.filter(function(key) {\n    return !currentKeys.includes(key);\n});\n\n// ถ้ามีตัวที่ขาด (missing > 0)\nif (missing.length > 0) {\n    // บันทึก Log ว่าขาดอะไร (ดูใน Debug)\n    node.warn(\"ข้อมูลไม่ครบ! ขาด: \" + missing.join(\", \"));\n    return null; // *** หยุดการส่งข้อมูลทันที ไม่ไปต่อ ***\n}\n\n// ถ้าครบถ้วน ให้ไปต่อ\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1230,
        "y": 640,
        "wires": [
            [
                "2c928571fefa512e"
            ]
        ]
    },
    {
        "id": "4fadd2c29a6a3b3e",
        "type": "link out",
        "z": "606aeeb2baf6caa6",
        "g": "324147cf77ee66de",
        "name": "IN 2",
        "mode": "link",
        "links": [
            "6eb85d63cf4a88f4"
        ],
        "x": 1645,
        "y": 640,
        "wires": []
    },
    {
        "id": "0c4c5f7d19292b8b",
        "type": "modbus-client",
        "name": "1200-2",
        "clienttype": "tcp",
        "bufferCommands": true,
        "stateLogEnabled": false,
        "queueLogEnabled": false,
        "failureLogEnabled": true,
        "tcpHost": "192.168.7.125",
        "tcpPort": 502,
        "tcpType": "DEFAULT",
        "serialPort": "/dev/ttyUSB",
        "serialType": "RTU-BUFFERD",
        "serialBaudrate": 9600,
        "serialDatabits": 8,
        "serialStopbits": 1,
        "serialParity": "none",
        "serialConnectionDelay": 100,
        "serialAsciiResponseStartDelimiter": "0x3A",
        "unit_id": 2,
        "commandDelay": 1,
        "clientTimeout": 1000,
        "reconnectOnTimeout": true,
        "reconnectTimeout": 2000,
        "parallelUnitIdsAllowed": true,
        "showErrors": false,
        "showWarnings": true,
        "showLogs": true
    },
    {
        "id": "d6b6db502565868a",
        "type": "group",
        "z": "606aeeb2baf6caa6",
        "g": "7351bc4077f8b06d",
        "name": "ส่งไปยัง sheet เเละ ไป Web ต่อ",
        "style": {
            "stroke": "#ffC000",
            "fill": "#ffff7f",
            "label": true,
            "fill-opacity": "0.55"
        },
        "nodes": [
            "9426798f14a5b3cf",
            "bd3638f9233fcca6",
            "e8ff5987d93523bc",
            "944c4685b6c28c96",
            "ae36e7eca5a9dd9e",
            "5d53dfe8ce6b1506",
            "27bc3f3a29d7abce",
            "e78c71770025b740",
            "337074fc13258ca5",
            "668bf53d4dbaa9c9",
            "9873fdcf593e139e",
            "3999f23797f10412",
            "a1b996b635f46b78",
            "29968f3cced10bea",
            "f7eda85cc32730af"
        ],
        "x": 584,
        "y": 79,
        "w": 1018,
        "h": 382
    },
    {
        "id": "9426798f14a5b3cf",
        "type": "function",
        "z": "606aeeb2baf6caa6",
        "g": "d6b6db502565868a",
        "name": "Model",
        "func": "var match = msg.payload.find(item => item.machine === \"1200/1\");\nif (match) {\n    msg.payload = match.detail_g;\n    msg.topic = \"model\"; \n\n    return msg;\n}\nreturn null;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 930,
        "y": 280,
        "wires": [
            [
                "1b94b87af272047f"
            ]
        ]
    },
    {
        "id": "bd3638f9233fcca6",
        "type": "comment",
        "z": "606aeeb2baf6caa6",
        "g": "d6b6db502565868a",
        "name": "1200/1",
        "info": "",
        "x": 1110,
        "y": 340,
        "wires": []
    },
    {
        "id": "e8ff5987d93523bc",
        "type": "Ind MC Read",
        "z": "606aeeb2baf6caa6",
        "g": "d6b6db502565868a",
        "name": "Present cycle",
        "topic": "",
        "connection": "603efad4e9464db5",
        "address": "D250",
        "addressType": "str",
        "outputFormat": 0,
        "errorHandling": "throw",
        "outputs": 1,
        "x": 780,
        "y": 120,
        "wires": [
            [
                "ae36e7eca5a9dd9e"
            ]
        ]
    },
    {
        "id": "944c4685b6c28c96",
        "type": "Ind MC Read",
        "z": "606aeeb2baf6caa6",
        "g": "d6b6db502565868a",
        "name": "Last cycle",
        "topic": "",
        "connection": "603efad4e9464db5",
        "address": "D251",
        "addressType": "str",
        "outputFormat": 0,
        "errorHandling": "throw",
        "outputs": 1,
        "x": 760,
        "y": 160,
        "wires": [
            [
                "5d53dfe8ce6b1506"
            ]
        ]
    },
    {
        "id": "ae36e7eca5a9dd9e",
        "type": "function",
        "z": "606aeeb2baf6caa6",
        "g": "d6b6db502565868a",
        "name": "D250",
        "func": "// แปลงค่า (หาร 10 ตามสูตร PLC)\nmsg.payload = (msg.payload.D250 / 10);\n\n// --- กำหนดชื่อหัวข้อ (สำคัญมาก) ---\nmsg.topic = \"present_cycle\";\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 930,
        "y": 120,
        "wires": [
            [
                "1b94b87af272047f"
            ]
        ]
    },
    {
        "id": "5d53dfe8ce6b1506",
        "type": "function",
        "z": "606aeeb2baf6caa6",
        "g": "d6b6db502565868a",
        "name": "D251",
        "func": "// แปลงค่า\nmsg.payload = (msg.payload.D251 / 10);\n\n// --- กำหนดชื่อหัวข้อ ---\nmsg.topic = \"last_cycle\";\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 930,
        "y": 160,
        "wires": [
            [
                "1b94b87af272047f"
            ]
        ]
    },
    {
        "id": "27bc3f3a29d7abce",
        "type": "Ind MC Read",
        "z": "606aeeb2baf6caa6",
        "g": "d6b6db502565868a",
        "name": "CAVITY",
        "topic": "",
        "connection": "603efad4e9464db5",
        "address": "D432",
        "addressType": "str",
        "outputFormat": 0,
        "errorHandling": "throw",
        "outputs": 1,
        "x": 760,
        "y": 380,
        "wires": [
            [
                "e78c71770025b740"
            ]
        ]
    },
    {
        "id": "e78c71770025b740",
        "type": "function",
        "z": "606aeeb2baf6caa6",
        "g": "d6b6db502565868a",
        "name": "D432",
        "func": "msg.payload = (msg.payload.D432)\nmsg.topic = \"cavity\";\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 930,
        "y": 380,
        "wires": [
            [
                "1b94b87af272047f"
            ]
        ]
    },
    {
        "id": "337074fc13258ca5",
        "type": "Ind MC Read",
        "z": "606aeeb2baf6caa6",
        "g": "d6b6db502565868a",
        "name": "STD CYCLE ",
        "topic": "",
        "connection": "603efad4e9464db5",
        "address": "D433",
        "addressType": "str",
        "outputFormat": 0,
        "errorHandling": "throw",
        "outputs": 1,
        "x": 770,
        "y": 420,
        "wires": [
            [
                "668bf53d4dbaa9c9"
            ]
        ]
    },
    {
        "id": "668bf53d4dbaa9c9",
        "type": "function",
        "z": "606aeeb2baf6caa6",
        "g": "d6b6db502565868a",
        "name": "D433",
        "func": "msg.payload = (msg.payload.D433)\nmsg.topic = \"std_cycle\";\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 930,
        "y": 420,
        "wires": [
            [
                "1b94b87af272047f"
            ]
        ]
    },
    {
        "id": "9873fdcf593e139e",
        "type": "Ind MC Read",
        "z": "606aeeb2baf6caa6",
        "g": "d6b6db502565868a",
        "name": "status Mc on",
        "topic": "",
        "connection": "603efad4e9464db5",
        "address": "M200",
        "addressType": "str",
        "outputFormat": 0,
        "errorHandling": "throw",
        "outputs": 1,
        "x": 770,
        "y": 220,
        "wires": [
            [
                "3999f23797f10412"
            ]
        ]
    },
    {
        "id": "3999f23797f10412",
        "type": "function",
        "z": "606aeeb2baf6caa6",
        "g": "d6b6db502565868a",
        "name": "M200",
        "func": "msg.payload = (msg.payload.M200)\n\nmsg.topic = \"status_mc_on\";\n\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 930,
        "y": 220,
        "wires": [
            [
                "1b94b87af272047f"
            ]
        ]
    },
    {
        "id": "a1b996b635f46b78",
        "type": "group",
        "z": "606aeeb2baf6caa6",
        "g": "d6b6db502565868a",
        "name": "2. ส่วนประมวลผล & API (หัวใจหลัก)",
        "style": {
            "stroke": "#ffc000",
            "fill": "#fffdf0",
            "label": true
        },
        "nodes": [
            "1b94b87af272047f",
            "df7d6d18a2583ffa",
            "b59f491af3680035"
        ],
        "x": 1034,
        "y": 239,
        "w": 542,
        "h": 82
    },
    {
        "id": "1b94b87af272047f",
        "type": "join",
        "z": "606aeeb2baf6caa6",
        "g": "a1b996b635f46b78",
        "name": "รวมข้อมูล (Join)",
        "mode": "custom",
        "build": "object",
        "property": "payload",
        "propertyType": "msg",
        "key": "topic",
        "joiner": "\\n",
        "joinerType": "str",
        "useparts": false,
        "accumulate": false,
        "timeout": "15",
        "count": "7",
        "reduceRight": false,
        "reduceExp": "",
        "reduceInit": "",
        "reduceInitType": "",
        "reduceFixup": "",
        "x": 1150,
        "y": 280,
        "wires": [
            [
                "df7d6d18a2583ffa"
            ]
        ]
    },
    {
        "id": "df7d6d18a2583ffa",
        "type": "function",
        "z": "606aeeb2baf6caa6",
        "g": "a1b996b635f46b78",
        "name": "ตั้งค่า Data & Save Global",
        "func": "// 1. --- ตั้งค่า Config ---\nvar mySheetID = \"1RJ9OI8Bz8Xy_7HW7fZVQnjeYshDd0BZUZrkG3ycJfy0\"; // ใส่ ID Sheet\nvar machineID = 1;\nvar machineName = \"1200-1\"; // <--- ชื่อที่จะไปโชว์ใน Excel ช่อง B\n\n// รับข้อมูลรวมจาก Join\nvar data = msg.payload;\nvar now = new Date().toLocaleString(\"th-TH\", { timeZone: \"Asia/Bangkok\" });\n\n// 2. --- อัปเดตข้อมูลสำหรับ React (Global Variable) ---\n// ส่วนนี้สำหรับ Dashboard (ใช้ 1/0 เหมือนเดิมได้ ถ้า Dashboard ต้องการแบบนั้น)\nvar reactData = {\n    id: machineID,\n    name: machineName,\n    machine_no: machineName,\n    status: (data.status_mc_on == 1) ? 1 : 0, \n    present_cycle: parseFloat(data.present_cycle || 0),\n    last_cycle: parseFloat(data.last_cycle || 0),\n    std_cycle: parseFloat(data.std_cycle || 0),\n    model: data.model || \"-\", \n    cavity: parseFloat(data.cavity || 0),\n    total_pcs: parseFloat(data.total_pcs || 0),\n    timestamp: now\n};\n\n// เก็บลงตัวแปรกลาง (Global)\nvar allMachines = global.get(\"machineData\") || [];\nvar idx = allMachines.findIndex(m => m.id === machineID);\nif (idx !== -1) allMachines[idx] = Object.assign(allMachines[idx], reactData);\nelse allMachines.push(reactData);\nglobal.set(\"machineData\", allMachines);\n\n\n// 3. --- เตรียมข้อมูลส่ง Google Sheet ---\ndata.spreadsheetId = mySheetID;\ndata.timestamp = now;\ndata.machine_no = machineName;\n\n// >>> เพิ่มส่วนนี้ครับ: แปลงค่า status ให้เป็นคำว่า ON หรือ OFF <<<\n// ถ้าค่าเป็น 1 หรือ true ให้เป็น \"ON\" นอกนั้นให้เป็น \"OFF\" หมด\nif (data.status_mc_on == 1 || data.status_mc_on === true || data.status_mc_on === \"ON\") {\n    data.status_mc_on = \"ON\";\n} else {\n    data.status_mc_on = \"OFF\";\n}\n\nmsg.payload = data;\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1370,
        "y": 280,
        "wires": [
            [
                "b59f491af3680035"
            ]
        ]
    },
    {
        "id": "b59f491af3680035",
        "type": "link out",
        "z": "606aeeb2baf6caa6",
        "g": "a1b996b635f46b78",
        "name": "IN 1",
        "mode": "link",
        "links": [
            "54dd0d0df0b4968c"
        ],
        "x": 1535,
        "y": 280,
        "wires": []
    },
    {
        "id": "29968f3cced10bea",
        "type": "function",
        "z": "606aeeb2baf6caa6",
        "g": "d6b6db502565868a",
        "name": "Total Pcs.",
        "func": "// 1. ตรวจสอบก่อนว่าเป็น Array (รายการ) หรือไม่ เพื่อกัน Error\nif (!Array.isArray(msg.payload)) {\n    // ถ้าไม่ใช่ List รายการ ให้ข้ามไป\n    return null; \n}\n\n// 2. ค้นหาเครื่องจักรชื่อ \"1200/1\" (แก้ชื่อตรงนี้ได้ตามจริง)\nvar match = msg.payload.find(item => item.machine === \"1200/1\");\n\nif (match) {\n    // 3. ดึงค่าผลรวม Z มาใส่ payload\n    msg.payload = match.detail_z; \n\n    // 4. --- กำหนดชื่อหัวข้อ (สำคัญมาก) ---\n    // เพื่อให้ Join Node รู้ว่าค่านี่คือ \"detail_z\"\n    msg.topic = \"total_pcs\"; \n\n    return msg;\n}\n\n// ถ้าหาไม่เจอ ให้คืนค่า null\nreturn null;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 940,
        "y": 320,
        "wires": [
            [
                "1b94b87af272047f"
            ]
        ]
    },
    {
        "id": "f7eda85cc32730af",
        "type": "link in",
        "z": "606aeeb2baf6caa6",
        "g": "d6b6db502565868a",
        "name": "1200/1",
        "links": [
            "f5859804d4cb24fa"
        ],
        "x": 625,
        "y": 280,
        "wires": [
            [
                "e8ff5987d93523bc",
                "944c4685b6c28c96",
                "9873fdcf593e139e",
                "27bc3f3a29d7abce",
                "337074fc13258ca5"
            ]
        ]
    },
    {
        "id": "603efad4e9464db5",
        "type": "Ind MC Protocol Connection",
        "name": "1200-1",
        "host": "192.168.7.101",
        "port": "9000",
        "protocol": "TCP",
        "frame": "1E",
        "plcType": "Q",
        "ascii": false,
        "PLCStation": "",
        "PCStation": "",
        "PLCModuleNo": "",
        "network": "",
        "octalInputOutput": true,
        "timeout": 1000,
        "autoConnect": true
    },
    {
        "id": "97e2353b34d2ff35",
        "type": "group",
        "z": "606aeeb2baf6caa6",
        "g": "7351bc4077f8b06d",
        "style": {
            "stroke": "#999999",
            "stroke-opacity": "1",
            "fill": "none",
            "fill-opacity": "1",
            "label": true,
            "label-position": "nw",
            "color": "#a4a4a4"
        },
        "nodes": [
            "eda65fc4b2a4b764",
            "74fe37210aea0e17",
            "02f190641981aa33",
            "77f781058ea38e7c",
            "70c6bd1b9bb0e8af",
            "8ee79c468905e7c0",
            "bd83971315a227a2",
            "d928badc042a656f",
            "5c3d25a72e50836d",
            "976c3afdb0226e55",
            "44e8a032214c4bc7",
            "e2b734d38a046417",
            "4a5c3160e219c5f8",
            "f8a485787b8d0a25",
            "f27b1abebd4c1091",
            "c2f56b43725fde59",
            "6ffbb51332d52743"
        ],
        "x": 564,
        "y": 4239,
        "w": 1022,
        "h": 322
    },
    {
        "id": "eda65fc4b2a4b764",
        "type": "function",
        "z": "606aeeb2baf6caa6",
        "g": "97e2353b34d2ff35",
        "name": "function 200",
        "func": "\nvar match = msg.payload.find(item => item.machine === \"1300/3\");\n\nif (match) {\n    \n    msg.payload = match.detail_g; \n    return msg;\n}\nreturn null;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 890,
        "y": 4400,
        "wires": [
            [
                "976c3afdb0226e55"
            ]
        ]
    },
    {
        "id": "74fe37210aea0e17",
        "type": "function",
        "z": "606aeeb2baf6caa6",
        "g": "97e2353b34d2ff35",
        "name": "function 201",
        "func": "// ค้นหาเครื่องจักรชื่อ \"1300/13\" (หรือชื่อที่ปรากฏในตารางของคุณ)\nvar match = msg.payload.find(item => item.machine === \"1300/13\");\n\nif (match) {\n    // ดึงค่าผลรวม Z ที่บวกกันแล้วมาแสดง\n    msg.payload = match.detail_z; \n    return msg;\n}\nreturn null;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 890,
        "y": 4440,
        "wires": [
            [
                "976c3afdb0226e55"
            ]
        ]
    },
    {
        "id": "02f190641981aa33",
        "type": "comment",
        "z": "606aeeb2baf6caa6",
        "g": "97e2353b34d2ff35",
        "name": "1300/13",
        "info": "",
        "x": 1120,
        "y": 4480,
        "wires": []
    },
    {
        "id": "77f781058ea38e7c",
        "type": "Ind MC Read",
        "z": "606aeeb2baf6caa6",
        "g": "97e2353b34d2ff35",
        "name": "Present cycle",
        "topic": "",
        "connection": "192ad77b2825d492",
        "address": "D250",
        "addressType": "str",
        "outputFormat": 0,
        "errorHandling": "throw",
        "outputs": 1,
        "x": 760,
        "y": 4280,
        "wires": [
            [
                "4a5c3160e219c5f8"
            ]
        ]
    },
    {
        "id": "70c6bd1b9bb0e8af",
        "type": "Ind MC Read",
        "z": "606aeeb2baf6caa6",
        "g": "97e2353b34d2ff35",
        "name": "Last cycle",
        "topic": "",
        "connection": "192ad77b2825d492",
        "address": "D251",
        "addressType": "str",
        "outputFormat": 0,
        "errorHandling": "throw",
        "outputs": 1,
        "x": 740,
        "y": 4320,
        "wires": [
            [
                "f8a485787b8d0a25"
            ]
        ]
    },
    {
        "id": "8ee79c468905e7c0",
        "type": "Ind MC Read",
        "z": "606aeeb2baf6caa6",
        "g": "97e2353b34d2ff35",
        "name": "CAVITY",
        "topic": "",
        "connection": "192ad77b2825d492",
        "address": "D432",
        "addressType": "str",
        "outputFormat": 0,
        "errorHandling": "throw",
        "outputs": 1,
        "x": 740,
        "y": 4480,
        "wires": [
            [
                "c2f56b43725fde59"
            ]
        ]
    },
    {
        "id": "bd83971315a227a2",
        "type": "Ind MC Read",
        "z": "606aeeb2baf6caa6",
        "g": "97e2353b34d2ff35",
        "name": "STD CYCLE ",
        "topic": "",
        "connection": "192ad77b2825d492",
        "address": "D433",
        "addressType": "str",
        "outputFormat": 0,
        "errorHandling": "throw",
        "outputs": 1,
        "x": 750,
        "y": 4520,
        "wires": [
            [
                "6ffbb51332d52743"
            ]
        ]
    },
    {
        "id": "d928badc042a656f",
        "type": "Ind MC Read",
        "z": "606aeeb2baf6caa6",
        "g": "97e2353b34d2ff35",
        "name": "status Mc on",
        "topic": "",
        "connection": "192ad77b2825d492",
        "address": "M200",
        "addressType": "str",
        "outputFormat": 0,
        "errorHandling": "throw",
        "outputs": 1,
        "x": 750,
        "y": 4360,
        "wires": [
            [
                "f27b1abebd4c1091"
            ]
        ]
    },
    {
        "id": "5c3d25a72e50836d",
        "type": "link in",
        "z": "606aeeb2baf6caa6",
        "g": "97e2353b34d2ff35",
        "name": "1300/13",
        "links": [
            "425c5212a151b142"
        ],
        "x": 605,
        "y": 4420,
        "wires": [
            [
                "77f781058ea38e7c",
                "70c6bd1b9bb0e8af",
                "d928badc042a656f",
                "8ee79c468905e7c0",
                "bd83971315a227a2"
            ]
        ]
    },
    {
        "id": "976c3afdb0226e55",
        "type": "join",
        "z": "606aeeb2baf6caa6",
        "g": "97e2353b34d2ff35",
        "name": "รวมข้อมูล (Join)",
        "mode": "custom",
        "build": "object",
        "property": "payload",
        "propertyType": "msg",
        "key": "topic",
        "joiner": "\\n",
        "joinerType": "str",
        "useparts": false,
        "accumulate": false,
        "timeout": "15",
        "count": "7",
        "reduceRight": false,
        "reduceExp": "",
        "reduceInit": "",
        "reduceInitType": "",
        "reduceFixup": "",
        "x": 1130,
        "y": 4420,
        "wires": [
            [
                "44e8a032214c4bc7"
            ]
        ]
    },
    {
        "id": "44e8a032214c4bc7",
        "type": "function",
        "z": "606aeeb2baf6caa6",
        "g": "97e2353b34d2ff35",
        "name": "ตั้งค่า Data & Save Global",
        "func": "// 1. --- ตั้งค่า Config ---\nvar mySheetID = \"1RJ9OI8Bz8Xy_7HW7fZVQnjeYshDd0BZUZrkG3ycJfy0\"; // ใส่ ID Sheet\nvar machineID = 13;\nvar machineName = \"1300-13\"; // <--- ชื่อที่จะไปโชว์ใน Excel ช่อง B\n\n// รับข้อมูลรวมจาก Join\nvar data = msg.payload;\nvar now = new Date().toLocaleString(\"th-TH\", { timeZone: \"Asia/Bangkok\" });\n\n// 2. --- อัปเดตข้อมูลสำหรับ React (Global Variable) ---\n// ส่วนนี้สำหรับ Dashboard (ใช้ 1/0 เหมือนเดิมได้ ถ้า Dashboard ต้องการแบบนั้น)\nvar reactData = {\n    id: machineID,\n    name: machineName,\n    machine_no: machineName,\n    status: (data.status_mc_on == 1) ? 1 : 0, \n    present_cycle: parseFloat(data.present_cycle || 0),\n    last_cycle: parseFloat(data.last_cycle || 0),\n    std_cycle: parseFloat(data.std_cycle || 0),\n    model: data.model || \"-\", \n    cavity: parseFloat(data.cavity || 0),\n    total_pcs: parseFloat(data.total_pcs || 0),\n    timestamp: now\n};\n\n// เก็บลงตัวแปรกลาง (Global)\nvar allMachines = global.get(\"machineData\") || [];\nvar idx = allMachines.findIndex(m => m.id === machineID);\nif (idx !== -1) allMachines[idx] = Object.assign(allMachines[idx], reactData);\nelse allMachines.push(reactData);\nglobal.set(\"machineData\", allMachines);\n\n\n// 3. --- เตรียมข้อมูลส่ง Google Sheet ---\ndata.spreadsheetId = mySheetID;\ndata.timestamp = now;\ndata.machine_no = machineName;\n\n// >>> เพิ่มส่วนนี้ครับ: แปลงค่า status ให้เป็นคำว่า ON หรือ OFF <<<\n// ถ้าค่าเป็น 1 หรือ true ให้เป็น \"ON\" นอกนั้นให้เป็น \"OFF\" หมด\nif (data.status_mc_on == 1 || data.status_mc_on === true || data.status_mc_on === \"ON\") {\n    data.status_mc_on = \"ON\";\n} else {\n    data.status_mc_on = \"OFF\";\n}\n\nmsg.payload = data;\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1370,
        "y": 4420,
        "wires": [
            [
                "e2b734d38a046417"
            ]
        ]
    },
    {
        "id": "e2b734d38a046417",
        "type": "link out",
        "z": "606aeeb2baf6caa6",
        "g": "97e2353b34d2ff35",
        "name": "IN 13",
        "mode": "link",
        "links": [
            "147d89461f6414d0"
        ],
        "x": 1545,
        "y": 4420,
        "wires": []
    },
    {
        "id": "4a5c3160e219c5f8",
        "type": "function",
        "z": "606aeeb2baf6caa6",
        "g": "97e2353b34d2ff35",
        "name": "D250",
        "func": "// แปลงค่า (หาร 10 ตามสูตร PLC)\nmsg.payload = (msg.payload.D250 / 10);\n\n// --- กำหนดชื่อหัวข้อ (สำคัญมาก) ---\nmsg.topic = \"present_cycle\";\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 910,
        "y": 4280,
        "wires": [
            [
                "976c3afdb0226e55"
            ]
        ]
    },
    {
        "id": "f8a485787b8d0a25",
        "type": "function",
        "z": "606aeeb2baf6caa6",
        "g": "97e2353b34d2ff35",
        "name": "D251",
        "func": "// แปลงค่า\nmsg.payload = (msg.payload.D251 / 10);\n\n// --- กำหนดชื่อหัวข้อ ---\nmsg.topic = \"last_cycle\";\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 910,
        "y": 4320,
        "wires": [
            [
                "976c3afdb0226e55"
            ]
        ]
    },
    {
        "id": "f27b1abebd4c1091",
        "type": "function",
        "z": "606aeeb2baf6caa6",
        "g": "97e2353b34d2ff35",
        "name": "M200",
        "func": "msg.payload = (msg.payload.M200)\n\nmsg.topic = \"status_mc_on\";\n\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 910,
        "y": 4360,
        "wires": [
            [
                "976c3afdb0226e55"
            ]
        ]
    },
    {
        "id": "c2f56b43725fde59",
        "type": "function",
        "z": "606aeeb2baf6caa6",
        "g": "97e2353b34d2ff35",
        "name": "D432",
        "func": "msg.payload = (msg.payload.D432)\nmsg.topic = \"cavity\";\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 890,
        "y": 4480,
        "wires": [
            [
                "976c3afdb0226e55"
            ]
        ]
    },
    {
        "id": "6ffbb51332d52743",
        "type": "function",
        "z": "606aeeb2baf6caa6",
        "g": "97e2353b34d2ff35",
        "name": "D433",
        "func": "msg.payload = (msg.payload.D433)\nmsg.topic = \"std_cycle\";\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 890,
        "y": 4520,
        "wires": [
            [
                "976c3afdb0226e55"
            ]
        ]
    },
    {
        "id": "192ad77b2825d492",
        "type": "Ind MC Protocol Connection",
        "name": "1300-13",
        "host": "192.168.7.123",
        "port": "9010",
        "protocol": "TCP",
        "frame": "1E",
        "plcType": "Q",
        "ascii": false,
        "PLCStation": "",
        "PCStation": "",
        "PLCModuleNo": "",
        "network": "",
        "octalInputOutput": true,
        "timeout": 1000,
        "autoConnect": true
    },
    {
        "id": "400147b2a7c1bccf",
        "type": "comment",
        "z": "606aeeb2baf6caa6",
        "g": "7351bc4077f8b06d",
        "name": "ดึงข้อมูลจาก Google sheet",
        "info": "ดึงข้อมูลจาก Google sheet เพื่อที่จะดึงชื่อ Model เเละจำนวนชิ้นงานที่หน้างเครื่องลง",
        "x": 390,
        "y": 860,
        "wires": []
    },
    {
        "id": "e052d07866326de3",
        "type": "split",
        "z": "606aeeb2baf6caa6",
        "g": "7351bc4077f8b06d",
        "name": "",
        "splt": "\\n",
        "spltType": "str",
        "arraySplt": "13",
        "arraySpltType": "len",
        "stream": false,
        "addname": "",
        "property": "payload",
        "x": 450,
        "y": 1020,
        "wires": [
            [
                "ad07d3f9fb5d3c17",
                "3fc7ba46cb145dd8",
                "eda65fc4b2a4b764",
                "74fe37210aea0e17",
                "9426798f14a5b3cf",
                "29968f3cced10bea",
                "fe4908f269cee856",
                "d03d3b7889fe0c9f",
                "5e99453b14a3539e",
                "0626a1ac5db98171",
                "485305fcfcc73d24",
                "ecab42fd90638ea9",
                "d6268d0a3aa31cba",
                "a4478e81c39cc7f0",
                "0a79867b1aea321b",
                "2717cb86f88ba852",
                "d8358256594f739d",
                "269930edd8f9ce6b",
                "1b57715990419981",
                "3ca85b805ff3508f",
                "f88efebb4c3c6bcf",
                "b05f8935171f152b",
                "7cffd9d18736e03f",
                "d72d74e0b39d41b4",
                "b2b28ce13575146c"
            ]
        ]
    },
    {
        "id": "22143cf47a240b92",
        "type": "http request",
        "z": "606aeeb2baf6caa6",
        "g": "7351bc4077f8b06d",
        "name": "",
        "method": "GET",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "https://script.google.com/macros/s/AKfycbz03jpZ1n9f9ScVM1rBi_3Jm4_F9L3aq7jdEd9V2rI24ZNuCYZivgxxxlQe4pitjdYB/exec",
        "tls": "",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [],
        "x": 310,
        "y": 1020,
        "wires": [
            []
        ]
    },
    {
        "id": "f5859804d4cb24fa",
        "type": "link out",
        "z": "606aeeb2baf6caa6",
        "g": "7351bc4077f8b06d",
        "name": "1200/1",
        "mode": "link",
        "links": [
            "f7eda85cc32730af"
        ],
        "x": 265,
        "y": 960,
        "wires": []
    },
    {
        "id": "8b90af6fc5e86017",
        "type": "group",
        "z": "606aeeb2baf6caa6",
        "g": "7351bc4077f8b06d",
        "style": {
            "stroke": "#999999",
            "stroke-opacity": "1",
            "fill": "none",
            "fill-opacity": "1",
            "label": true,
            "label-position": "nw",
            "color": "#a4a4a4"
        },
        "nodes": [
            "ad07d3f9fb5d3c17",
            "3fc7ba46cb145dd8",
            "11b2f1d27569ed9d",
            "c10e232232b6cb9d",
            "b71bdbcd807fec92",
            "136666da3e9fb741",
            "1fe12390ea426270",
            "3f48d8dbeb255ab2",
            "5bef1bc0037aa857",
            "9ec881eb570ac56a",
            "ae5d1d1916d314da",
            "34bf6362ad37f85d",
            "4de08fd6a37bf9f8",
            "fa9798c994509896",
            "efd990358ef44ce2",
            "edda8766ab3a64d2",
            "e34c799b4b07deb8"
        ],
        "x": 574,
        "y": 839,
        "w": 1112,
        "h": 322
    },
    {
        "id": "ad07d3f9fb5d3c17",
        "type": "function",
        "z": "606aeeb2baf6caa6",
        "g": "8b90af6fc5e86017",
        "name": "Model",
        "func": "\nif (Array.isArray(msg.payload)) {\n    var match = msg.payload.find(item => item.machine === \"1300/3\");\n    if (match) {\n        msg.payload = match.detail_g; \n        msg.topic = \"model\"; \n        return msg;\n    }\n}\n\nreturn null;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 790,
        "y": 1000,
        "wires": [
            [
                "fa9798c994509896"
            ]
        ]
    },
    {
        "id": "3fc7ba46cb145dd8",
        "type": "function",
        "z": "606aeeb2baf6caa6",
        "g": "8b90af6fc5e86017",
        "name": "Total Pcs.",
        "func": "// 1. ตรวจสอบก่อนว่าเป็น Array (รายการ) หรือไม่ เพื่อกัน Error\nif (!Array.isArray(msg.payload)) {\n    // ถ้าไม่ใช่ List รายการ ให้ข้ามไป\n    return null; \n}\n\n// 2. ค้นหาเครื่องจักรชื่อ \"1200/1\" (แก้ชื่อตรงนี้ได้ตามจริง)\nvar match = msg.payload.find(item => item.machine === \"1300/3\");\n\nif (match) {\n    // 3. ดึงค่าผลรวม Z มาใส่ payload\n    msg.payload = match.detail_z; \n\n    // 4. --- กำหนดชื่อหัวข้อ (สำคัญมาก) ---\n    // เพื่อให้ Join Node รู้ว่าค่านี่คือ \"detail_z\"\n    msg.topic = \"total_pcs\"; \n\n    return msg;\n}\n\n// ถ้าหาไม่เจอ ให้คืนค่า null\nreturn null;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 800,
        "y": 1040,
        "wires": [
            [
                "fa9798c994509896"
            ]
        ]
    },
    {
        "id": "11b2f1d27569ed9d",
        "type": "comment",
        "z": "606aeeb2baf6caa6",
        "g": "8b90af6fc5e86017",
        "name": "3",
        "info": "",
        "x": 1050,
        "y": 900,
        "wires": []
    },
    {
        "id": "c10e232232b6cb9d",
        "type": "modbus-read",
        "z": "606aeeb2baf6caa6",
        "g": "8b90af6fc5e86017",
        "name": "40002",
        "topic": "",
        "showStatusActivities": false,
        "logIOActivities": false,
        "showErrors": false,
        "showWarnings": true,
        "unitid": "",
        "dataType": "HoldingRegister",
        "adr": "1",
        "quantity": "1",
        "rate": "1",
        "rateUnit": "s",
        "delayOnStart": false,
        "enableDeformedMessages": false,
        "startDelayTime": "",
        "server": "bce16dfadc25c0c6",
        "useIOFile": false,
        "ioFile": "",
        "useIOForPayload": false,
        "emptyMsgOnFail": false,
        "x": 690,
        "y": 880,
        "wires": [
            [],
            [
                "b71bdbcd807fec92"
            ]
        ]
    },
    {
        "id": "b71bdbcd807fec92",
        "type": "function",
        "z": "606aeeb2baf6caa6",
        "g": "8b90af6fc5e86017",
        "name": "Present cycle",
        "func": "// ดึงค่าจาก msg.payload.data[0]\nlet rawValue = msg.payload.data[0];\n\n// หาร 10 เพื่อแปลงเป็นค่าทศนิยม\nlet displayValue = rawValue / 10;\n\n// ใส่ค่าใน msg.payload สำหรับแสดงบน dashboard\nmsg.payload = displayValue;\n\nmsg.topic = \"present_cycle\";\n\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 820,
        "y": 880,
        "wires": [
            [
                "fa9798c994509896"
            ]
        ]
    },
    {
        "id": "136666da3e9fb741",
        "type": "modbus-read",
        "z": "606aeeb2baf6caa6",
        "g": "8b90af6fc5e86017",
        "name": "40003",
        "topic": "",
        "showStatusActivities": false,
        "logIOActivities": false,
        "showErrors": false,
        "showWarnings": true,
        "unitid": "",
        "dataType": "HoldingRegister",
        "adr": "2",
        "quantity": "1",
        "rate": "1",
        "rateUnit": "s",
        "delayOnStart": false,
        "enableDeformedMessages": false,
        "startDelayTime": "",
        "server": "bce16dfadc25c0c6",
        "useIOFile": false,
        "ioFile": "",
        "useIOForPayload": false,
        "emptyMsgOnFail": false,
        "x": 690,
        "y": 920,
        "wires": [
            [],
            [
                "1fe12390ea426270"
            ]
        ]
    },
    {
        "id": "1fe12390ea426270",
        "type": "function",
        "z": "606aeeb2baf6caa6",
        "g": "8b90af6fc5e86017",
        "name": "Last cycle",
        "func": "// ดึงค่าจาก msg.payload.data[0]\nlet rawValue = msg.payload.data[0];\n\n// หาร 10 เพื่อแปลงเป็นค่าทศนิยม\nlet displayValue = rawValue / 10;\n\n// ใส่ค่าใน msg.payload สำหรับแสดงบน dashboard\nmsg.payload = displayValue;\nmsg.topic = \"last_cycle\";\n\n\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 810,
        "y": 920,
        "wires": [
            [
                "fa9798c994509896"
            ]
        ]
    },
    {
        "id": "3f48d8dbeb255ab2",
        "type": "modbus-read",
        "z": "606aeeb2baf6caa6",
        "g": "8b90af6fc5e86017",
        "name": "40001",
        "topic": "",
        "showStatusActivities": false,
        "logIOActivities": false,
        "showErrors": false,
        "showWarnings": true,
        "unitid": "",
        "dataType": "HoldingRegister",
        "adr": "0",
        "quantity": "1",
        "rate": "1",
        "rateUnit": "s",
        "delayOnStart": false,
        "enableDeformedMessages": false,
        "startDelayTime": "",
        "server": "bce16dfadc25c0c6",
        "useIOFile": false,
        "ioFile": "",
        "useIOForPayload": false,
        "emptyMsgOnFail": false,
        "x": 690,
        "y": 960,
        "wires": [
            [],
            [
                "5bef1bc0037aa857"
            ]
        ]
    },
    {
        "id": "5bef1bc0037aa857",
        "type": "function",
        "z": "606aeeb2baf6caa6",
        "g": "8b90af6fc5e86017",
        "name": "status Mc on",
        "func": "let value = msg.payload.data[0];\n\nif (value === 1) {\n    msg.payload = \"ON\";\n} else if (value === 0) {\n    msg.payload = \"OFF\";\n} else {\n    msg.payload = \"Unknown\";  // กรณีที่ค่าไม่ใช่ 1 หรือ 0\n}\n msg.topic = \"status_mc_on\"; \nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 810,
        "y": 960,
        "wires": [
            [
                "fa9798c994509896"
            ]
        ]
    },
    {
        "id": "9ec881eb570ac56a",
        "type": "function",
        "z": "606aeeb2baf6caa6",
        "g": "8b90af6fc5e86017",
        "name": "CAVITY",
        "func": "// ดึงค่าจาก msg.payload.data[0]\nlet rawValue = msg.payload.data[0];\n\n// หาร 10 เพื่อแปลงเป็นค่าทศนิยม\nlet displayValue = rawValue ;\n\n// ใส่ค่าใน msg.payload สำหรับแสดงบน dashboard\nmsg.payload = displayValue;\nmsg.topic = \"cavity\";\n\n\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 780,
        "y": 1080,
        "wires": [
            [
                "fa9798c994509896"
            ]
        ]
    },
    {
        "id": "ae5d1d1916d314da",
        "type": "modbus-read",
        "z": "606aeeb2baf6caa6",
        "g": "8b90af6fc5e86017",
        "name": "40017",
        "topic": "",
        "showStatusActivities": false,
        "logIOActivities": false,
        "showErrors": false,
        "showWarnings": true,
        "unitid": "",
        "dataType": "HoldingRegister",
        "adr": "16",
        "quantity": "1",
        "rate": "1",
        "rateUnit": "s",
        "delayOnStart": false,
        "enableDeformedMessages": false,
        "startDelayTime": "",
        "server": "bce16dfadc25c0c6",
        "useIOFile": false,
        "ioFile": "",
        "useIOForPayload": false,
        "emptyMsgOnFail": false,
        "x": 670,
        "y": 1120,
        "wires": [
            [],
            [
                "34bf6362ad37f85d"
            ]
        ]
    },
    {
        "id": "34bf6362ad37f85d",
        "type": "function",
        "z": "606aeeb2baf6caa6",
        "g": "8b90af6fc5e86017",
        "name": "STD CYCLE ",
        "func": "// ดึงค่าจาก msg.payload.data[0]\nlet rawValue = msg.payload.data[0];\n\n// หาร 10 เพื่อแปลงเป็นค่าทศนิยม\nlet displayValue = rawValue ;\n\n// ใส่ค่าใน msg.payload สำหรับแสดงบน dashboard\nmsg.payload = displayValue;\nmsg.topic = \"std_cycle\";\n\n\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 790,
        "y": 1120,
        "wires": [
            [
                "fa9798c994509896"
            ]
        ]
    },
    {
        "id": "4de08fd6a37bf9f8",
        "type": "modbus-read",
        "z": "606aeeb2baf6caa6",
        "g": "8b90af6fc5e86017",
        "name": "40016",
        "topic": "",
        "showStatusActivities": false,
        "logIOActivities": false,
        "showErrors": false,
        "showWarnings": true,
        "unitid": "",
        "dataType": "HoldingRegister",
        "adr": "15",
        "quantity": "1",
        "rate": "1",
        "rateUnit": "s",
        "delayOnStart": false,
        "enableDeformedMessages": false,
        "startDelayTime": "",
        "server": "bce16dfadc25c0c6",
        "useIOFile": false,
        "ioFile": "",
        "useIOForPayload": false,
        "emptyMsgOnFail": false,
        "x": 670,
        "y": 1080,
        "wires": [
            [],
            [
                "9ec881eb570ac56a"
            ]
        ]
    },
    {
        "id": "fa9798c994509896",
        "type": "join",
        "z": "606aeeb2baf6caa6",
        "g": "8b90af6fc5e86017",
        "name": "รวมข้อมูล (Join)",
        "mode": "custom",
        "build": "object",
        "property": "payload",
        "propertyType": "msg",
        "key": "topic",
        "joiner": "\\n",
        "joinerType": "str",
        "useparts": true,
        "accumulate": true,
        "timeout": "15",
        "count": "7",
        "reduceRight": false,
        "reduceExp": "",
        "reduceInit": "",
        "reduceInitType": "",
        "reduceFixup": "",
        "x": 1070,
        "y": 1000,
        "wires": [
            [
                "efd990358ef44ce2"
            ]
        ]
    },
    {
        "id": "efd990358ef44ce2",
        "type": "function",
        "z": "606aeeb2baf6caa6",
        "g": "8b90af6fc5e86017",
        "name": "เช็คความครบ",
        "func": "// รายชื่อหัวข้อข้อมูลที่ต้องมีให้ครบ 7 ตัว\nvar requiredKeys = [\n    \"present_cycle\", \n    \"last_cycle\", \n    \"cavity\", \n    \"std_cycle\", \n    \"status_mc_on\", \n    \"model\", \n    \"total_pcs\"\n];\n\n// ดึงคีย์ที่มีอยู่ใน msg.payload ตอนนี้\nvar currentKeys = Object.keys(msg.payload);\n\n// เช็คว่าขาดตัวไหนไปบ้าง\nvar missing = requiredKeys.filter(function(key) {\n    return !currentKeys.includes(key);\n});\n\n// ถ้ามีตัวที่ขาด (missing > 0)\nif (missing.length > 0) {\n    // บันทึก Log ว่าขาดอะไร (ดูใน Debug)\n    node.warn(\"ข้อมูลไม่ครบ! ขาด: \" + missing.join(\", \"));\n    return null; // *** หยุดการส่งข้อมูลทันที ไม่ไปต่อ ***\n}\n\n// ถ้าครบถ้วน ให้ไปต่อ\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1270,
        "y": 1000,
        "wires": [
            [
                "edda8766ab3a64d2"
            ]
        ]
    },
    {
        "id": "edda8766ab3a64d2",
        "type": "function",
        "z": "606aeeb2baf6caa6",
        "g": "8b90af6fc5e86017",
        "name": "ตั้งค่า Data & Save Global V2",
        "func": "// 1. --- ตั้งค่า Config ---\nvar mySheetID = \"1RJ9OI8Bz8Xy_7HW7fZVQnjeYshDd0BZUZrkG3ycJfy0\"; // ใส่ ID Sheet\nvar machineID = 3;\nvar machineName = \"1300-3\"; // <--- ชื่อที่จะไปโชว์ใน Excel ช่อง B\n\n// รับข้อมูลรวมจาก Join\nvar data = msg.payload;\nvar now = new Date().toLocaleString(\"th-TH\", { timeZone: \"Asia/Bangkok\" });\n\n// 2. --- อัปเดตข้อมูลสำหรับ React (Global Variable) ---\nvar reactData = {\n    id: machineID,\n    name: machineName,\n    machine_no: machineName,\n    status: (data.status_mc_on == 1) ? 1 : 0,\n    present_cycle: parseFloat(data.present_cycle || 0),\n    last_cycle: parseFloat(data.last_cycle || 0),\n    std_cycle: parseFloat(data.std_cycle || 0),\n    \n    // *** แก้ตรงนี้ด้วยนิดนึงครับ ***\n    // Model มักเป็นตัวหนังสือ (เช่น HC00443E) ห้ามใช้ parseFloat ไม่งั้นค่าจะเพี้ยนเป็น NaN หรือ 0\n    model: data.model || \"-\", \n    \n    cavity: parseFloat(data.cavity || 0),\n    total_pcs: parseFloat(data.total_pcs || 0),\n    timestamp: now\n};\n\n// เก็บลงตัวแปรกลาง\nvar allMachines = global.get(\"machineData\") || [];\nvar idx = allMachines.findIndex(m => m.id === machineID);\nif (idx !== -1) allMachines[idx] = Object.assign(allMachines[idx], reactData);\nelse allMachines.push(reactData);\nglobal.set(\"machineData\", allMachines);\n\n// 3. --- เตรียมข้อมูลส่ง Google Sheet ---\ndata.spreadsheetId = mySheetID;\ndata.timestamp = now;\n\n// >>> เติมบรรทัดนี้ครับ เพื่อให้ Google Sheet รู้จักชื่อเครื่อง <<<\ndata.machine_no = machineName; \n\nmsg.payload = data;\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1480,
        "y": 1000,
        "wires": [
            [
                "e34c799b4b07deb8"
            ]
        ]
    },
    {
        "id": "e34c799b4b07deb8",
        "type": "link out",
        "z": "606aeeb2baf6caa6",
        "g": "8b90af6fc5e86017",
        "name": "IN 3",
        "mode": "link",
        "links": [
            "3a682ac01f47ea82"
        ],
        "x": 1645,
        "y": 1000,
        "wires": []
    },
    {
        "id": "bce16dfadc25c0c6",
        "type": "modbus-client",
        "name": "1300-3",
        "clienttype": "tcp",
        "bufferCommands": true,
        "stateLogEnabled": false,
        "queueLogEnabled": false,
        "failureLogEnabled": true,
        "tcpHost": "192.168.7.126",
        "tcpPort": 502,
        "tcpType": "DEFAULT",
        "serialPort": "/dev/ttyUSB",
        "serialType": "RTU-BUFFERD",
        "serialBaudrate": 9600,
        "serialDatabits": 8,
        "serialStopbits": 1,
        "serialParity": "none",
        "serialConnectionDelay": 100,
        "serialAsciiResponseStartDelimiter": "0x3A",
        "unit_id": 1,
        "commandDelay": 1,
        "clientTimeout": 1000,
        "reconnectOnTimeout": true,
        "reconnectTimeout": 2000,
        "parallelUnitIdsAllowed": true,
        "showErrors": false,
        "showWarnings": true,
        "showLogs": true
    },
    {
        "id": "425c5212a151b142",
        "type": "link out",
        "z": "606aeeb2baf6caa6",
        "g": "7351bc4077f8b06d",
        "name": "1300/13",
        "mode": "link",
        "links": [
            "5c3d25a72e50836d"
        ],
        "x": 265,
        "y": 1100,
        "wires": []
    },
    {
        "id": "e7d7ca38660b595b",
        "type": "group",
        "z": "606aeeb2baf6caa6",
        "g": "7351bc4077f8b06d",
        "style": {
            "stroke": "#999999",
            "stroke-opacity": "1",
            "fill": "none",
            "fill-opacity": "1",
            "label": true,
            "label-position": "nw",
            "color": "#a4a4a4"
        },
        "nodes": [
            "5e99453b14a3539e",
            "0626a1ac5db98171",
            "59875a3d34cacc86",
            "e5f0edc504ea664e",
            "2ff5d2678fa7c3a7",
            "67364213ebca0729",
            "30fc6f3a33d7ae5b",
            "17054ad4872c3047",
            "98b682cb60daf9af",
            "21d8afab9892f076",
            "1c285aa4ce150f19",
            "b479a5bc13be70e7",
            "994b305a798ceceb",
            "a5bb504af7b224cf",
            "ae9d155e4edceff0",
            "cd67ea950fefbb4b",
            "8b9c091eb4bf58a2"
        ],
        "x": 574,
        "y": 1179,
        "w": 1112,
        "h": 322
    },
    {
        "id": "5e99453b14a3539e",
        "type": "function",
        "z": "606aeeb2baf6caa6",
        "g": "e7d7ca38660b595b",
        "name": "Model",
        "func": "\nif (Array.isArray(msg.payload)) {\n    var match = msg.payload.find(item => item.machine === \"1300/3\");\n    if (match) {\n        msg.payload = match.detail_g; \n        msg.topic = \"model\"; \n        return msg;\n    }\n}\n\nreturn null;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 770,
        "y": 1340,
        "wires": [
            [
                "a5bb504af7b224cf"
            ]
        ]
    },
    {
        "id": "0626a1ac5db98171",
        "type": "function",
        "z": "606aeeb2baf6caa6",
        "g": "e7d7ca38660b595b",
        "name": "Total Pcs.",
        "func": "// 1. ตรวจสอบก่อนว่าเป็น Array (รายการ) หรือไม่ เพื่อกัน Error\nif (!Array.isArray(msg.payload)) {\n    // ถ้าไม่ใช่ List รายการ ให้ข้ามไป\n    return null; \n}\n\n// 2. ค้นหาเครื่องจักรชื่อ \"1200/1\" (แก้ชื่อตรงนี้ได้ตามจริง)\nvar match = msg.payload.find(item => item.machine === \"1300/3\");\n\nif (match) {\n    // 3. ดึงค่าผลรวม Z มาใส่ payload\n    msg.payload = match.detail_z; \n\n    // 4. --- กำหนดชื่อหัวข้อ (สำคัญมาก) ---\n    // เพื่อให้ Join Node รู้ว่าค่านี่คือ \"detail_z\"\n    msg.topic = \"total_pcs\"; \n\n    return msg;\n}\n\n// ถ้าหาไม่เจอ ให้คืนค่า null\nreturn null;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 780,
        "y": 1380,
        "wires": [
            [
                "a5bb504af7b224cf"
            ]
        ]
    },
    {
        "id": "59875a3d34cacc86",
        "type": "comment",
        "z": "606aeeb2baf6caa6",
        "g": "e7d7ca38660b595b",
        "name": "4",
        "info": "",
        "x": 1030,
        "y": 1240,
        "wires": []
    },
    {
        "id": "e5f0edc504ea664e",
        "type": "modbus-read",
        "z": "606aeeb2baf6caa6",
        "g": "e7d7ca38660b595b",
        "name": "40002",
        "topic": "",
        "showStatusActivities": false,
        "logIOActivities": false,
        "showErrors": false,
        "showWarnings": true,
        "unitid": "",
        "dataType": "HoldingRegister",
        "adr": "1",
        "quantity": "1",
        "rate": "1",
        "rateUnit": "s",
        "delayOnStart": false,
        "enableDeformedMessages": false,
        "startDelayTime": "",
        "server": "45c6635a475b7b7e",
        "useIOFile": false,
        "ioFile": "",
        "useIOForPayload": false,
        "emptyMsgOnFail": false,
        "x": 670,
        "y": 1220,
        "wires": [
            [],
            [
                "2ff5d2678fa7c3a7"
            ]
        ]
    },
    {
        "id": "2ff5d2678fa7c3a7",
        "type": "function",
        "z": "606aeeb2baf6caa6",
        "g": "e7d7ca38660b595b",
        "name": "Present cycle",
        "func": "// ดึงค่าจาก msg.payload.data[0]\nlet rawValue = msg.payload.data[0];\n\n// หาร 10 เพื่อแปลงเป็นค่าทศนิยม\nlet displayValue = rawValue / 10;\n\n// ใส่ค่าใน msg.payload สำหรับแสดงบน dashboard\nmsg.payload = displayValue;\n\nmsg.topic = \"present_cycle\";\n\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 800,
        "y": 1220,
        "wires": [
            [
                "a5bb504af7b224cf"
            ]
        ]
    },
    {
        "id": "67364213ebca0729",
        "type": "modbus-read",
        "z": "606aeeb2baf6caa6",
        "g": "e7d7ca38660b595b",
        "name": "40003",
        "topic": "",
        "showStatusActivities": false,
        "logIOActivities": false,
        "showErrors": false,
        "showWarnings": true,
        "unitid": "",
        "dataType": "HoldingRegister",
        "adr": "2",
        "quantity": "1",
        "rate": "1",
        "rateUnit": "s",
        "delayOnStart": false,
        "enableDeformedMessages": false,
        "startDelayTime": "",
        "server": "45c6635a475b7b7e",
        "useIOFile": false,
        "ioFile": "",
        "useIOForPayload": false,
        "emptyMsgOnFail": false,
        "x": 670,
        "y": 1260,
        "wires": [
            [],
            [
                "30fc6f3a33d7ae5b"
            ]
        ]
    },
    {
        "id": "30fc6f3a33d7ae5b",
        "type": "function",
        "z": "606aeeb2baf6caa6",
        "g": "e7d7ca38660b595b",
        "name": "Last cycle",
        "func": "// ดึงค่าจาก msg.payload.data[0]\nlet rawValue = msg.payload.data[0];\n\n// หาร 10 เพื่อแปลงเป็นค่าทศนิยม\nlet displayValue = rawValue / 10;\n\n// ใส่ค่าใน msg.payload สำหรับแสดงบน dashboard\nmsg.payload = displayValue;\nmsg.topic = \"last_cycle\";\n\n\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 790,
        "y": 1260,
        "wires": [
            [
                "a5bb504af7b224cf"
            ]
        ]
    },
    {
        "id": "17054ad4872c3047",
        "type": "modbus-read",
        "z": "606aeeb2baf6caa6",
        "g": "e7d7ca38660b595b",
        "name": "40001",
        "topic": "",
        "showStatusActivities": false,
        "logIOActivities": false,
        "showErrors": false,
        "showWarnings": true,
        "unitid": "",
        "dataType": "HoldingRegister",
        "adr": "0",
        "quantity": "1",
        "rate": "1",
        "rateUnit": "s",
        "delayOnStart": false,
        "enableDeformedMessages": false,
        "startDelayTime": "",
        "server": "45c6635a475b7b7e",
        "useIOFile": false,
        "ioFile": "",
        "useIOForPayload": false,
        "emptyMsgOnFail": false,
        "x": 670,
        "y": 1300,
        "wires": [
            [],
            [
                "98b682cb60daf9af"
            ]
        ]
    },
    {
        "id": "98b682cb60daf9af",
        "type": "function",
        "z": "606aeeb2baf6caa6",
        "g": "e7d7ca38660b595b",
        "name": "status Mc on",
        "func": "let value = msg.payload.data[0];\n\nif (value === 1) {\n    msg.payload = \"ON\";\n} else if (value === 0) {\n    msg.payload = \"OFF\";\n} else {\n    msg.payload = \"Unknown\";  // กรณีที่ค่าไม่ใช่ 1 หรือ 0\n}\n msg.topic = \"status_mc_on\"; \nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 790,
        "y": 1300,
        "wires": [
            [
                "a5bb504af7b224cf"
            ]
        ]
    },
    {
        "id": "21d8afab9892f076",
        "type": "function",
        "z": "606aeeb2baf6caa6",
        "g": "e7d7ca38660b595b",
        "name": "CAVITY",
        "func": "// ดึงค่าจาก msg.payload.data[0]\nlet rawValue = msg.payload.data[0];\n\n// หาร 10 เพื่อแปลงเป็นค่าทศนิยม\nlet displayValue = rawValue ;\n\n// ใส่ค่าใน msg.payload สำหรับแสดงบน dashboard\nmsg.payload = displayValue;\nmsg.topic = \"cavity\";\n\n\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 780,
        "y": 1420,
        "wires": [
            [
                "a5bb504af7b224cf"
            ]
        ]
    },
    {
        "id": "1c285aa4ce150f19",
        "type": "modbus-read",
        "z": "606aeeb2baf6caa6",
        "g": "e7d7ca38660b595b",
        "name": "40017",
        "topic": "",
        "showStatusActivities": false,
        "logIOActivities": false,
        "showErrors": false,
        "showWarnings": true,
        "unitid": "",
        "dataType": "HoldingRegister",
        "adr": "16",
        "quantity": "1",
        "rate": "1",
        "rateUnit": "s",
        "delayOnStart": false,
        "enableDeformedMessages": false,
        "startDelayTime": "",
        "server": "45c6635a475b7b7e",
        "useIOFile": false,
        "ioFile": "",
        "useIOForPayload": false,
        "emptyMsgOnFail": false,
        "x": 670,
        "y": 1460,
        "wires": [
            [],
            [
                "b479a5bc13be70e7"
            ]
        ]
    },
    {
        "id": "b479a5bc13be70e7",
        "type": "function",
        "z": "606aeeb2baf6caa6",
        "g": "e7d7ca38660b595b",
        "name": "STD CYCLE ",
        "func": "// ดึงค่าจาก msg.payload.data[0]\nlet rawValue = msg.payload.data[0];\n\n// หาร 10 เพื่อแปลงเป็นค่าทศนิยม\nlet displayValue = rawValue ;\n\n// ใส่ค่าใน msg.payload สำหรับแสดงบน dashboard\nmsg.payload = displayValue;\nmsg.topic = \"std_cycle\";\n\n\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 790,
        "y": 1460,
        "wires": [
            [
                "a5bb504af7b224cf"
            ]
        ]
    },
    {
        "id": "994b305a798ceceb",
        "type": "modbus-read",
        "z": "606aeeb2baf6caa6",
        "g": "e7d7ca38660b595b",
        "name": "40016",
        "topic": "",
        "showStatusActivities": false,
        "logIOActivities": false,
        "showErrors": false,
        "showWarnings": true,
        "unitid": "",
        "dataType": "HoldingRegister",
        "adr": "15",
        "quantity": "1",
        "rate": "1",
        "rateUnit": "s",
        "delayOnStart": false,
        "enableDeformedMessages": false,
        "startDelayTime": "",
        "server": "45c6635a475b7b7e",
        "useIOFile": false,
        "ioFile": "",
        "useIOForPayload": false,
        "emptyMsgOnFail": false,
        "x": 670,
        "y": 1420,
        "wires": [
            [],
            [
                "21d8afab9892f076"
            ]
        ]
    },
    {
        "id": "a5bb504af7b224cf",
        "type": "join",
        "z": "606aeeb2baf6caa6",
        "g": "e7d7ca38660b595b",
        "name": "รวมข้อมูล (Join)",
        "mode": "custom",
        "build": "object",
        "property": "payload",
        "propertyType": "msg",
        "key": "topic",
        "joiner": "\\n",
        "joinerType": "str",
        "useparts": true,
        "accumulate": true,
        "timeout": "15",
        "count": "7",
        "reduceRight": false,
        "reduceExp": "",
        "reduceInit": "",
        "reduceInitType": "",
        "reduceFixup": "",
        "x": 1030,
        "y": 1340,
        "wires": [
            [
                "ae9d155e4edceff0"
            ]
        ]
    },
    {
        "id": "ae9d155e4edceff0",
        "type": "function",
        "z": "606aeeb2baf6caa6",
        "g": "e7d7ca38660b595b",
        "name": "เช็คความครบ",
        "func": "// รายชื่อหัวข้อข้อมูลที่ต้องมีให้ครบ 7 ตัว\nvar requiredKeys = [\n    \"present_cycle\", \n    \"last_cycle\", \n    \"cavity\", \n    \"std_cycle\", \n    \"status_mc_on\", \n    \"model\", \n    \"total_pcs\"\n];\n\n// ดึงคีย์ที่มีอยู่ใน msg.payload ตอนนี้\nvar currentKeys = Object.keys(msg.payload);\n\n// เช็คว่าขาดตัวไหนไปบ้าง\nvar missing = requiredKeys.filter(function(key) {\n    return !currentKeys.includes(key);\n});\n\n// ถ้ามีตัวที่ขาด (missing > 0)\nif (missing.length > 0) {\n    // บันทึก Log ว่าขาดอะไร (ดูใน Debug)\n    node.warn(\"ข้อมูลไม่ครบ! ขาด: \" + missing.join(\", \"));\n    return null; // *** หยุดการส่งข้อมูลทันที ไม่ไปต่อ ***\n}\n\n// ถ้าครบถ้วน ให้ไปต่อ\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1250,
        "y": 1340,
        "wires": [
            [
                "cd67ea950fefbb4b"
            ]
        ]
    },
    {
        "id": "cd67ea950fefbb4b",
        "type": "function",
        "z": "606aeeb2baf6caa6",
        "g": "e7d7ca38660b595b",
        "name": "ตั้งค่า Data & Save Global V2",
        "func": "// 1. --- ตั้งค่า Config ---\nvar mySheetID = \"1RJ9OI8Bz8Xy_7HW7fZVQnjeYshDd0BZUZrkG3ycJfy0\"; // ใส่ ID Sheet\nvar machineID = 4;\nvar machineName = \"1300-4\"; // <--- ชื่อที่จะไปโชว์ใน Excel ช่อง B\n\n// รับข้อมูลรวมจาก Join\nvar data = msg.payload;\nvar now = new Date().toLocaleString(\"th-TH\", { timeZone: \"Asia/Bangkok\" });\n\n// 2. --- อัปเดตข้อมูลสำหรับ React (Global Variable) ---\nvar reactData = {\n    id: machineID,\n    name: machineName,\n    machine_no: machineName,\n    status: (data.status_mc_on == 1) ? 1 : 0,\n    present_cycle: parseFloat(data.present_cycle || 0),\n    last_cycle: parseFloat(data.last_cycle || 0),\n    std_cycle: parseFloat(data.std_cycle || 0),\n    \n    // *** แก้ตรงนี้ด้วยนิดนึงครับ ***\n    // Model มักเป็นตัวหนังสือ (เช่น HC00443E) ห้ามใช้ parseFloat ไม่งั้นค่าจะเพี้ยนเป็น NaN หรือ 0\n    model: data.model || \"-\", \n    \n    cavity: parseFloat(data.cavity || 0),\n    total_pcs: parseFloat(data.total_pcs || 0),\n    timestamp: now\n};\n\n// เก็บลงตัวแปรกลาง\nvar allMachines = global.get(\"machineData\") || [];\nvar idx = allMachines.findIndex(m => m.id === machineID);\nif (idx !== -1) allMachines[idx] = Object.assign(allMachines[idx], reactData);\nelse allMachines.push(reactData);\nglobal.set(\"machineData\", allMachines);\n\n// 3. --- เตรียมข้อมูลส่ง Google Sheet ---\ndata.spreadsheetId = mySheetID;\ndata.timestamp = now;\n\n// >>> เติมบรรทัดนี้ครับ เพื่อให้ Google Sheet รู้จักชื่อเครื่อง <<<\ndata.machine_no = machineName; \n\nmsg.payload = data;\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1480,
        "y": 1340,
        "wires": [
            [
                "8b9c091eb4bf58a2"
            ]
        ]
    },
    {
        "id": "8b9c091eb4bf58a2",
        "type": "link out",
        "z": "606aeeb2baf6caa6",
        "g": "e7d7ca38660b595b",
        "name": "IN 4",
        "mode": "link",
        "links": [
            "5396a9baa56ce2ee"
        ],
        "x": 1645,
        "y": 1340,
        "wires": []
    },
    {
        "id": "45c6635a475b7b7e",
        "type": "modbus-client",
        "name": "1300-4",
        "clienttype": "tcp",
        "bufferCommands": true,
        "stateLogEnabled": false,
        "queueLogEnabled": false,
        "failureLogEnabled": true,
        "tcpHost": "192.168.7.127",
        "tcpPort": 502,
        "tcpType": "DEFAULT",
        "serialPort": "/dev/ttyUSB",
        "serialType": "RTU-BUFFERD",
        "serialBaudrate": 9600,
        "serialDatabits": 8,
        "serialStopbits": 1,
        "serialParity": "none",
        "serialConnectionDelay": 100,
        "serialAsciiResponseStartDelimiter": "0x3A",
        "unit_id": 4,
        "commandDelay": 1,
        "clientTimeout": 1000,
        "reconnectOnTimeout": true,
        "reconnectTimeout": 2000,
        "parallelUnitIdsAllowed": true,
        "showErrors": false,
        "showWarnings": true,
        "showLogs": true
    },
    {
        "id": "3f0fdcf240a11d38",
        "type": "group",
        "z": "606aeeb2baf6caa6",
        "g": "7351bc4077f8b06d",
        "style": {
            "stroke": "#999999",
            "stroke-opacity": "1",
            "fill": "none",
            "fill-opacity": "1",
            "label": true,
            "label-position": "nw",
            "color": "#a4a4a4"
        },
        "nodes": [
            "485305fcfcc73d24",
            "ecab42fd90638ea9",
            "ee826c9c230ad653",
            "b62fd3a24cda4ce8",
            "565e14c5167f7cdb",
            "db96e47abc60562a",
            "c85a3b33190986e2",
            "f24e149bc993640d",
            "8e5b8ccbc6013897",
            "18389047e323bb23",
            "3027e70a80141271",
            "1a50fe3535d53761",
            "2db540491c6b5523",
            "1953fcd32a5810a0",
            "909ab4a852ba2345",
            "92ba15e001906e55",
            "0722e294ab5a22d4"
        ],
        "x": 574,
        "y": 1519,
        "w": 1112,
        "h": 322
    },
    {
        "id": "485305fcfcc73d24",
        "type": "function",
        "z": "606aeeb2baf6caa6",
        "g": "3f0fdcf240a11d38",
        "name": "Model",
        "func": "\nif (Array.isArray(msg.payload)) {\n    var match = msg.payload.find(item => item.machine === \"1300/3\");\n    if (match) {\n        msg.payload = match.detail_g; \n        msg.topic = \"model\"; \n        return msg;\n    }\n}\n\nreturn null;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 770,
        "y": 1680,
        "wires": [
            [
                "1953fcd32a5810a0"
            ]
        ]
    },
    {
        "id": "ecab42fd90638ea9",
        "type": "function",
        "z": "606aeeb2baf6caa6",
        "g": "3f0fdcf240a11d38",
        "name": "Total Pcs.",
        "func": "// 1. ตรวจสอบก่อนว่าเป็น Array (รายการ) หรือไม่ เพื่อกัน Error\nif (!Array.isArray(msg.payload)) {\n    // ถ้าไม่ใช่ List รายการ ให้ข้ามไป\n    return null; \n}\n\n// 2. ค้นหาเครื่องจักรชื่อ \"1200/1\" (แก้ชื่อตรงนี้ได้ตามจริง)\nvar match = msg.payload.find(item => item.machine === \"1300/3\");\n\nif (match) {\n    // 3. ดึงค่าผลรวม Z มาใส่ payload\n    msg.payload = match.detail_z; \n\n    // 4. --- กำหนดชื่อหัวข้อ (สำคัญมาก) ---\n    // เพื่อให้ Join Node รู้ว่าค่านี่คือ \"detail_z\"\n    msg.topic = \"total_pcs\"; \n\n    return msg;\n}\n\n// ถ้าหาไม่เจอ ให้คืนค่า null\nreturn null;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 780,
        "y": 1720,
        "wires": [
            [
                "1953fcd32a5810a0"
            ]
        ]
    },
    {
        "id": "ee826c9c230ad653",
        "type": "comment",
        "z": "606aeeb2baf6caa6",
        "g": "3f0fdcf240a11d38",
        "name": "5",
        "info": "",
        "x": 1030,
        "y": 1580,
        "wires": []
    },
    {
        "id": "b62fd3a24cda4ce8",
        "type": "modbus-read",
        "z": "606aeeb2baf6caa6",
        "g": "3f0fdcf240a11d38",
        "name": "40002",
        "topic": "",
        "showStatusActivities": false,
        "logIOActivities": false,
        "showErrors": false,
        "showWarnings": true,
        "unitid": "",
        "dataType": "HoldingRegister",
        "adr": "1",
        "quantity": "1",
        "rate": "1",
        "rateUnit": "s",
        "delayOnStart": false,
        "enableDeformedMessages": false,
        "startDelayTime": "",
        "server": "fbd0b95b24a274df",
        "useIOFile": false,
        "ioFile": "",
        "useIOForPayload": false,
        "emptyMsgOnFail": false,
        "x": 670,
        "y": 1560,
        "wires": [
            [],
            [
                "565e14c5167f7cdb"
            ]
        ]
    },
    {
        "id": "565e14c5167f7cdb",
        "type": "function",
        "z": "606aeeb2baf6caa6",
        "g": "3f0fdcf240a11d38",
        "name": "Present cycle",
        "func": "// ดึงค่าจาก msg.payload.data[0]\nlet rawValue = msg.payload.data[0];\n\n// หาร 10 เพื่อแปลงเป็นค่าทศนิยม\nlet displayValue = rawValue / 10;\n\n// ใส่ค่าใน msg.payload สำหรับแสดงบน dashboard\nmsg.payload = displayValue;\n\nmsg.topic = \"present_cycle\";\n\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 800,
        "y": 1560,
        "wires": [
            [
                "1953fcd32a5810a0"
            ]
        ]
    },
    {
        "id": "db96e47abc60562a",
        "type": "modbus-read",
        "z": "606aeeb2baf6caa6",
        "g": "3f0fdcf240a11d38",
        "name": "40003",
        "topic": "",
        "showStatusActivities": false,
        "logIOActivities": false,
        "showErrors": false,
        "showWarnings": true,
        "unitid": "",
        "dataType": "HoldingRegister",
        "adr": "2",
        "quantity": "1",
        "rate": "1",
        "rateUnit": "s",
        "delayOnStart": false,
        "enableDeformedMessages": false,
        "startDelayTime": "",
        "server": "fbd0b95b24a274df",
        "useIOFile": false,
        "ioFile": "",
        "useIOForPayload": false,
        "emptyMsgOnFail": false,
        "x": 670,
        "y": 1600,
        "wires": [
            [],
            [
                "c85a3b33190986e2"
            ]
        ]
    },
    {
        "id": "c85a3b33190986e2",
        "type": "function",
        "z": "606aeeb2baf6caa6",
        "g": "3f0fdcf240a11d38",
        "name": "Last cycle",
        "func": "// ดึงค่าจาก msg.payload.data[0]\nlet rawValue = msg.payload.data[0];\n\n// หาร 10 เพื่อแปลงเป็นค่าทศนิยม\nlet displayValue = rawValue / 10;\n\n// ใส่ค่าใน msg.payload สำหรับแสดงบน dashboard\nmsg.payload = displayValue;\nmsg.topic = \"last_cycle\";\n\n\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 790,
        "y": 1600,
        "wires": [
            [
                "1953fcd32a5810a0"
            ]
        ]
    },
    {
        "id": "f24e149bc993640d",
        "type": "modbus-read",
        "z": "606aeeb2baf6caa6",
        "g": "3f0fdcf240a11d38",
        "name": "40001",
        "topic": "",
        "showStatusActivities": false,
        "logIOActivities": false,
        "showErrors": false,
        "showWarnings": true,
        "unitid": "",
        "dataType": "HoldingRegister",
        "adr": "0",
        "quantity": "1",
        "rate": "1",
        "rateUnit": "s",
        "delayOnStart": false,
        "enableDeformedMessages": false,
        "startDelayTime": "",
        "server": "fbd0b95b24a274df",
        "useIOFile": false,
        "ioFile": "",
        "useIOForPayload": false,
        "emptyMsgOnFail": false,
        "x": 670,
        "y": 1640,
        "wires": [
            [],
            [
                "8e5b8ccbc6013897"
            ]
        ]
    },
    {
        "id": "8e5b8ccbc6013897",
        "type": "function",
        "z": "606aeeb2baf6caa6",
        "g": "3f0fdcf240a11d38",
        "name": "status Mc on",
        "func": "let value = msg.payload.data[0];\n\nif (value === 1) {\n    msg.payload = \"ON\";\n} else if (value === 0) {\n    msg.payload = \"OFF\";\n} else {\n    msg.payload = \"Unknown\";  // กรณีที่ค่าไม่ใช่ 1 หรือ 0\n}\n msg.topic = \"status_mc_on\"; \nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 790,
        "y": 1640,
        "wires": [
            [
                "1953fcd32a5810a0"
            ]
        ]
    },
    {
        "id": "18389047e323bb23",
        "type": "function",
        "z": "606aeeb2baf6caa6",
        "g": "3f0fdcf240a11d38",
        "name": "CAVITY",
        "func": "// ดึงค่าจาก msg.payload.data[0]\nlet rawValue = msg.payload.data[0];\n\n// หาร 10 เพื่อแปลงเป็นค่าทศนิยม\nlet displayValue = rawValue ;\n\n// ใส่ค่าใน msg.payload สำหรับแสดงบน dashboard\nmsg.payload = displayValue;\nmsg.topic = \"cavity\";\n\n\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 780,
        "y": 1760,
        "wires": [
            [
                "1953fcd32a5810a0"
            ]
        ]
    },
    {
        "id": "3027e70a80141271",
        "type": "modbus-read",
        "z": "606aeeb2baf6caa6",
        "g": "3f0fdcf240a11d38",
        "name": "40017",
        "topic": "",
        "showStatusActivities": false,
        "logIOActivities": false,
        "showErrors": false,
        "showWarnings": true,
        "unitid": "",
        "dataType": "HoldingRegister",
        "adr": "16",
        "quantity": "1",
        "rate": "1",
        "rateUnit": "s",
        "delayOnStart": false,
        "enableDeformedMessages": false,
        "startDelayTime": "",
        "server": "fbd0b95b24a274df",
        "useIOFile": false,
        "ioFile": "",
        "useIOForPayload": false,
        "emptyMsgOnFail": false,
        "x": 670,
        "y": 1800,
        "wires": [
            [],
            [
                "1a50fe3535d53761"
            ]
        ]
    },
    {
        "id": "1a50fe3535d53761",
        "type": "function",
        "z": "606aeeb2baf6caa6",
        "g": "3f0fdcf240a11d38",
        "name": "STD CYCLE ",
        "func": "// ดึงค่าจาก msg.payload.data[0]\nlet rawValue = msg.payload.data[0];\n\n// หาร 10 เพื่อแปลงเป็นค่าทศนิยม\nlet displayValue = rawValue ;\n\n// ใส่ค่าใน msg.payload สำหรับแสดงบน dashboard\nmsg.payload = displayValue;\nmsg.topic = \"std_cycle\";\n\n\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 790,
        "y": 1800,
        "wires": [
            [
                "1953fcd32a5810a0"
            ]
        ]
    },
    {
        "id": "2db540491c6b5523",
        "type": "modbus-read",
        "z": "606aeeb2baf6caa6",
        "g": "3f0fdcf240a11d38",
        "name": "40016",
        "topic": "",
        "showStatusActivities": false,
        "logIOActivities": false,
        "showErrors": false,
        "showWarnings": true,
        "unitid": "",
        "dataType": "HoldingRegister",
        "adr": "15",
        "quantity": "1",
        "rate": "1",
        "rateUnit": "s",
        "delayOnStart": false,
        "enableDeformedMessages": false,
        "startDelayTime": "",
        "server": "fbd0b95b24a274df",
        "useIOFile": false,
        "ioFile": "",
        "useIOForPayload": false,
        "emptyMsgOnFail": false,
        "x": 670,
        "y": 1760,
        "wires": [
            [],
            [
                "18389047e323bb23"
            ]
        ]
    },
    {
        "id": "1953fcd32a5810a0",
        "type": "join",
        "z": "606aeeb2baf6caa6",
        "g": "3f0fdcf240a11d38",
        "name": "รวมข้อมูล (Join)",
        "mode": "custom",
        "build": "object",
        "property": "payload",
        "propertyType": "msg",
        "key": "topic",
        "joiner": "\\n",
        "joinerType": "str",
        "useparts": true,
        "accumulate": true,
        "timeout": "15",
        "count": "7",
        "reduceRight": false,
        "reduceExp": "",
        "reduceInit": "",
        "reduceInitType": "",
        "reduceFixup": "",
        "x": 1030,
        "y": 1680,
        "wires": [
            [
                "909ab4a852ba2345"
            ]
        ]
    },
    {
        "id": "909ab4a852ba2345",
        "type": "function",
        "z": "606aeeb2baf6caa6",
        "g": "3f0fdcf240a11d38",
        "name": "เช็คความครบ",
        "func": "// รายชื่อหัวข้อข้อมูลที่ต้องมีให้ครบ 7 ตัว\nvar requiredKeys = [\n    \"present_cycle\", \n    \"last_cycle\", \n    \"cavity\", \n    \"std_cycle\", \n    \"status_mc_on\", \n    \"model\", \n    \"total_pcs\"\n];\n\n// ดึงคีย์ที่มีอยู่ใน msg.payload ตอนนี้\nvar currentKeys = Object.keys(msg.payload);\n\n// เช็คว่าขาดตัวไหนไปบ้าง\nvar missing = requiredKeys.filter(function(key) {\n    return !currentKeys.includes(key);\n});\n\n// ถ้ามีตัวที่ขาด (missing > 0)\nif (missing.length > 0) {\n    // บันทึก Log ว่าขาดอะไร (ดูใน Debug)\n    node.warn(\"ข้อมูลไม่ครบ! ขาด: \" + missing.join(\", \"));\n    return null; // *** หยุดการส่งข้อมูลทันที ไม่ไปต่อ ***\n}\n\n// ถ้าครบถ้วน ให้ไปต่อ\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1250,
        "y": 1680,
        "wires": [
            [
                "92ba15e001906e55"
            ]
        ]
    },
    {
        "id": "92ba15e001906e55",
        "type": "function",
        "z": "606aeeb2baf6caa6",
        "g": "3f0fdcf240a11d38",
        "name": "ตั้งค่า Data & Save Global V2",
        "func": "// 1. --- ตั้งค่า Config ---\nvar mySheetID = \"1RJ9OI8Bz8Xy_7HW7fZVQnjeYshDd0BZUZrkG3ycJfy0\"; // ใส่ ID Sheet\nvar machineID = 5;\nvar machineName = \"1300-5\"; // <--- ชื่อที่จะไปโชว์ใน Excel ช่อง B\n\n// รับข้อมูลรวมจาก Join\nvar data = msg.payload;\nvar now = new Date().toLocaleString(\"th-TH\", { timeZone: \"Asia/Bangkok\" });\n\n// 2. --- อัปเดตข้อมูลสำหรับ React (Global Variable) ---\nvar reactData = {\n    id: machineID,\n    name: machineName,\n    machine_no: machineName,\n    status: (data.status_mc_on == 1) ? 1 : 0,\n    present_cycle: parseFloat(data.present_cycle || 0),\n    last_cycle: parseFloat(data.last_cycle || 0),\n    std_cycle: parseFloat(data.std_cycle || 0),\n    \n    // *** แก้ตรงนี้ด้วยนิดนึงครับ ***\n    // Model มักเป็นตัวหนังสือ (เช่น HC00443E) ห้ามใช้ parseFloat ไม่งั้นค่าจะเพี้ยนเป็น NaN หรือ 0\n    model: data.model || \"-\", \n    \n    cavity: parseFloat(data.cavity || 0),\n    total_pcs: parseFloat(data.total_pcs || 0),\n    timestamp: now\n};\n\n// เก็บลงตัวแปรกลาง\nvar allMachines = global.get(\"machineData\") || [];\nvar idx = allMachines.findIndex(m => m.id === machineID);\nif (idx !== -1) allMachines[idx] = Object.assign(allMachines[idx], reactData);\nelse allMachines.push(reactData);\nglobal.set(\"machineData\", allMachines);\n\n// 3. --- เตรียมข้อมูลส่ง Google Sheet ---\ndata.spreadsheetId = mySheetID;\ndata.timestamp = now;\n\n// >>> เติมบรรทัดนี้ครับ เพื่อให้ Google Sheet รู้จักชื่อเครื่อง <<<\ndata.machine_no = machineName; \n\nmsg.payload = data;\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1480,
        "y": 1680,
        "wires": [
            [
                "0722e294ab5a22d4"
            ]
        ]
    },
    {
        "id": "0722e294ab5a22d4",
        "type": "link out",
        "z": "606aeeb2baf6caa6",
        "g": "3f0fdcf240a11d38",
        "name": "IN 5",
        "mode": "link",
        "links": [
            "dd26c36cf98dcfbe"
        ],
        "x": 1645,
        "y": 1680,
        "wires": []
    },
    {
        "id": "fbd0b95b24a274df",
        "type": "modbus-client",
        "name": "1300-5",
        "clienttype": "tcp",
        "bufferCommands": true,
        "stateLogEnabled": false,
        "queueLogEnabled": false,
        "failureLogEnabled": true,
        "tcpHost": "192.168.7.128",
        "tcpPort": 502,
        "tcpType": "DEFAULT",
        "serialPort": "/dev/ttyUSB",
        "serialType": "RTU-BUFFERD",
        "serialBaudrate": 9600,
        "serialDatabits": 8,
        "serialStopbits": 1,
        "serialParity": "none",
        "serialConnectionDelay": 100,
        "serialAsciiResponseStartDelimiter": "0x3A",
        "unit_id": 5,
        "commandDelay": 1,
        "clientTimeout": 1000,
        "reconnectOnTimeout": true,
        "reconnectTimeout": 2000,
        "parallelUnitIdsAllowed": true,
        "showErrors": false,
        "showWarnings": true,
        "showLogs": true
    },
    {
        "id": "f3cc3cb5807b98cc",
        "type": "group",
        "z": "606aeeb2baf6caa6",
        "g": "7351bc4077f8b06d",
        "style": {
            "stroke": "#999999",
            "stroke-opacity": "1",
            "fill": "none",
            "fill-opacity": "1",
            "label": true,
            "label-position": "nw",
            "color": "#a4a4a4"
        },
        "nodes": [
            "d6268d0a3aa31cba",
            "a4478e81c39cc7f0",
            "e3408bf15c4bda3a",
            "1767516a197b4354",
            "d3559651c79d6334",
            "54420ab023a42ac1",
            "75412919aff2e940",
            "cb6ca3ad5b0b6807",
            "be33c615372feff4",
            "37a6ec4e2b6a9793",
            "b89e279c8747d02d",
            "369bb01b1fd22a8a",
            "2869922718f3822b",
            "16eee17d6be4954d",
            "31a1415493c3c1e9",
            "12da1ac6303a0740",
            "cb5eaddab28a5168"
        ],
        "x": 574,
        "y": 1859,
        "w": 1112,
        "h": 322
    },
    {
        "id": "d6268d0a3aa31cba",
        "type": "function",
        "z": "606aeeb2baf6caa6",
        "g": "f3cc3cb5807b98cc",
        "name": "Model",
        "func": "\nif (Array.isArray(msg.payload)) {\n    var match = msg.payload.find(item => item.machine === \"1300/3\");\n    if (match) {\n        msg.payload = match.detail_g; \n        msg.topic = \"model\"; \n        return msg;\n    }\n}\n\nreturn null;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 770,
        "y": 2020,
        "wires": [
            [
                "16eee17d6be4954d"
            ]
        ]
    },
    {
        "id": "a4478e81c39cc7f0",
        "type": "function",
        "z": "606aeeb2baf6caa6",
        "g": "f3cc3cb5807b98cc",
        "name": "Total Pcs.",
        "func": "// 1. ตรวจสอบก่อนว่าเป็น Array (รายการ) หรือไม่ เพื่อกัน Error\nif (!Array.isArray(msg.payload)) {\n    // ถ้าไม่ใช่ List รายการ ให้ข้ามไป\n    return null; \n}\n\n// 2. ค้นหาเครื่องจักรชื่อ \"1200/1\" (แก้ชื่อตรงนี้ได้ตามจริง)\nvar match = msg.payload.find(item => item.machine === \"1300/3\");\n\nif (match) {\n    // 3. ดึงค่าผลรวม Z มาใส่ payload\n    msg.payload = match.detail_z; \n\n    // 4. --- กำหนดชื่อหัวข้อ (สำคัญมาก) ---\n    // เพื่อให้ Join Node รู้ว่าค่านี่คือ \"detail_z\"\n    msg.topic = \"total_pcs\"; \n\n    return msg;\n}\n\n// ถ้าหาไม่เจอ ให้คืนค่า null\nreturn null;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 780,
        "y": 2060,
        "wires": [
            [
                "16eee17d6be4954d"
            ]
        ]
    },
    {
        "id": "e3408bf15c4bda3a",
        "type": "comment",
        "z": "606aeeb2baf6caa6",
        "g": "f3cc3cb5807b98cc",
        "name": "6",
        "info": "",
        "x": 1030,
        "y": 1920,
        "wires": []
    },
    {
        "id": "1767516a197b4354",
        "type": "modbus-read",
        "z": "606aeeb2baf6caa6",
        "g": "f3cc3cb5807b98cc",
        "name": "40002",
        "topic": "",
        "showStatusActivities": false,
        "logIOActivities": false,
        "showErrors": false,
        "showWarnings": true,
        "unitid": "",
        "dataType": "HoldingRegister",
        "adr": "1",
        "quantity": "1",
        "rate": "1",
        "rateUnit": "s",
        "delayOnStart": false,
        "enableDeformedMessages": false,
        "startDelayTime": "",
        "server": "349d64922511895b",
        "useIOFile": false,
        "ioFile": "",
        "useIOForPayload": false,
        "emptyMsgOnFail": false,
        "x": 670,
        "y": 1900,
        "wires": [
            [],
            [
                "d3559651c79d6334"
            ]
        ]
    },
    {
        "id": "d3559651c79d6334",
        "type": "function",
        "z": "606aeeb2baf6caa6",
        "g": "f3cc3cb5807b98cc",
        "name": "Present cycle",
        "func": "// ดึงค่าจาก msg.payload.data[0]\nlet rawValue = msg.payload.data[0];\n\n// หาร 10 เพื่อแปลงเป็นค่าทศนิยม\nlet displayValue = rawValue / 10;\n\n// ใส่ค่าใน msg.payload สำหรับแสดงบน dashboard\nmsg.payload = displayValue;\n\nmsg.topic = \"present_cycle\";\n\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 800,
        "y": 1900,
        "wires": [
            [
                "16eee17d6be4954d"
            ]
        ]
    },
    {
        "id": "54420ab023a42ac1",
        "type": "modbus-read",
        "z": "606aeeb2baf6caa6",
        "g": "f3cc3cb5807b98cc",
        "name": "40003",
        "topic": "",
        "showStatusActivities": false,
        "logIOActivities": false,
        "showErrors": false,
        "showWarnings": true,
        "unitid": "",
        "dataType": "HoldingRegister",
        "adr": "2",
        "quantity": "1",
        "rate": "1",
        "rateUnit": "s",
        "delayOnStart": false,
        "enableDeformedMessages": false,
        "startDelayTime": "",
        "server": "349d64922511895b",
        "useIOFile": false,
        "ioFile": "",
        "useIOForPayload": false,
        "emptyMsgOnFail": false,
        "x": 670,
        "y": 1940,
        "wires": [
            [],
            [
                "75412919aff2e940"
            ]
        ]
    },
    {
        "id": "75412919aff2e940",
        "type": "function",
        "z": "606aeeb2baf6caa6",
        "g": "f3cc3cb5807b98cc",
        "name": "Last cycle",
        "func": "// ดึงค่าจาก msg.payload.data[0]\nlet rawValue = msg.payload.data[0];\n\n// หาร 10 เพื่อแปลงเป็นค่าทศนิยม\nlet displayValue = rawValue / 10;\n\n// ใส่ค่าใน msg.payload สำหรับแสดงบน dashboard\nmsg.payload = displayValue;\nmsg.topic = \"last_cycle\";\n\n\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 790,
        "y": 1940,
        "wires": [
            [
                "16eee17d6be4954d"
            ]
        ]
    },
    {
        "id": "cb6ca3ad5b0b6807",
        "type": "modbus-read",
        "z": "606aeeb2baf6caa6",
        "g": "f3cc3cb5807b98cc",
        "name": "40001",
        "topic": "",
        "showStatusActivities": false,
        "logIOActivities": false,
        "showErrors": false,
        "showWarnings": true,
        "unitid": "",
        "dataType": "HoldingRegister",
        "adr": "0",
        "quantity": "1",
        "rate": "1",
        "rateUnit": "s",
        "delayOnStart": false,
        "enableDeformedMessages": false,
        "startDelayTime": "",
        "server": "349d64922511895b",
        "useIOFile": false,
        "ioFile": "",
        "useIOForPayload": false,
        "emptyMsgOnFail": false,
        "x": 670,
        "y": 1980,
        "wires": [
            [],
            [
                "be33c615372feff4"
            ]
        ]
    },
    {
        "id": "be33c615372feff4",
        "type": "function",
        "z": "606aeeb2baf6caa6",
        "g": "f3cc3cb5807b98cc",
        "name": "status Mc on",
        "func": "let value = msg.payload.data[0];\n\nif (value === 1) {\n    msg.payload = \"ON\";\n} else if (value === 0) {\n    msg.payload = \"OFF\";\n} else {\n    msg.payload = \"Unknown\";  // กรณีที่ค่าไม่ใช่ 1 หรือ 0\n}\n msg.topic = \"status_mc_on\"; \nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 790,
        "y": 1980,
        "wires": [
            [
                "16eee17d6be4954d"
            ]
        ]
    },
    {
        "id": "37a6ec4e2b6a9793",
        "type": "function",
        "z": "606aeeb2baf6caa6",
        "g": "f3cc3cb5807b98cc",
        "name": "CAVITY",
        "func": "// ดึงค่าจาก msg.payload.data[0]\nlet rawValue = msg.payload.data[0];\n\n// หาร 10 เพื่อแปลงเป็นค่าทศนิยม\nlet displayValue = rawValue ;\n\n// ใส่ค่าใน msg.payload สำหรับแสดงบน dashboard\nmsg.payload = displayValue;\nmsg.topic = \"cavity\";\n\n\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 780,
        "y": 2100,
        "wires": [
            [
                "16eee17d6be4954d"
            ]
        ]
    },
    {
        "id": "b89e279c8747d02d",
        "type": "modbus-read",
        "z": "606aeeb2baf6caa6",
        "g": "f3cc3cb5807b98cc",
        "name": "40017",
        "topic": "",
        "showStatusActivities": false,
        "logIOActivities": false,
        "showErrors": false,
        "showWarnings": true,
        "unitid": "",
        "dataType": "HoldingRegister",
        "adr": "16",
        "quantity": "1",
        "rate": "1",
        "rateUnit": "s",
        "delayOnStart": false,
        "enableDeformedMessages": false,
        "startDelayTime": "",
        "server": "349d64922511895b",
        "useIOFile": false,
        "ioFile": "",
        "useIOForPayload": false,
        "emptyMsgOnFail": false,
        "x": 670,
        "y": 2140,
        "wires": [
            [],
            [
                "369bb01b1fd22a8a"
            ]
        ]
    },
    {
        "id": "369bb01b1fd22a8a",
        "type": "function",
        "z": "606aeeb2baf6caa6",
        "g": "f3cc3cb5807b98cc",
        "name": "STD CYCLE ",
        "func": "// ดึงค่าจาก msg.payload.data[0]\nlet rawValue = msg.payload.data[0];\n\n// หาร 10 เพื่อแปลงเป็นค่าทศนิยม\nlet displayValue = rawValue ;\n\n// ใส่ค่าใน msg.payload สำหรับแสดงบน dashboard\nmsg.payload = displayValue;\nmsg.topic = \"std_cycle\";\n\n\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 790,
        "y": 2140,
        "wires": [
            [
                "16eee17d6be4954d"
            ]
        ]
    },
    {
        "id": "2869922718f3822b",
        "type": "modbus-read",
        "z": "606aeeb2baf6caa6",
        "g": "f3cc3cb5807b98cc",
        "name": "40016",
        "topic": "",
        "showStatusActivities": false,
        "logIOActivities": false,
        "showErrors": false,
        "showWarnings": true,
        "unitid": "",
        "dataType": "HoldingRegister",
        "adr": "15",
        "quantity": "1",
        "rate": "1",
        "rateUnit": "s",
        "delayOnStart": false,
        "enableDeformedMessages": false,
        "startDelayTime": "",
        "server": "349d64922511895b",
        "useIOFile": false,
        "ioFile": "",
        "useIOForPayload": false,
        "emptyMsgOnFail": false,
        "x": 670,
        "y": 2100,
        "wires": [
            [],
            [
                "37a6ec4e2b6a9793"
            ]
        ]
    },
    {
        "id": "16eee17d6be4954d",
        "type": "join",
        "z": "606aeeb2baf6caa6",
        "g": "f3cc3cb5807b98cc",
        "name": "รวมข้อมูล (Join)",
        "mode": "custom",
        "build": "object",
        "property": "payload",
        "propertyType": "msg",
        "key": "topic",
        "joiner": "\\n",
        "joinerType": "str",
        "useparts": true,
        "accumulate": true,
        "timeout": "15",
        "count": "7",
        "reduceRight": false,
        "reduceExp": "",
        "reduceInit": "",
        "reduceInitType": "",
        "reduceFixup": "",
        "x": 1030,
        "y": 2020,
        "wires": [
            [
                "31a1415493c3c1e9"
            ]
        ]
    },
    {
        "id": "31a1415493c3c1e9",
        "type": "function",
        "z": "606aeeb2baf6caa6",
        "g": "f3cc3cb5807b98cc",
        "name": "เช็คความครบ",
        "func": "// รายชื่อหัวข้อข้อมูลที่ต้องมีให้ครบ 7 ตัว\nvar requiredKeys = [\n    \"present_cycle\", \n    \"last_cycle\", \n    \"cavity\", \n    \"std_cycle\", \n    \"status_mc_on\", \n    \"model\", \n    \"total_pcs\"\n];\n\n// ดึงคีย์ที่มีอยู่ใน msg.payload ตอนนี้\nvar currentKeys = Object.keys(msg.payload);\n\n// เช็คว่าขาดตัวไหนไปบ้าง\nvar missing = requiredKeys.filter(function(key) {\n    return !currentKeys.includes(key);\n});\n\n// ถ้ามีตัวที่ขาด (missing > 0)\nif (missing.length > 0) {\n    // บันทึก Log ว่าขาดอะไร (ดูใน Debug)\n    node.warn(\"ข้อมูลไม่ครบ! ขาด: \" + missing.join(\", \"));\n    return null; // *** หยุดการส่งข้อมูลทันที ไม่ไปต่อ ***\n}\n\n// ถ้าครบถ้วน ให้ไปต่อ\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1250,
        "y": 2020,
        "wires": [
            [
                "12da1ac6303a0740"
            ]
        ]
    },
    {
        "id": "12da1ac6303a0740",
        "type": "function",
        "z": "606aeeb2baf6caa6",
        "g": "f3cc3cb5807b98cc",
        "name": "ตั้งค่า Data & Save Global V2",
        "func": "// 1. --- ตั้งค่า Config ---\nvar mySheetID = \"1RJ9OI8Bz8Xy_7HW7fZVQnjeYshDd0BZUZrkG3ycJfy0\"; // ใส่ ID Sheet\nvar machineID = 6;\nvar machineName = \"1200-6\"; // <--- ชื่อที่จะไปโชว์ใน Excel ช่อง B\n\n// รับข้อมูลรวมจาก Join\nvar data = msg.payload;\nvar now = new Date().toLocaleString(\"th-TH\", { timeZone: \"Asia/Bangkok\" });\n\n// 2. --- อัปเดตข้อมูลสำหรับ React (Global Variable) ---\nvar reactData = {\n    id: machineID,\n    name: machineName,\n    machine_no: machineName,\n    status: (data.status_mc_on == 1) ? 1 : 0,\n    present_cycle: parseFloat(data.present_cycle || 0),\n    last_cycle: parseFloat(data.last_cycle || 0),\n    std_cycle: parseFloat(data.std_cycle || 0),\n    \n    // *** แก้ตรงนี้ด้วยนิดนึงครับ ***\n    // Model มักเป็นตัวหนังสือ (เช่น HC00443E) ห้ามใช้ parseFloat ไม่งั้นค่าจะเพี้ยนเป็น NaN หรือ 0\n    model: data.model || \"-\", \n    \n    cavity: parseFloat(data.cavity || 0),\n    total_pcs: parseFloat(data.total_pcs || 0),\n    timestamp: now\n};\n\n// เก็บลงตัวแปรกลาง\nvar allMachines = global.get(\"machineData\") || [];\nvar idx = allMachines.findIndex(m => m.id === machineID);\nif (idx !== -1) allMachines[idx] = Object.assign(allMachines[idx], reactData);\nelse allMachines.push(reactData);\nglobal.set(\"machineData\", allMachines);\n\n// 3. --- เตรียมข้อมูลส่ง Google Sheet ---\ndata.spreadsheetId = mySheetID;\ndata.timestamp = now;\n\n// >>> เติมบรรทัดนี้ครับ เพื่อให้ Google Sheet รู้จักชื่อเครื่อง <<<\ndata.machine_no = machineName; \n\nmsg.payload = data;\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1480,
        "y": 2020,
        "wires": [
            [
                "cb5eaddab28a5168"
            ]
        ]
    },
    {
        "id": "cb5eaddab28a5168",
        "type": "link out",
        "z": "606aeeb2baf6caa6",
        "g": "f3cc3cb5807b98cc",
        "name": "IN 6",
        "mode": "link",
        "links": [
            "1b37248b4eb95c13"
        ],
        "x": 1645,
        "y": 2020,
        "wires": []
    },
    {
        "id": "349d64922511895b",
        "type": "modbus-client",
        "name": "1200-6",
        "clienttype": "tcp",
        "bufferCommands": true,
        "stateLogEnabled": false,
        "queueLogEnabled": false,
        "failureLogEnabled": true,
        "tcpHost": "192.168.7.130",
        "tcpPort": 502,
        "tcpType": "DEFAULT",
        "serialPort": "/dev/ttyUSB",
        "serialType": "RTU-BUFFERD",
        "serialBaudrate": 9600,
        "serialDatabits": 8,
        "serialStopbits": 1,
        "serialParity": "none",
        "serialConnectionDelay": 100,
        "serialAsciiResponseStartDelimiter": "0x3A",
        "unit_id": 6,
        "commandDelay": 1,
        "clientTimeout": 1000,
        "reconnectOnTimeout": true,
        "reconnectTimeout": 2000,
        "parallelUnitIdsAllowed": true,
        "showErrors": false,
        "showWarnings": true,
        "showLogs": true
    },
    {
        "id": "46840aae0f0153d2",
        "type": "group",
        "z": "606aeeb2baf6caa6",
        "g": "7351bc4077f8b06d",
        "style": {
            "stroke": "#999999",
            "stroke-opacity": "1",
            "fill": "none",
            "fill-opacity": "1",
            "label": true,
            "label-position": "nw",
            "color": "#a4a4a4"
        },
        "nodes": [
            "0a79867b1aea321b",
            "2717cb86f88ba852",
            "9b5e70c38088cfed",
            "817aa6cd845d9a1c",
            "cdd6e8ad601de262",
            "b91d2fcec97e1500",
            "1ac702deca68af15",
            "81964c10922b1581",
            "50bc5437241bef60",
            "4702bb9a8b0b91c6",
            "1189c772ae32e7f4",
            "11724a6260e028ce",
            "2eebc5afe3118b00",
            "a641a05e1e99096b",
            "a017aef9827950f8",
            "6a19b3e76231a01d",
            "aee3135d05b2733f"
        ],
        "x": 574,
        "y": 2199,
        "w": 1112,
        "h": 322
    },
    {
        "id": "0a79867b1aea321b",
        "type": "function",
        "z": "606aeeb2baf6caa6",
        "g": "46840aae0f0153d2",
        "name": "Model",
        "func": "\nif (Array.isArray(msg.payload)) {\n    var match = msg.payload.find(item => item.machine === \"1300/3\");\n    if (match) {\n        msg.payload = match.detail_g; \n        msg.topic = \"model\"; \n        return msg;\n    }\n}\n\nreturn null;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 770,
        "y": 2360,
        "wires": [
            [
                "a641a05e1e99096b"
            ]
        ]
    },
    {
        "id": "2717cb86f88ba852",
        "type": "function",
        "z": "606aeeb2baf6caa6",
        "g": "46840aae0f0153d2",
        "name": "Total Pcs.",
        "func": "// 1. ตรวจสอบก่อนว่าเป็น Array (รายการ) หรือไม่ เพื่อกัน Error\nif (!Array.isArray(msg.payload)) {\n    // ถ้าไม่ใช่ List รายการ ให้ข้ามไป\n    return null; \n}\n\n// 2. ค้นหาเครื่องจักรชื่อ \"1200/1\" (แก้ชื่อตรงนี้ได้ตามจริง)\nvar match = msg.payload.find(item => item.machine === \"1300/3\");\n\nif (match) {\n    // 3. ดึงค่าผลรวม Z มาใส่ payload\n    msg.payload = match.detail_z; \n\n    // 4. --- กำหนดชื่อหัวข้อ (สำคัญมาก) ---\n    // เพื่อให้ Join Node รู้ว่าค่านี่คือ \"detail_z\"\n    msg.topic = \"total_pcs\"; \n\n    return msg;\n}\n\n// ถ้าหาไม่เจอ ให้คืนค่า null\nreturn null;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 780,
        "y": 2400,
        "wires": [
            [
                "a641a05e1e99096b"
            ]
        ]
    },
    {
        "id": "9b5e70c38088cfed",
        "type": "comment",
        "z": "606aeeb2baf6caa6",
        "g": "46840aae0f0153d2",
        "name": "7",
        "info": "",
        "x": 1030,
        "y": 2260,
        "wires": []
    },
    {
        "id": "817aa6cd845d9a1c",
        "type": "modbus-read",
        "z": "606aeeb2baf6caa6",
        "g": "46840aae0f0153d2",
        "name": "40002",
        "topic": "",
        "showStatusActivities": false,
        "logIOActivities": false,
        "showErrors": false,
        "showWarnings": true,
        "unitid": "",
        "dataType": "HoldingRegister",
        "adr": "1",
        "quantity": "1",
        "rate": "1",
        "rateUnit": "s",
        "delayOnStart": false,
        "enableDeformedMessages": false,
        "startDelayTime": "",
        "server": "e78f4805941a2693",
        "useIOFile": false,
        "ioFile": "",
        "useIOForPayload": false,
        "emptyMsgOnFail": false,
        "x": 670,
        "y": 2240,
        "wires": [
            [],
            [
                "cdd6e8ad601de262"
            ]
        ]
    },
    {
        "id": "cdd6e8ad601de262",
        "type": "function",
        "z": "606aeeb2baf6caa6",
        "g": "46840aae0f0153d2",
        "name": "Present cycle",
        "func": "// ดึงค่าจาก msg.payload.data[0]\nlet rawValue = msg.payload.data[0];\n\n// หาร 10 เพื่อแปลงเป็นค่าทศนิยม\nlet displayValue = rawValue / 10;\n\n// ใส่ค่าใน msg.payload สำหรับแสดงบน dashboard\nmsg.payload = displayValue;\n\nmsg.topic = \"present_cycle\";\n\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 800,
        "y": 2240,
        "wires": [
            [
                "a641a05e1e99096b"
            ]
        ]
    },
    {
        "id": "b91d2fcec97e1500",
        "type": "modbus-read",
        "z": "606aeeb2baf6caa6",
        "g": "46840aae0f0153d2",
        "name": "40003",
        "topic": "",
        "showStatusActivities": false,
        "logIOActivities": false,
        "showErrors": false,
        "showWarnings": true,
        "unitid": "",
        "dataType": "HoldingRegister",
        "adr": "2",
        "quantity": "1",
        "rate": "1",
        "rateUnit": "s",
        "delayOnStart": false,
        "enableDeformedMessages": false,
        "startDelayTime": "",
        "server": "e78f4805941a2693",
        "useIOFile": false,
        "ioFile": "",
        "useIOForPayload": false,
        "emptyMsgOnFail": false,
        "x": 670,
        "y": 2280,
        "wires": [
            [],
            [
                "1ac702deca68af15"
            ]
        ]
    },
    {
        "id": "1ac702deca68af15",
        "type": "function",
        "z": "606aeeb2baf6caa6",
        "g": "46840aae0f0153d2",
        "name": "Last cycle",
        "func": "// ดึงค่าจาก msg.payload.data[0]\nlet rawValue = msg.payload.data[0];\n\n// หาร 10 เพื่อแปลงเป็นค่าทศนิยม\nlet displayValue = rawValue / 10;\n\n// ใส่ค่าใน msg.payload สำหรับแสดงบน dashboard\nmsg.payload = displayValue;\nmsg.topic = \"last_cycle\";\n\n\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 790,
        "y": 2280,
        "wires": [
            [
                "a641a05e1e99096b"
            ]
        ]
    },
    {
        "id": "81964c10922b1581",
        "type": "modbus-read",
        "z": "606aeeb2baf6caa6",
        "g": "46840aae0f0153d2",
        "name": "40001",
        "topic": "",
        "showStatusActivities": false,
        "logIOActivities": false,
        "showErrors": false,
        "showWarnings": true,
        "unitid": "",
        "dataType": "HoldingRegister",
        "adr": "0",
        "quantity": "1",
        "rate": "1",
        "rateUnit": "s",
        "delayOnStart": false,
        "enableDeformedMessages": false,
        "startDelayTime": "",
        "server": "e78f4805941a2693",
        "useIOFile": false,
        "ioFile": "",
        "useIOForPayload": false,
        "emptyMsgOnFail": false,
        "x": 670,
        "y": 2320,
        "wires": [
            [],
            [
                "50bc5437241bef60"
            ]
        ]
    },
    {
        "id": "50bc5437241bef60",
        "type": "function",
        "z": "606aeeb2baf6caa6",
        "g": "46840aae0f0153d2",
        "name": "status Mc on",
        "func": "let value = msg.payload.data[0];\n\nif (value === 1) {\n    msg.payload = \"ON\";\n} else if (value === 0) {\n    msg.payload = \"OFF\";\n} else {\n    msg.payload = \"Unknown\";  // กรณีที่ค่าไม่ใช่ 1 หรือ 0\n}\n msg.topic = \"status_mc_on\"; \nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 790,
        "y": 2320,
        "wires": [
            [
                "a641a05e1e99096b"
            ]
        ]
    },
    {
        "id": "4702bb9a8b0b91c6",
        "type": "function",
        "z": "606aeeb2baf6caa6",
        "g": "46840aae0f0153d2",
        "name": "CAVITY",
        "func": "// ดึงค่าจาก msg.payload.data[0]\nlet rawValue = msg.payload.data[0];\n\n// หาร 10 เพื่อแปลงเป็นค่าทศนิยม\nlet displayValue = rawValue ;\n\n// ใส่ค่าใน msg.payload สำหรับแสดงบน dashboard\nmsg.payload = displayValue;\nmsg.topic = \"cavity\";\n\n\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 780,
        "y": 2440,
        "wires": [
            [
                "a641a05e1e99096b"
            ]
        ]
    },
    {
        "id": "1189c772ae32e7f4",
        "type": "modbus-read",
        "z": "606aeeb2baf6caa6",
        "g": "46840aae0f0153d2",
        "name": "40017",
        "topic": "",
        "showStatusActivities": false,
        "logIOActivities": false,
        "showErrors": false,
        "showWarnings": true,
        "unitid": "",
        "dataType": "HoldingRegister",
        "adr": "16",
        "quantity": "1",
        "rate": "1",
        "rateUnit": "s",
        "delayOnStart": false,
        "enableDeformedMessages": false,
        "startDelayTime": "",
        "server": "e78f4805941a2693",
        "useIOFile": false,
        "ioFile": "",
        "useIOForPayload": false,
        "emptyMsgOnFail": false,
        "x": 670,
        "y": 2480,
        "wires": [
            [],
            [
                "11724a6260e028ce"
            ]
        ]
    },
    {
        "id": "11724a6260e028ce",
        "type": "function",
        "z": "606aeeb2baf6caa6",
        "g": "46840aae0f0153d2",
        "name": "STD CYCLE ",
        "func": "// ดึงค่าจาก msg.payload.data[0]\nlet rawValue = msg.payload.data[0];\n\n// หาร 10 เพื่อแปลงเป็นค่าทศนิยม\nlet displayValue = rawValue ;\n\n// ใส่ค่าใน msg.payload สำหรับแสดงบน dashboard\nmsg.payload = displayValue;\nmsg.topic = \"std_cycle\";\n\n\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 790,
        "y": 2480,
        "wires": [
            [
                "a641a05e1e99096b"
            ]
        ]
    },
    {
        "id": "2eebc5afe3118b00",
        "type": "modbus-read",
        "z": "606aeeb2baf6caa6",
        "g": "46840aae0f0153d2",
        "name": "40016",
        "topic": "",
        "showStatusActivities": false,
        "logIOActivities": false,
        "showErrors": false,
        "showWarnings": true,
        "unitid": "",
        "dataType": "HoldingRegister",
        "adr": "15",
        "quantity": "1",
        "rate": "1",
        "rateUnit": "s",
        "delayOnStart": false,
        "enableDeformedMessages": false,
        "startDelayTime": "",
        "server": "e78f4805941a2693",
        "useIOFile": false,
        "ioFile": "",
        "useIOForPayload": false,
        "emptyMsgOnFail": false,
        "x": 670,
        "y": 2440,
        "wires": [
            [],
            [
                "4702bb9a8b0b91c6"
            ]
        ]
    },
    {
        "id": "a641a05e1e99096b",
        "type": "join",
        "z": "606aeeb2baf6caa6",
        "g": "46840aae0f0153d2",
        "name": "รวมข้อมูล (Join)",
        "mode": "custom",
        "build": "object",
        "property": "payload",
        "propertyType": "msg",
        "key": "topic",
        "joiner": "\\n",
        "joinerType": "str",
        "useparts": true,
        "accumulate": true,
        "timeout": "15",
        "count": "7",
        "reduceRight": false,
        "reduceExp": "",
        "reduceInit": "",
        "reduceInitType": "",
        "reduceFixup": "",
        "x": 1030,
        "y": 2360,
        "wires": [
            [
                "a017aef9827950f8"
            ]
        ]
    },
    {
        "id": "a017aef9827950f8",
        "type": "function",
        "z": "606aeeb2baf6caa6",
        "g": "46840aae0f0153d2",
        "name": "เช็คความครบ",
        "func": "// รายชื่อหัวข้อข้อมูลที่ต้องมีให้ครบ 7 ตัว\nvar requiredKeys = [\n    \"present_cycle\", \n    \"last_cycle\", \n    \"cavity\", \n    \"std_cycle\", \n    \"status_mc_on\", \n    \"model\", \n    \"total_pcs\"\n];\n\n// ดึงคีย์ที่มีอยู่ใน msg.payload ตอนนี้\nvar currentKeys = Object.keys(msg.payload);\n\n// เช็คว่าขาดตัวไหนไปบ้าง\nvar missing = requiredKeys.filter(function(key) {\n    return !currentKeys.includes(key);\n});\n\n// ถ้ามีตัวที่ขาด (missing > 0)\nif (missing.length > 0) {\n    // บันทึก Log ว่าขาดอะไร (ดูใน Debug)\n    node.warn(\"ข้อมูลไม่ครบ! ขาด: \" + missing.join(\", \"));\n    return null; // *** หยุดการส่งข้อมูลทันที ไม่ไปต่อ ***\n}\n\n// ถ้าครบถ้วน ให้ไปต่อ\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1250,
        "y": 2360,
        "wires": [
            [
                "6a19b3e76231a01d"
            ]
        ]
    },
    {
        "id": "6a19b3e76231a01d",
        "type": "function",
        "z": "606aeeb2baf6caa6",
        "g": "46840aae0f0153d2",
        "name": "ตั้งค่า Data & Save Global V2",
        "func": "// 1. --- ตั้งค่า Config ---\nvar mySheetID = \"1RJ9OI8Bz8Xy_7HW7fZVQnjeYshDd0BZUZrkG3ycJfy0\"; // ใส่ ID Sheet\nvar machineID = 7;\nvar machineName = \"1400-7\"; // <--- ชื่อที่จะไปโชว์ใน Excel ช่อง B\n\n// รับข้อมูลรวมจาก Join\nvar data = msg.payload;\nvar now = new Date().toLocaleString(\"th-TH\", { timeZone: \"Asia/Bangkok\" });\n\n// 2. --- อัปเดตข้อมูลสำหรับ React (Global Variable) ---\nvar reactData = {\n    id: machineID,\n    name: machineName,\n    machine_no: machineName,\n    status: (data.status_mc_on == 1) ? 1 : 0,\n    present_cycle: parseFloat(data.present_cycle || 0),\n    last_cycle: parseFloat(data.last_cycle || 0),\n    std_cycle: parseFloat(data.std_cycle || 0),\n    \n    // *** แก้ตรงนี้ด้วยนิดนึงครับ ***\n    // Model มักเป็นตัวหนังสือ (เช่น HC00443E) ห้ามใช้ parseFloat ไม่งั้นค่าจะเพี้ยนเป็น NaN หรือ 0\n    model: data.model || \"-\", \n    \n    cavity: parseFloat(data.cavity || 0),\n    total_pcs: parseFloat(data.total_pcs || 0),\n    timestamp: now\n};\n\n// เก็บลงตัวแปรกลาง\nvar allMachines = global.get(\"machineData\") || [];\nvar idx = allMachines.findIndex(m => m.id === machineID);\nif (idx !== -1) allMachines[idx] = Object.assign(allMachines[idx], reactData);\nelse allMachines.push(reactData);\nglobal.set(\"machineData\", allMachines);\n\n// 3. --- เตรียมข้อมูลส่ง Google Sheet ---\ndata.spreadsheetId = mySheetID;\ndata.timestamp = now;\n\n// >>> เติมบรรทัดนี้ครับ เพื่อให้ Google Sheet รู้จักชื่อเครื่อง <<<\ndata.machine_no = machineName; \n\nmsg.payload = data;\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1480,
        "y": 2360,
        "wires": [
            [
                "aee3135d05b2733f"
            ]
        ]
    },
    {
        "id": "aee3135d05b2733f",
        "type": "link out",
        "z": "606aeeb2baf6caa6",
        "g": "46840aae0f0153d2",
        "name": "IN 7",
        "mode": "link",
        "links": [
            "ac51a8d4b7063108"
        ],
        "x": 1645,
        "y": 2360,
        "wires": []
    },
    {
        "id": "e78f4805941a2693",
        "type": "modbus-client",
        "name": "1400-7",
        "clienttype": "tcp",
        "bufferCommands": true,
        "stateLogEnabled": false,
        "queueLogEnabled": false,
        "failureLogEnabled": true,
        "tcpHost": "192.168.7.131",
        "tcpPort": "502",
        "tcpType": "DEFAULT",
        "serialPort": "/dev/ttyUSB",
        "serialType": "RTU-BUFFERD",
        "serialBaudrate": 9600,
        "serialDatabits": 8,
        "serialStopbits": 1,
        "serialParity": "none",
        "serialConnectionDelay": 100,
        "serialAsciiResponseStartDelimiter": "0x3A",
        "unit_id": 7,
        "commandDelay": 1,
        "clientTimeout": 1000,
        "reconnectOnTimeout": true,
        "reconnectTimeout": 2000,
        "parallelUnitIdsAllowed": true,
        "showErrors": false,
        "showWarnings": true,
        "showLogs": true
    },
    {
        "id": "e68a879fe5e9ae6d",
        "type": "group",
        "z": "606aeeb2baf6caa6",
        "g": "7351bc4077f8b06d",
        "style": {
            "stroke": "#999999",
            "stroke-opacity": "1",
            "fill": "none",
            "fill-opacity": "1",
            "label": true,
            "label-position": "nw",
            "color": "#a4a4a4"
        },
        "nodes": [
            "d8358256594f739d",
            "269930edd8f9ce6b",
            "fd17adeb75b2dad3",
            "95119f805a41e00a",
            "ec53005a5598986a",
            "87148fd6f28d49f2",
            "bbca8ac7a19de2a2",
            "c61f87f76f35763c",
            "5ff501f0f729522e",
            "837e7cd95bf8f67b",
            "7fbc58fa65f67d11",
            "7416772785c3d5fd",
            "ce1b3ebb43d57960",
            "d92be2ee9cfedc4a",
            "768967e0834011ba",
            "fcaab97bf76ca7f3",
            "03c12b3e612c6a24"
        ],
        "x": 574,
        "y": 2539,
        "w": 1112,
        "h": 322
    },
    {
        "id": "d8358256594f739d",
        "type": "function",
        "z": "606aeeb2baf6caa6",
        "g": "e68a879fe5e9ae6d",
        "name": "Model",
        "func": "\nif (Array.isArray(msg.payload)) {\n    var match = msg.payload.find(item => item.machine === \"1300/3\");\n    if (match) {\n        msg.payload = match.detail_g; \n        msg.topic = \"model\"; \n        return msg;\n    }\n}\n\nreturn null;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 770,
        "y": 2700,
        "wires": [
            [
                "d92be2ee9cfedc4a"
            ]
        ]
    },
    {
        "id": "269930edd8f9ce6b",
        "type": "function",
        "z": "606aeeb2baf6caa6",
        "g": "e68a879fe5e9ae6d",
        "name": "Total Pcs.",
        "func": "// 1. ตรวจสอบก่อนว่าเป็น Array (รายการ) หรือไม่ เพื่อกัน Error\nif (!Array.isArray(msg.payload)) {\n    // ถ้าไม่ใช่ List รายการ ให้ข้ามไป\n    return null; \n}\n\n// 2. ค้นหาเครื่องจักรชื่อ \"1200/1\" (แก้ชื่อตรงนี้ได้ตามจริง)\nvar match = msg.payload.find(item => item.machine === \"1300/3\");\n\nif (match) {\n    // 3. ดึงค่าผลรวม Z มาใส่ payload\n    msg.payload = match.detail_z; \n\n    // 4. --- กำหนดชื่อหัวข้อ (สำคัญมาก) ---\n    // เพื่อให้ Join Node รู้ว่าค่านี่คือ \"detail_z\"\n    msg.topic = \"total_pcs\"; \n\n    return msg;\n}\n\n// ถ้าหาไม่เจอ ให้คืนค่า null\nreturn null;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 780,
        "y": 2740,
        "wires": [
            [
                "d92be2ee9cfedc4a"
            ]
        ]
    },
    {
        "id": "fd17adeb75b2dad3",
        "type": "comment",
        "z": "606aeeb2baf6caa6",
        "g": "e68a879fe5e9ae6d",
        "name": "8",
        "info": "",
        "x": 1030,
        "y": 2600,
        "wires": []
    },
    {
        "id": "95119f805a41e00a",
        "type": "modbus-read",
        "z": "606aeeb2baf6caa6",
        "g": "e68a879fe5e9ae6d",
        "name": "40002",
        "topic": "",
        "showStatusActivities": false,
        "logIOActivities": false,
        "showErrors": false,
        "showWarnings": true,
        "unitid": "",
        "dataType": "HoldingRegister",
        "adr": "1",
        "quantity": "1",
        "rate": "1",
        "rateUnit": "s",
        "delayOnStart": false,
        "enableDeformedMessages": false,
        "startDelayTime": "",
        "server": "adefb49d68e9f381",
        "useIOFile": false,
        "ioFile": "",
        "useIOForPayload": false,
        "emptyMsgOnFail": false,
        "x": 670,
        "y": 2580,
        "wires": [
            [],
            [
                "ec53005a5598986a"
            ]
        ]
    },
    {
        "id": "ec53005a5598986a",
        "type": "function",
        "z": "606aeeb2baf6caa6",
        "g": "e68a879fe5e9ae6d",
        "name": "Present cycle",
        "func": "// ดึงค่าจาก msg.payload.data[0]\nlet rawValue = msg.payload.data[0];\n\n// หาร 10 เพื่อแปลงเป็นค่าทศนิยม\nlet displayValue = rawValue / 10;\n\n// ใส่ค่าใน msg.payload สำหรับแสดงบน dashboard\nmsg.payload = displayValue;\n\nmsg.topic = \"present_cycle\";\n\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 800,
        "y": 2580,
        "wires": [
            [
                "d92be2ee9cfedc4a"
            ]
        ]
    },
    {
        "id": "87148fd6f28d49f2",
        "type": "modbus-read",
        "z": "606aeeb2baf6caa6",
        "g": "e68a879fe5e9ae6d",
        "name": "40003",
        "topic": "",
        "showStatusActivities": false,
        "logIOActivities": false,
        "showErrors": false,
        "showWarnings": true,
        "unitid": "",
        "dataType": "HoldingRegister",
        "adr": "2",
        "quantity": "1",
        "rate": "1",
        "rateUnit": "s",
        "delayOnStart": false,
        "enableDeformedMessages": false,
        "startDelayTime": "",
        "server": "adefb49d68e9f381",
        "useIOFile": false,
        "ioFile": "",
        "useIOForPayload": false,
        "emptyMsgOnFail": false,
        "x": 670,
        "y": 2620,
        "wires": [
            [],
            [
                "bbca8ac7a19de2a2"
            ]
        ]
    },
    {
        "id": "bbca8ac7a19de2a2",
        "type": "function",
        "z": "606aeeb2baf6caa6",
        "g": "e68a879fe5e9ae6d",
        "name": "Last cycle",
        "func": "// ดึงค่าจาก msg.payload.data[0]\nlet rawValue = msg.payload.data[0];\n\n// หาร 10 เพื่อแปลงเป็นค่าทศนิยม\nlet displayValue = rawValue / 10;\n\n// ใส่ค่าใน msg.payload สำหรับแสดงบน dashboard\nmsg.payload = displayValue;\nmsg.topic = \"last_cycle\";\n\n\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 790,
        "y": 2620,
        "wires": [
            [
                "d92be2ee9cfedc4a"
            ]
        ]
    },
    {
        "id": "c61f87f76f35763c",
        "type": "modbus-read",
        "z": "606aeeb2baf6caa6",
        "g": "e68a879fe5e9ae6d",
        "name": "40001",
        "topic": "",
        "showStatusActivities": false,
        "logIOActivities": false,
        "showErrors": false,
        "showWarnings": true,
        "unitid": "",
        "dataType": "HoldingRegister",
        "adr": "0",
        "quantity": "1",
        "rate": "1",
        "rateUnit": "s",
        "delayOnStart": false,
        "enableDeformedMessages": false,
        "startDelayTime": "",
        "server": "adefb49d68e9f381",
        "useIOFile": false,
        "ioFile": "",
        "useIOForPayload": false,
        "emptyMsgOnFail": false,
        "x": 670,
        "y": 2660,
        "wires": [
            [],
            [
                "5ff501f0f729522e"
            ]
        ]
    },
    {
        "id": "5ff501f0f729522e",
        "type": "function",
        "z": "606aeeb2baf6caa6",
        "g": "e68a879fe5e9ae6d",
        "name": "status Mc on",
        "func": "let value = msg.payload.data[0];\n\nif (value === 1) {\n    msg.payload = \"ON\";\n} else if (value === 0) {\n    msg.payload = \"OFF\";\n} else {\n    msg.payload = \"Unknown\";  // กรณีที่ค่าไม่ใช่ 1 หรือ 0\n}\n msg.topic = \"status_mc_on\"; \nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 790,
        "y": 2660,
        "wires": [
            [
                "d92be2ee9cfedc4a"
            ]
        ]
    },
    {
        "id": "837e7cd95bf8f67b",
        "type": "function",
        "z": "606aeeb2baf6caa6",
        "g": "e68a879fe5e9ae6d",
        "name": "CAVITY",
        "func": "// ดึงค่าจาก msg.payload.data[0]\nlet rawValue = msg.payload.data[0];\n\n// หาร 10 เพื่อแปลงเป็นค่าทศนิยม\nlet displayValue = rawValue ;\n\n// ใส่ค่าใน msg.payload สำหรับแสดงบน dashboard\nmsg.payload = displayValue;\nmsg.topic = \"cavity\";\n\n\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 780,
        "y": 2780,
        "wires": [
            [
                "d92be2ee9cfedc4a"
            ]
        ]
    },
    {
        "id": "7fbc58fa65f67d11",
        "type": "modbus-read",
        "z": "606aeeb2baf6caa6",
        "g": "e68a879fe5e9ae6d",
        "name": "40017",
        "topic": "",
        "showStatusActivities": false,
        "logIOActivities": false,
        "showErrors": false,
        "showWarnings": true,
        "unitid": "",
        "dataType": "HoldingRegister",
        "adr": "16",
        "quantity": "1",
        "rate": "1",
        "rateUnit": "s",
        "delayOnStart": false,
        "enableDeformedMessages": false,
        "startDelayTime": "",
        "server": "adefb49d68e9f381",
        "useIOFile": false,
        "ioFile": "",
        "useIOForPayload": false,
        "emptyMsgOnFail": false,
        "x": 670,
        "y": 2820,
        "wires": [
            [],
            [
                "7416772785c3d5fd"
            ]
        ]
    },
    {
        "id": "7416772785c3d5fd",
        "type": "function",
        "z": "606aeeb2baf6caa6",
        "g": "e68a879fe5e9ae6d",
        "name": "STD CYCLE ",
        "func": "// ดึงค่าจาก msg.payload.data[0]\nlet rawValue = msg.payload.data[0];\n\n// หาร 10 เพื่อแปลงเป็นค่าทศนิยม\nlet displayValue = rawValue ;\n\n// ใส่ค่าใน msg.payload สำหรับแสดงบน dashboard\nmsg.payload = displayValue;\nmsg.topic = \"std_cycle\";\n\n\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 790,
        "y": 2820,
        "wires": [
            [
                "d92be2ee9cfedc4a"
            ]
        ]
    },
    {
        "id": "ce1b3ebb43d57960",
        "type": "modbus-read",
        "z": "606aeeb2baf6caa6",
        "g": "e68a879fe5e9ae6d",
        "name": "40016",
        "topic": "",
        "showStatusActivities": false,
        "logIOActivities": false,
        "showErrors": false,
        "showWarnings": true,
        "unitid": "",
        "dataType": "HoldingRegister",
        "adr": "15",
        "quantity": "1",
        "rate": "1",
        "rateUnit": "s",
        "delayOnStart": false,
        "enableDeformedMessages": false,
        "startDelayTime": "",
        "server": "adefb49d68e9f381",
        "useIOFile": false,
        "ioFile": "",
        "useIOForPayload": false,
        "emptyMsgOnFail": false,
        "x": 670,
        "y": 2780,
        "wires": [
            [],
            [
                "837e7cd95bf8f67b"
            ]
        ]
    },
    {
        "id": "d92be2ee9cfedc4a",
        "type": "join",
        "z": "606aeeb2baf6caa6",
        "g": "e68a879fe5e9ae6d",
        "name": "รวมข้อมูล (Join)",
        "mode": "custom",
        "build": "object",
        "property": "payload",
        "propertyType": "msg",
        "key": "topic",
        "joiner": "\\n",
        "joinerType": "str",
        "useparts": true,
        "accumulate": true,
        "timeout": "15",
        "count": "7",
        "reduceRight": false,
        "reduceExp": "",
        "reduceInit": "",
        "reduceInitType": "",
        "reduceFixup": "",
        "x": 1030,
        "y": 2700,
        "wires": [
            [
                "768967e0834011ba"
            ]
        ]
    },
    {
        "id": "768967e0834011ba",
        "type": "function",
        "z": "606aeeb2baf6caa6",
        "g": "e68a879fe5e9ae6d",
        "name": "เช็คความครบ",
        "func": "// รายชื่อหัวข้อข้อมูลที่ต้องมีให้ครบ 7 ตัว\nvar requiredKeys = [\n    \"present_cycle\", \n    \"last_cycle\", \n    \"cavity\", \n    \"std_cycle\", \n    \"status_mc_on\", \n    \"model\", \n    \"total_pcs\"\n];\n\n// ดึงคีย์ที่มีอยู่ใน msg.payload ตอนนี้\nvar currentKeys = Object.keys(msg.payload);\n\n// เช็คว่าขาดตัวไหนไปบ้าง\nvar missing = requiredKeys.filter(function(key) {\n    return !currentKeys.includes(key);\n});\n\n// ถ้ามีตัวที่ขาด (missing > 0)\nif (missing.length > 0) {\n    // บันทึก Log ว่าขาดอะไร (ดูใน Debug)\n    node.warn(\"ข้อมูลไม่ครบ! ขาด: \" + missing.join(\", \"));\n    return null; // *** หยุดการส่งข้อมูลทันที ไม่ไปต่อ ***\n}\n\n// ถ้าครบถ้วน ให้ไปต่อ\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1250,
        "y": 2700,
        "wires": [
            [
                "fcaab97bf76ca7f3"
            ]
        ]
    },
    {
        "id": "fcaab97bf76ca7f3",
        "type": "function",
        "z": "606aeeb2baf6caa6",
        "g": "e68a879fe5e9ae6d",
        "name": "ตั้งค่า Data & Save Global V2",
        "func": "// 1. --- ตั้งค่า Config ---\nvar mySheetID = \"1RJ9OI8Bz8Xy_7HW7fZVQnjeYshDd0BZUZrkG3ycJfy0\"; // ใส่ ID Sheet\nvar machineID = 8;\nvar machineName = \"1200-8\"; // <--- ชื่อที่จะไปโชว์ใน Excel ช่อง B\n\n// รับข้อมูลรวมจาก Join\nvar data = msg.payload;\nvar now = new Date().toLocaleString(\"th-TH\", { timeZone: \"Asia/Bangkok\" });\n\n// 2. --- อัปเดตข้อมูลสำหรับ React (Global Variable) ---\nvar reactData = {\n    id: machineID,\n    name: machineName,\n    machine_no: machineName,\n    status: (data.status_mc_on == 1) ? 1 : 0,\n    present_cycle: parseFloat(data.present_cycle || 0),\n    last_cycle: parseFloat(data.last_cycle || 0),\n    std_cycle: parseFloat(data.std_cycle || 0),\n    \n    // *** แก้ตรงนี้ด้วยนิดนึงครับ ***\n    // Model มักเป็นตัวหนังสือ (เช่น HC00443E) ห้ามใช้ parseFloat ไม่งั้นค่าจะเพี้ยนเป็น NaN หรือ 0\n    model: data.model || \"-\", \n    \n    cavity: parseFloat(data.cavity || 0),\n    total_pcs: parseFloat(data.total_pcs || 0),\n    timestamp: now\n};\n\n// เก็บลงตัวแปรกลาง\nvar allMachines = global.get(\"machineData\") || [];\nvar idx = allMachines.findIndex(m => m.id === machineID);\nif (idx !== -1) allMachines[idx] = Object.assign(allMachines[idx], reactData);\nelse allMachines.push(reactData);\nglobal.set(\"machineData\", allMachines);\n\n// 3. --- เตรียมข้อมูลส่ง Google Sheet ---\ndata.spreadsheetId = mySheetID;\ndata.timestamp = now;\n\n// >>> เติมบรรทัดนี้ครับ เพื่อให้ Google Sheet รู้จักชื่อเครื่อง <<<\ndata.machine_no = machineName; \n\nmsg.payload = data;\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1480,
        "y": 2700,
        "wires": [
            [
                "03c12b3e612c6a24"
            ]
        ]
    },
    {
        "id": "03c12b3e612c6a24",
        "type": "link out",
        "z": "606aeeb2baf6caa6",
        "g": "e68a879fe5e9ae6d",
        "name": "IN 8",
        "mode": "link",
        "links": [
            "fdcd0c85287c426f"
        ],
        "x": 1645,
        "y": 2700,
        "wires": []
    },
    {
        "id": "adefb49d68e9f381",
        "type": "modbus-client",
        "name": "1200-8",
        "clienttype": "tcp",
        "bufferCommands": true,
        "stateLogEnabled": false,
        "queueLogEnabled": false,
        "failureLogEnabled": true,
        "tcpHost": "192.168.7.132",
        "tcpPort": 502,
        "tcpType": "DEFAULT",
        "serialPort": "/dev/ttyUSB",
        "serialType": "RTU-BUFFERD",
        "serialBaudrate": 9600,
        "serialDatabits": 8,
        "serialStopbits": 1,
        "serialParity": "none",
        "serialConnectionDelay": 100,
        "serialAsciiResponseStartDelimiter": "0x3A",
        "unit_id": 8,
        "commandDelay": 1,
        "clientTimeout": 1000,
        "reconnectOnTimeout": true,
        "reconnectTimeout": 2000,
        "parallelUnitIdsAllowed": true,
        "showErrors": false,
        "showWarnings": true,
        "showLogs": true
    },
    {
        "id": "3d43d3b42da87cb8",
        "type": "group",
        "z": "606aeeb2baf6caa6",
        "g": "7351bc4077f8b06d",
        "style": {
            "stroke": "#999999",
            "stroke-opacity": "1",
            "fill": "none",
            "fill-opacity": "1",
            "label": true,
            "label-position": "nw",
            "color": "#a4a4a4"
        },
        "nodes": [
            "1b57715990419981",
            "f88efebb4c3c6bcf",
            "d40985c02cf87228",
            "ed853348cf3d7ee7",
            "3a2bd32cd88296bf",
            "04dadfd22f56f95b",
            "f3cdb0fc5b77408d",
            "5943539f14d5ecce",
            "4584c079b4450d63",
            "725ac25704b570e5",
            "1aaa0fd681b9bf8c",
            "977ca57f4bda0202",
            "bd85090fe55aebd3",
            "b8653192e260990d",
            "eea111a37489605c",
            "172d5be148548f12",
            "cdb1a6d4eb39aa94"
        ],
        "x": 574,
        "y": 2879,
        "w": 1112,
        "h": 322
    },
    {
        "id": "1b57715990419981",
        "type": "function",
        "z": "606aeeb2baf6caa6",
        "g": "3d43d3b42da87cb8",
        "name": "Model",
        "func": "\nif (Array.isArray(msg.payload)) {\n    var match = msg.payload.find(item => item.machine === \"1300/3\");\n    if (match) {\n        msg.payload = match.detail_g; \n        msg.topic = \"model\"; \n        return msg;\n    }\n}\n\nreturn null;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 770,
        "y": 3040,
        "wires": [
            [
                "b8653192e260990d"
            ]
        ]
    },
    {
        "id": "f88efebb4c3c6bcf",
        "type": "function",
        "z": "606aeeb2baf6caa6",
        "g": "3d43d3b42da87cb8",
        "name": "Total Pcs.",
        "func": "// 1. ตรวจสอบก่อนว่าเป็น Array (รายการ) หรือไม่ เพื่อกัน Error\nif (!Array.isArray(msg.payload)) {\n    // ถ้าไม่ใช่ List รายการ ให้ข้ามไป\n    return null; \n}\n\n// 2. ค้นหาเครื่องจักรชื่อ \"1200/1\" (แก้ชื่อตรงนี้ได้ตามจริง)\nvar match = msg.payload.find(item => item.machine === \"1300/3\");\n\nif (match) {\n    // 3. ดึงค่าผลรวม Z มาใส่ payload\n    msg.payload = match.detail_z; \n\n    // 4. --- กำหนดชื่อหัวข้อ (สำคัญมาก) ---\n    // เพื่อให้ Join Node รู้ว่าค่านี่คือ \"detail_z\"\n    msg.topic = \"total_pcs\"; \n\n    return msg;\n}\n\n// ถ้าหาไม่เจอ ให้คืนค่า null\nreturn null;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 780,
        "y": 3080,
        "wires": [
            [
                "b8653192e260990d"
            ]
        ]
    },
    {
        "id": "d40985c02cf87228",
        "type": "comment",
        "z": "606aeeb2baf6caa6",
        "g": "3d43d3b42da87cb8",
        "name": "9",
        "info": "",
        "x": 1030,
        "y": 2940,
        "wires": []
    },
    {
        "id": "ed853348cf3d7ee7",
        "type": "modbus-read",
        "z": "606aeeb2baf6caa6",
        "g": "3d43d3b42da87cb8",
        "name": "40002",
        "topic": "",
        "showStatusActivities": false,
        "logIOActivities": false,
        "showErrors": false,
        "showWarnings": true,
        "unitid": "",
        "dataType": "HoldingRegister",
        "adr": "1",
        "quantity": "1",
        "rate": "1",
        "rateUnit": "s",
        "delayOnStart": false,
        "enableDeformedMessages": false,
        "startDelayTime": "",
        "server": "b82c6b6ec5cf40c0",
        "useIOFile": false,
        "ioFile": "",
        "useIOForPayload": false,
        "emptyMsgOnFail": false,
        "x": 670,
        "y": 2920,
        "wires": [
            [],
            [
                "3a2bd32cd88296bf"
            ]
        ]
    },
    {
        "id": "3a2bd32cd88296bf",
        "type": "function",
        "z": "606aeeb2baf6caa6",
        "g": "3d43d3b42da87cb8",
        "name": "Present cycle",
        "func": "// ดึงค่าจาก msg.payload.data[0]\nlet rawValue = msg.payload.data[0];\n\n// หาร 10 เพื่อแปลงเป็นค่าทศนิยม\nlet displayValue = rawValue / 10;\n\n// ใส่ค่าใน msg.payload สำหรับแสดงบน dashboard\nmsg.payload = displayValue;\n\nmsg.topic = \"present_cycle\";\n\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 800,
        "y": 2920,
        "wires": [
            [
                "b8653192e260990d"
            ]
        ]
    },
    {
        "id": "04dadfd22f56f95b",
        "type": "modbus-read",
        "z": "606aeeb2baf6caa6",
        "g": "3d43d3b42da87cb8",
        "name": "40003",
        "topic": "",
        "showStatusActivities": false,
        "logIOActivities": false,
        "showErrors": false,
        "showWarnings": true,
        "unitid": "",
        "dataType": "HoldingRegister",
        "adr": "2",
        "quantity": "1",
        "rate": "1",
        "rateUnit": "s",
        "delayOnStart": false,
        "enableDeformedMessages": false,
        "startDelayTime": "",
        "server": "b82c6b6ec5cf40c0",
        "useIOFile": false,
        "ioFile": "",
        "useIOForPayload": false,
        "emptyMsgOnFail": false,
        "x": 670,
        "y": 2960,
        "wires": [
            [],
            [
                "f3cdb0fc5b77408d"
            ]
        ]
    },
    {
        "id": "f3cdb0fc5b77408d",
        "type": "function",
        "z": "606aeeb2baf6caa6",
        "g": "3d43d3b42da87cb8",
        "name": "Last cycle",
        "func": "// ดึงค่าจาก msg.payload.data[0]\nlet rawValue = msg.payload.data[0];\n\n// หาร 10 เพื่อแปลงเป็นค่าทศนิยม\nlet displayValue = rawValue / 10;\n\n// ใส่ค่าใน msg.payload สำหรับแสดงบน dashboard\nmsg.payload = displayValue;\nmsg.topic = \"last_cycle\";\n\n\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 790,
        "y": 2960,
        "wires": [
            [
                "b8653192e260990d"
            ]
        ]
    },
    {
        "id": "5943539f14d5ecce",
        "type": "modbus-read",
        "z": "606aeeb2baf6caa6",
        "g": "3d43d3b42da87cb8",
        "name": "40001",
        "topic": "",
        "showStatusActivities": false,
        "logIOActivities": false,
        "showErrors": false,
        "showWarnings": true,
        "unitid": "",
        "dataType": "HoldingRegister",
        "adr": "0",
        "quantity": "1",
        "rate": "1",
        "rateUnit": "s",
        "delayOnStart": false,
        "enableDeformedMessages": false,
        "startDelayTime": "",
        "server": "b82c6b6ec5cf40c0",
        "useIOFile": false,
        "ioFile": "",
        "useIOForPayload": false,
        "emptyMsgOnFail": false,
        "x": 670,
        "y": 3000,
        "wires": [
            [],
            [
                "4584c079b4450d63"
            ]
        ]
    },
    {
        "id": "4584c079b4450d63",
        "type": "function",
        "z": "606aeeb2baf6caa6",
        "g": "3d43d3b42da87cb8",
        "name": "status Mc on",
        "func": "let value = msg.payload.data[0];\n\nif (value === 1) {\n    msg.payload = \"ON\";\n} else if (value === 0) {\n    msg.payload = \"OFF\";\n} else {\n    msg.payload = \"Unknown\";  // กรณีที่ค่าไม่ใช่ 1 หรือ 0\n}\n msg.topic = \"status_mc_on\"; \nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 790,
        "y": 3000,
        "wires": [
            [
                "b8653192e260990d"
            ]
        ]
    },
    {
        "id": "725ac25704b570e5",
        "type": "function",
        "z": "606aeeb2baf6caa6",
        "g": "3d43d3b42da87cb8",
        "name": "CAVITY",
        "func": "// ดึงค่าจาก msg.payload.data[0]\nlet rawValue = msg.payload.data[0];\n\n// หาร 10 เพื่อแปลงเป็นค่าทศนิยม\nlet displayValue = rawValue ;\n\n// ใส่ค่าใน msg.payload สำหรับแสดงบน dashboard\nmsg.payload = displayValue;\nmsg.topic = \"cavity\";\n\n\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 780,
        "y": 3120,
        "wires": [
            [
                "b8653192e260990d"
            ]
        ]
    },
    {
        "id": "1aaa0fd681b9bf8c",
        "type": "modbus-read",
        "z": "606aeeb2baf6caa6",
        "g": "3d43d3b42da87cb8",
        "name": "40017",
        "topic": "",
        "showStatusActivities": false,
        "logIOActivities": false,
        "showErrors": false,
        "showWarnings": true,
        "unitid": "",
        "dataType": "HoldingRegister",
        "adr": "16",
        "quantity": "1",
        "rate": "1",
        "rateUnit": "s",
        "delayOnStart": false,
        "enableDeformedMessages": false,
        "startDelayTime": "",
        "server": "b82c6b6ec5cf40c0",
        "useIOFile": false,
        "ioFile": "",
        "useIOForPayload": false,
        "emptyMsgOnFail": false,
        "x": 670,
        "y": 3160,
        "wires": [
            [],
            [
                "977ca57f4bda0202"
            ]
        ]
    },
    {
        "id": "977ca57f4bda0202",
        "type": "function",
        "z": "606aeeb2baf6caa6",
        "g": "3d43d3b42da87cb8",
        "name": "STD CYCLE ",
        "func": "// ดึงค่าจาก msg.payload.data[0]\nlet rawValue = msg.payload.data[0];\n\n// หาร 10 เพื่อแปลงเป็นค่าทศนิยม\nlet displayValue = rawValue ;\n\n// ใส่ค่าใน msg.payload สำหรับแสดงบน dashboard\nmsg.payload = displayValue;\nmsg.topic = \"std_cycle\";\n\n\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 790,
        "y": 3160,
        "wires": [
            [
                "b8653192e260990d"
            ]
        ]
    },
    {
        "id": "bd85090fe55aebd3",
        "type": "modbus-read",
        "z": "606aeeb2baf6caa6",
        "g": "3d43d3b42da87cb8",
        "name": "40016",
        "topic": "",
        "showStatusActivities": false,
        "logIOActivities": false,
        "showErrors": false,
        "showWarnings": true,
        "unitid": "",
        "dataType": "HoldingRegister",
        "adr": "15",
        "quantity": "1",
        "rate": "1",
        "rateUnit": "s",
        "delayOnStart": false,
        "enableDeformedMessages": false,
        "startDelayTime": "",
        "server": "b82c6b6ec5cf40c0",
        "useIOFile": false,
        "ioFile": "",
        "useIOForPayload": false,
        "emptyMsgOnFail": false,
        "x": 670,
        "y": 3120,
        "wires": [
            [],
            [
                "725ac25704b570e5"
            ]
        ]
    },
    {
        "id": "b8653192e260990d",
        "type": "join",
        "z": "606aeeb2baf6caa6",
        "g": "3d43d3b42da87cb8",
        "name": "รวมข้อมูล (Join)",
        "mode": "custom",
        "build": "object",
        "property": "payload",
        "propertyType": "msg",
        "key": "topic",
        "joiner": "\\n",
        "joinerType": "str",
        "useparts": true,
        "accumulate": true,
        "timeout": "15",
        "count": "7",
        "reduceRight": false,
        "reduceExp": "",
        "reduceInit": "",
        "reduceInitType": "",
        "reduceFixup": "",
        "x": 1030,
        "y": 3040,
        "wires": [
            [
                "eea111a37489605c"
            ]
        ]
    },
    {
        "id": "eea111a37489605c",
        "type": "function",
        "z": "606aeeb2baf6caa6",
        "g": "3d43d3b42da87cb8",
        "name": "เช็คความครบ",
        "func": "// รายชื่อหัวข้อข้อมูลที่ต้องมีให้ครบ 7 ตัว\nvar requiredKeys = [\n    \"present_cycle\", \n    \"last_cycle\", \n    \"cavity\", \n    \"std_cycle\", \n    \"status_mc_on\", \n    \"model\", \n    \"total_pcs\"\n];\n\n// ดึงคีย์ที่มีอยู่ใน msg.payload ตอนนี้\nvar currentKeys = Object.keys(msg.payload);\n\n// เช็คว่าขาดตัวไหนไปบ้าง\nvar missing = requiredKeys.filter(function(key) {\n    return !currentKeys.includes(key);\n});\n\n// ถ้ามีตัวที่ขาด (missing > 0)\nif (missing.length > 0) {\n    // บันทึก Log ว่าขาดอะไร (ดูใน Debug)\n    node.warn(\"ข้อมูลไม่ครบ! ขาด: \" + missing.join(\", \"));\n    return null; // *** หยุดการส่งข้อมูลทันที ไม่ไปต่อ ***\n}\n\n// ถ้าครบถ้วน ให้ไปต่อ\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1250,
        "y": 3040,
        "wires": [
            [
                "172d5be148548f12"
            ]
        ]
    },
    {
        "id": "172d5be148548f12",
        "type": "function",
        "z": "606aeeb2baf6caa6",
        "g": "3d43d3b42da87cb8",
        "name": "ตั้งค่า Data & Save Global V2",
        "func": "// 1. --- ตั้งค่า Config ---\nvar mySheetID = \"1RJ9OI8Bz8Xy_7HW7fZVQnjeYshDd0BZUZrkG3ycJfy0\"; // ใส่ ID Sheet\nvar machineID = 9;\nvar machineName = \"1200-9\"; // <--- ชื่อที่จะไปโชว์ใน Excel ช่อง B\n\n// รับข้อมูลรวมจาก Join\nvar data = msg.payload;\nvar now = new Date().toLocaleString(\"th-TH\", { timeZone: \"Asia/Bangkok\" });\n\n// 2. --- อัปเดตข้อมูลสำหรับ React (Global Variable) ---\nvar reactData = {\n    id: machineID,\n    name: machineName,\n    machine_no: machineName,\n    status: (data.status_mc_on == 1) ? 1 : 0,\n    present_cycle: parseFloat(data.present_cycle || 0),\n    last_cycle: parseFloat(data.last_cycle || 0),\n    std_cycle: parseFloat(data.std_cycle || 0),\n    \n    // *** แก้ตรงนี้ด้วยนิดนึงครับ ***\n    // Model มักเป็นตัวหนังสือ (เช่น HC00443E) ห้ามใช้ parseFloat ไม่งั้นค่าจะเพี้ยนเป็น NaN หรือ 0\n    model: data.model || \"-\", \n    \n    cavity: parseFloat(data.cavity || 0),\n    total_pcs: parseFloat(data.total_pcs || 0),\n    timestamp: now\n};\n\n// เก็บลงตัวแปรกลาง\nvar allMachines = global.get(\"machineData\") || [];\nvar idx = allMachines.findIndex(m => m.id === machineID);\nif (idx !== -1) allMachines[idx] = Object.assign(allMachines[idx], reactData);\nelse allMachines.push(reactData);\nglobal.set(\"machineData\", allMachines);\n\n// 3. --- เตรียมข้อมูลส่ง Google Sheet ---\ndata.spreadsheetId = mySheetID;\ndata.timestamp = now;\n\n// >>> เติมบรรทัดนี้ครับ เพื่อให้ Google Sheet รู้จักชื่อเครื่อง <<<\ndata.machine_no = machineName; \n\nmsg.payload = data;\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1480,
        "y": 3040,
        "wires": [
            [
                "cdb1a6d4eb39aa94"
            ]
        ]
    },
    {
        "id": "cdb1a6d4eb39aa94",
        "type": "link out",
        "z": "606aeeb2baf6caa6",
        "g": "3d43d3b42da87cb8",
        "name": "IN 9",
        "mode": "link",
        "links": [
            "4745b480c5d40a69"
        ],
        "x": 1645,
        "y": 3040,
        "wires": []
    },
    {
        "id": "b82c6b6ec5cf40c0",
        "type": "modbus-client",
        "name": "1200-9",
        "clienttype": "tcp",
        "bufferCommands": true,
        "stateLogEnabled": false,
        "queueLogEnabled": false,
        "failureLogEnabled": true,
        "tcpHost": "192.168.7.134",
        "tcpPort": 502,
        "tcpType": "DEFAULT",
        "serialPort": "/dev/ttyUSB",
        "serialType": "RTU-BUFFERD",
        "serialBaudrate": 9600,
        "serialDatabits": 8,
        "serialStopbits": 1,
        "serialParity": "none",
        "serialConnectionDelay": 100,
        "serialAsciiResponseStartDelimiter": "0x3A",
        "unit_id": 9,
        "commandDelay": 1,
        "clientTimeout": 1000,
        "reconnectOnTimeout": true,
        "reconnectTimeout": 2000,
        "parallelUnitIdsAllowed": true,
        "showErrors": false,
        "showWarnings": true,
        "showLogs": true
    },
    {
        "id": "fe2aabeba7061bf6",
        "type": "group",
        "z": "606aeeb2baf6caa6",
        "g": "7351bc4077f8b06d",
        "style": {
            "stroke": "#999999",
            "stroke-opacity": "1",
            "fill": "none",
            "fill-opacity": "1",
            "label": true,
            "label-position": "nw",
            "color": "#a4a4a4"
        },
        "nodes": [
            "6fcb4da034500bd9",
            "3ca85b805ff3508f",
            "5428ab239b1bccc6",
            "66a8a4d35e8941ad",
            "0c6a4a4735c35f39",
            "71faa2079c35f37a",
            "d5736e1fe6137e84",
            "c6b5fe670b081db6",
            "b487953fb201a99f",
            "6171ff741d19b8f8",
            "d6390e3cd928602e",
            "911d2f900763e607",
            "cbaa8f23c302ba16",
            "0d786645b9a5aeba",
            "5ebe41f987dea4bc",
            "b6b9d0c4649e3b01",
            "8f3e8388797e3ed5"
        ],
        "x": 574,
        "y": 3219,
        "w": 1102,
        "h": 322
    },
    {
        "id": "6fcb4da034500bd9",
        "type": "function",
        "z": "606aeeb2baf6caa6",
        "g": "fe2aabeba7061bf6",
        "name": "Model",
        "func": "\nif (Array.isArray(msg.payload)) {\n    var match = msg.payload.find(item => item.machine === \"1300/3\");\n    if (match) {\n        msg.payload = match.detail_g; \n        msg.topic = \"model\"; \n        return msg;\n    }\n}\n\nreturn null;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 770,
        "y": 3380,
        "wires": [
            [
                "0d786645b9a5aeba"
            ]
        ]
    },
    {
        "id": "3ca85b805ff3508f",
        "type": "function",
        "z": "606aeeb2baf6caa6",
        "g": "fe2aabeba7061bf6",
        "name": "Total Pcs.",
        "func": "// 1. ตรวจสอบก่อนว่าเป็น Array (รายการ) หรือไม่ เพื่อกัน Error\nif (!Array.isArray(msg.payload)) {\n    // ถ้าไม่ใช่ List รายการ ให้ข้ามไป\n    return null; \n}\n\n// 2. ค้นหาเครื่องจักรชื่อ \"1200/1\" (แก้ชื่อตรงนี้ได้ตามจริง)\nvar match = msg.payload.find(item => item.machine === \"1300/3\");\n\nif (match) {\n    // 3. ดึงค่าผลรวม Z มาใส่ payload\n    msg.payload = match.detail_z; \n\n    // 4. --- กำหนดชื่อหัวข้อ (สำคัญมาก) ---\n    // เพื่อให้ Join Node รู้ว่าค่านี่คือ \"detail_z\"\n    msg.topic = \"total_pcs\"; \n\n    return msg;\n}\n\n// ถ้าหาไม่เจอ ให้คืนค่า null\nreturn null;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 780,
        "y": 3420,
        "wires": [
            [
                "0d786645b9a5aeba"
            ]
        ]
    },
    {
        "id": "5428ab239b1bccc6",
        "type": "comment",
        "z": "606aeeb2baf6caa6",
        "g": "fe2aabeba7061bf6",
        "name": "10",
        "info": "",
        "x": 1030,
        "y": 3280,
        "wires": []
    },
    {
        "id": "66a8a4d35e8941ad",
        "type": "modbus-read",
        "z": "606aeeb2baf6caa6",
        "g": "fe2aabeba7061bf6",
        "name": "40002",
        "topic": "",
        "showStatusActivities": false,
        "logIOActivities": false,
        "showErrors": false,
        "showWarnings": true,
        "unitid": "",
        "dataType": "HoldingRegister",
        "adr": "1",
        "quantity": "1",
        "rate": "1",
        "rateUnit": "s",
        "delayOnStart": false,
        "enableDeformedMessages": false,
        "startDelayTime": "",
        "server": "c8c353803784f5e3",
        "useIOFile": false,
        "ioFile": "",
        "useIOForPayload": false,
        "emptyMsgOnFail": false,
        "x": 670,
        "y": 3260,
        "wires": [
            [],
            [
                "0c6a4a4735c35f39"
            ]
        ]
    },
    {
        "id": "0c6a4a4735c35f39",
        "type": "function",
        "z": "606aeeb2baf6caa6",
        "g": "fe2aabeba7061bf6",
        "name": "Present cycle",
        "func": "// ดึงค่าจาก msg.payload.data[0]\nlet rawValue = msg.payload.data[0];\n\n// หาร 10 เพื่อแปลงเป็นค่าทศนิยม\nlet displayValue = rawValue / 10;\n\n// ใส่ค่าใน msg.payload สำหรับแสดงบน dashboard\nmsg.payload = displayValue;\n\nmsg.topic = \"present_cycle\";\n\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 800,
        "y": 3260,
        "wires": [
            [
                "0d786645b9a5aeba"
            ]
        ]
    },
    {
        "id": "71faa2079c35f37a",
        "type": "modbus-read",
        "z": "606aeeb2baf6caa6",
        "g": "fe2aabeba7061bf6",
        "name": "40003",
        "topic": "",
        "showStatusActivities": false,
        "logIOActivities": false,
        "showErrors": false,
        "showWarnings": true,
        "unitid": "",
        "dataType": "HoldingRegister",
        "adr": "2",
        "quantity": "1",
        "rate": "1",
        "rateUnit": "s",
        "delayOnStart": false,
        "enableDeformedMessages": false,
        "startDelayTime": "",
        "server": "c8c353803784f5e3",
        "useIOFile": false,
        "ioFile": "",
        "useIOForPayload": false,
        "emptyMsgOnFail": false,
        "x": 670,
        "y": 3300,
        "wires": [
            [],
            [
                "d5736e1fe6137e84"
            ]
        ]
    },
    {
        "id": "d5736e1fe6137e84",
        "type": "function",
        "z": "606aeeb2baf6caa6",
        "g": "fe2aabeba7061bf6",
        "name": "Last cycle",
        "func": "// ดึงค่าจาก msg.payload.data[0]\nlet rawValue = msg.payload.data[0];\n\n// หาร 10 เพื่อแปลงเป็นค่าทศนิยม\nlet displayValue = rawValue / 10;\n\n// ใส่ค่าใน msg.payload สำหรับแสดงบน dashboard\nmsg.payload = displayValue;\nmsg.topic = \"last_cycle\";\n\n\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 790,
        "y": 3300,
        "wires": [
            [
                "0d786645b9a5aeba"
            ]
        ]
    },
    {
        "id": "c6b5fe670b081db6",
        "type": "modbus-read",
        "z": "606aeeb2baf6caa6",
        "g": "fe2aabeba7061bf6",
        "name": "40001",
        "topic": "",
        "showStatusActivities": false,
        "logIOActivities": false,
        "showErrors": false,
        "showWarnings": true,
        "unitid": "",
        "dataType": "HoldingRegister",
        "adr": "0",
        "quantity": "1",
        "rate": "1",
        "rateUnit": "s",
        "delayOnStart": false,
        "enableDeformedMessages": false,
        "startDelayTime": "",
        "server": "c8c353803784f5e3",
        "useIOFile": false,
        "ioFile": "",
        "useIOForPayload": false,
        "emptyMsgOnFail": false,
        "x": 670,
        "y": 3340,
        "wires": [
            [],
            [
                "b487953fb201a99f"
            ]
        ]
    },
    {
        "id": "b487953fb201a99f",
        "type": "function",
        "z": "606aeeb2baf6caa6",
        "g": "fe2aabeba7061bf6",
        "name": "status Mc on",
        "func": "let value = msg.payload.data[0];\n\nif (value === 1) {\n    msg.payload = \"ON\";\n} else if (value === 0) {\n    msg.payload = \"OFF\";\n} else {\n    msg.payload = \"Unknown\";  // กรณีที่ค่าไม่ใช่ 1 หรือ 0\n}\n msg.topic = \"status_mc_on\"; \nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 790,
        "y": 3340,
        "wires": [
            [
                "0d786645b9a5aeba"
            ]
        ]
    },
    {
        "id": "6171ff741d19b8f8",
        "type": "function",
        "z": "606aeeb2baf6caa6",
        "g": "fe2aabeba7061bf6",
        "name": "CAVITY",
        "func": "// ดึงค่าจาก msg.payload.data[0]\nlet rawValue = msg.payload.data[0];\n\n// หาร 10 เพื่อแปลงเป็นค่าทศนิยม\nlet displayValue = rawValue ;\n\n// ใส่ค่าใน msg.payload สำหรับแสดงบน dashboard\nmsg.payload = displayValue;\nmsg.topic = \"cavity\";\n\n\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 780,
        "y": 3460,
        "wires": [
            [
                "0d786645b9a5aeba"
            ]
        ]
    },
    {
        "id": "d6390e3cd928602e",
        "type": "modbus-read",
        "z": "606aeeb2baf6caa6",
        "g": "fe2aabeba7061bf6",
        "name": "40017",
        "topic": "",
        "showStatusActivities": false,
        "logIOActivities": false,
        "showErrors": false,
        "showWarnings": true,
        "unitid": "",
        "dataType": "HoldingRegister",
        "adr": "16",
        "quantity": "1",
        "rate": "1",
        "rateUnit": "s",
        "delayOnStart": false,
        "enableDeformedMessages": false,
        "startDelayTime": "",
        "server": "c8c353803784f5e3",
        "useIOFile": false,
        "ioFile": "",
        "useIOForPayload": false,
        "emptyMsgOnFail": false,
        "x": 670,
        "y": 3500,
        "wires": [
            [],
            [
                "911d2f900763e607"
            ]
        ]
    },
    {
        "id": "911d2f900763e607",
        "type": "function",
        "z": "606aeeb2baf6caa6",
        "g": "fe2aabeba7061bf6",
        "name": "STD CYCLE ",
        "func": "// ดึงค่าจาก msg.payload.data[0]\nlet rawValue = msg.payload.data[0];\n\n// หาร 10 เพื่อแปลงเป็นค่าทศนิยม\nlet displayValue = rawValue ;\n\n// ใส่ค่าใน msg.payload สำหรับแสดงบน dashboard\nmsg.payload = displayValue;\nmsg.topic = \"std_cycle\";\n\n\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 790,
        "y": 3500,
        "wires": [
            [
                "0d786645b9a5aeba"
            ]
        ]
    },
    {
        "id": "cbaa8f23c302ba16",
        "type": "modbus-read",
        "z": "606aeeb2baf6caa6",
        "g": "fe2aabeba7061bf6",
        "name": "40016",
        "topic": "",
        "showStatusActivities": false,
        "logIOActivities": false,
        "showErrors": false,
        "showWarnings": true,
        "unitid": "",
        "dataType": "HoldingRegister",
        "adr": "15",
        "quantity": "1",
        "rate": "1",
        "rateUnit": "s",
        "delayOnStart": false,
        "enableDeformedMessages": false,
        "startDelayTime": "",
        "server": "c8c353803784f5e3",
        "useIOFile": false,
        "ioFile": "",
        "useIOForPayload": false,
        "emptyMsgOnFail": false,
        "x": 670,
        "y": 3460,
        "wires": [
            [],
            [
                "6171ff741d19b8f8"
            ]
        ]
    },
    {
        "id": "0d786645b9a5aeba",
        "type": "join",
        "z": "606aeeb2baf6caa6",
        "g": "fe2aabeba7061bf6",
        "name": "รวมข้อมูล (Join)",
        "mode": "custom",
        "build": "object",
        "property": "payload",
        "propertyType": "msg",
        "key": "topic",
        "joiner": "\\n",
        "joinerType": "str",
        "useparts": true,
        "accumulate": true,
        "timeout": "15",
        "count": "7",
        "reduceRight": false,
        "reduceExp": "",
        "reduceInit": "",
        "reduceInitType": "",
        "reduceFixup": "",
        "x": 1030,
        "y": 3380,
        "wires": [
            [
                "5ebe41f987dea4bc"
            ]
        ]
    },
    {
        "id": "5ebe41f987dea4bc",
        "type": "function",
        "z": "606aeeb2baf6caa6",
        "g": "fe2aabeba7061bf6",
        "name": "เช็คความครบ",
        "func": "// รายชื่อหัวข้อข้อมูลที่ต้องมีให้ครบ 7 ตัว\nvar requiredKeys = [\n    \"present_cycle\", \n    \"last_cycle\", \n    \"cavity\", \n    \"std_cycle\", \n    \"status_mc_on\", \n    \"model\", \n    \"total_pcs\"\n];\n\n// ดึงคีย์ที่มีอยู่ใน msg.payload ตอนนี้\nvar currentKeys = Object.keys(msg.payload);\n\n// เช็คว่าขาดตัวไหนไปบ้าง\nvar missing = requiredKeys.filter(function(key) {\n    return !currentKeys.includes(key);\n});\n\n// ถ้ามีตัวที่ขาด (missing > 0)\nif (missing.length > 0) {\n    // บันทึก Log ว่าขาดอะไร (ดูใน Debug)\n    node.warn(\"ข้อมูลไม่ครบ! ขาด: \" + missing.join(\", \"));\n    return null; // *** หยุดการส่งข้อมูลทันที ไม่ไปต่อ ***\n}\n\n// ถ้าครบถ้วน ให้ไปต่อ\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1250,
        "y": 3380,
        "wires": [
            [
                "b6b9d0c4649e3b01"
            ]
        ]
    },
    {
        "id": "b6b9d0c4649e3b01",
        "type": "function",
        "z": "606aeeb2baf6caa6",
        "g": "fe2aabeba7061bf6",
        "name": "ตั้งค่า Data & Save Global V2",
        "func": "// 1. --- ตั้งค่า Config ---\nvar mySheetID = \"1RJ9OI8Bz8Xy_7HW7fZVQnjeYshDd0BZUZrkG3ycJfy0\"; // ใส่ ID Sheet\nvar machineID = 10;\nvar machineName = \"1300-10\"; // <--- ชื่อที่จะไปโชว์ใน Excel ช่อง B\n\n// รับข้อมูลรวมจาก Join\nvar data = msg.payload;\nvar now = new Date().toLocaleString(\"th-TH\", { timeZone: \"Asia/Bangkok\" });\n\n// 2. --- อัปเดตข้อมูลสำหรับ React (Global Variable) ---\nvar reactData = {\n    id: machineID,\n    name: machineName,\n    machine_no: machineName,\n    status: (data.status_mc_on == 1) ? 1 : 0,\n    present_cycle: parseFloat(data.present_cycle || 0),\n    last_cycle: parseFloat(data.last_cycle || 0),\n    std_cycle: parseFloat(data.std_cycle || 0),\n    \n    // *** แก้ตรงนี้ด้วยนิดนึงครับ ***\n    // Model มักเป็นตัวหนังสือ (เช่น HC00443E) ห้ามใช้ parseFloat ไม่งั้นค่าจะเพี้ยนเป็น NaN หรือ 0\n    model: data.model || \"-\", \n    \n    cavity: parseFloat(data.cavity || 0),\n    total_pcs: parseFloat(data.total_pcs || 0),\n    timestamp: now\n};\n\n// เก็บลงตัวแปรกลาง\nvar allMachines = global.get(\"machineData\") || [];\nvar idx = allMachines.findIndex(m => m.id === machineID);\nif (idx !== -1) allMachines[idx] = Object.assign(allMachines[idx], reactData);\nelse allMachines.push(reactData);\nglobal.set(\"machineData\", allMachines);\n\n// 3. --- เตรียมข้อมูลส่ง Google Sheet ---\ndata.spreadsheetId = mySheetID;\ndata.timestamp = now;\n\n// >>> เติมบรรทัดนี้ครับ เพื่อให้ Google Sheet รู้จักชื่อเครื่อง <<<\ndata.machine_no = machineName; \n\nmsg.payload = data;\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1480,
        "y": 3380,
        "wires": [
            [
                "8f3e8388797e3ed5"
            ]
        ]
    },
    {
        "id": "8f3e8388797e3ed5",
        "type": "link out",
        "z": "606aeeb2baf6caa6",
        "g": "fe2aabeba7061bf6",
        "name": "IN 10",
        "mode": "link",
        "links": [
            "6478dc45f9f0fc0b"
        ],
        "x": 1635,
        "y": 3380,
        "wires": []
    },
    {
        "id": "c8c353803784f5e3",
        "type": "modbus-client",
        "name": "1300-10",
        "clienttype": "tcp",
        "bufferCommands": true,
        "stateLogEnabled": false,
        "queueLogEnabled": false,
        "failureLogEnabled": true,
        "tcpHost": "192.168.7.133",
        "tcpPort": 502,
        "tcpType": "DEFAULT",
        "serialPort": "/dev/ttyUSB",
        "serialType": "RTU-BUFFERD",
        "serialBaudrate": 9600,
        "serialDatabits": 8,
        "serialStopbits": 1,
        "serialParity": "none",
        "serialConnectionDelay": 100,
        "serialAsciiResponseStartDelimiter": "0x3A",
        "unit_id": 10,
        "commandDelay": 1,
        "clientTimeout": 1000,
        "reconnectOnTimeout": true,
        "reconnectTimeout": 2000,
        "parallelUnitIdsAllowed": true,
        "showErrors": false,
        "showWarnings": true,
        "showLogs": true
    },
    {
        "id": "b32328e98310a432",
        "type": "group",
        "z": "606aeeb2baf6caa6",
        "g": "7351bc4077f8b06d",
        "style": {
            "stroke": "#999999",
            "stroke-opacity": "1",
            "fill": "none",
            "fill-opacity": "1",
            "label": true,
            "label-position": "nw",
            "color": "#a4a4a4"
        },
        "nodes": [
            "b05f8935171f152b",
            "7cffd9d18736e03f",
            "c4d52059d2cc42fb",
            "8a9c9bba76a87872",
            "2a45b5763369bcf1",
            "cee19e94f42390de",
            "f65367f04452a2ac",
            "45b266de12824dc6",
            "60c03ae15009460a",
            "24a80829a7ac02ae",
            "082bd5c9ae639d20",
            "832d6d385a39f8e2",
            "fb8d23eaa721f58a",
            "9d451139af24c134",
            "e268a0c2c3d8c6b0",
            "5cbbe6d00d701907",
            "87800c3820e811a1"
        ],
        "x": 574,
        "y": 3559,
        "w": 1112,
        "h": 322
    },
    {
        "id": "b05f8935171f152b",
        "type": "function",
        "z": "606aeeb2baf6caa6",
        "g": "b32328e98310a432",
        "name": "Model",
        "func": "\nif (Array.isArray(msg.payload)) {\n    var match = msg.payload.find(item => item.machine === \"1300/3\");\n    if (match) {\n        msg.payload = match.detail_g; \n        msg.topic = \"model\"; \n        return msg;\n    }\n}\n\nreturn null;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 770,
        "y": 3720,
        "wires": [
            [
                "9d451139af24c134"
            ]
        ]
    },
    {
        "id": "7cffd9d18736e03f",
        "type": "function",
        "z": "606aeeb2baf6caa6",
        "g": "b32328e98310a432",
        "name": "Total Pcs.",
        "func": "// 1. ตรวจสอบก่อนว่าเป็น Array (รายการ) หรือไม่ เพื่อกัน Error\nif (!Array.isArray(msg.payload)) {\n    // ถ้าไม่ใช่ List รายการ ให้ข้ามไป\n    return null; \n}\n\n// 2. ค้นหาเครื่องจักรชื่อ \"1200/1\" (แก้ชื่อตรงนี้ได้ตามจริง)\nvar match = msg.payload.find(item => item.machine === \"1300/3\");\n\nif (match) {\n    // 3. ดึงค่าผลรวม Z มาใส่ payload\n    msg.payload = match.detail_z; \n\n    // 4. --- กำหนดชื่อหัวข้อ (สำคัญมาก) ---\n    // เพื่อให้ Join Node รู้ว่าค่านี่คือ \"detail_z\"\n    msg.topic = \"total_pcs\"; \n\n    return msg;\n}\n\n// ถ้าหาไม่เจอ ให้คืนค่า null\nreturn null;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 780,
        "y": 3760,
        "wires": [
            [
                "9d451139af24c134"
            ]
        ]
    },
    {
        "id": "c4d52059d2cc42fb",
        "type": "comment",
        "z": "606aeeb2baf6caa6",
        "g": "b32328e98310a432",
        "name": "11",
        "info": "",
        "x": 1030,
        "y": 3620,
        "wires": []
    },
    {
        "id": "8a9c9bba76a87872",
        "type": "modbus-read",
        "z": "606aeeb2baf6caa6",
        "g": "b32328e98310a432",
        "name": "40002",
        "topic": "",
        "showStatusActivities": false,
        "logIOActivities": false,
        "showErrors": false,
        "showWarnings": true,
        "unitid": "",
        "dataType": "HoldingRegister",
        "adr": "1",
        "quantity": "1",
        "rate": "1",
        "rateUnit": "s",
        "delayOnStart": false,
        "enableDeformedMessages": false,
        "startDelayTime": "",
        "server": "edf5965060113d28",
        "useIOFile": false,
        "ioFile": "",
        "useIOForPayload": false,
        "emptyMsgOnFail": false,
        "x": 670,
        "y": 3600,
        "wires": [
            [],
            [
                "2a45b5763369bcf1"
            ]
        ]
    },
    {
        "id": "2a45b5763369bcf1",
        "type": "function",
        "z": "606aeeb2baf6caa6",
        "g": "b32328e98310a432",
        "name": "Present cycle",
        "func": "// ดึงค่าจาก msg.payload.data[0]\nlet rawValue = msg.payload.data[0];\n\n// หาร 10 เพื่อแปลงเป็นค่าทศนิยม\nlet displayValue = rawValue / 10;\n\n// ใส่ค่าใน msg.payload สำหรับแสดงบน dashboard\nmsg.payload = displayValue;\n\nmsg.topic = \"present_cycle\";\n\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 800,
        "y": 3600,
        "wires": [
            [
                "9d451139af24c134"
            ]
        ]
    },
    {
        "id": "cee19e94f42390de",
        "type": "modbus-read",
        "z": "606aeeb2baf6caa6",
        "g": "b32328e98310a432",
        "name": "40003",
        "topic": "",
        "showStatusActivities": false,
        "logIOActivities": false,
        "showErrors": false,
        "showWarnings": true,
        "unitid": "",
        "dataType": "HoldingRegister",
        "adr": "2",
        "quantity": "1",
        "rate": "1",
        "rateUnit": "s",
        "delayOnStart": false,
        "enableDeformedMessages": false,
        "startDelayTime": "",
        "server": "edf5965060113d28",
        "useIOFile": false,
        "ioFile": "",
        "useIOForPayload": false,
        "emptyMsgOnFail": false,
        "x": 670,
        "y": 3640,
        "wires": [
            [],
            [
                "f65367f04452a2ac"
            ]
        ]
    },
    {
        "id": "f65367f04452a2ac",
        "type": "function",
        "z": "606aeeb2baf6caa6",
        "g": "b32328e98310a432",
        "name": "Last cycle",
        "func": "// ดึงค่าจาก msg.payload.data[0]\nlet rawValue = msg.payload.data[0];\n\n// หาร 10 เพื่อแปลงเป็นค่าทศนิยม\nlet displayValue = rawValue / 10;\n\n// ใส่ค่าใน msg.payload สำหรับแสดงบน dashboard\nmsg.payload = displayValue;\nmsg.topic = \"last_cycle\";\n\n\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 790,
        "y": 3640,
        "wires": [
            [
                "9d451139af24c134"
            ]
        ]
    },
    {
        "id": "45b266de12824dc6",
        "type": "modbus-read",
        "z": "606aeeb2baf6caa6",
        "g": "b32328e98310a432",
        "name": "40001",
        "topic": "",
        "showStatusActivities": false,
        "logIOActivities": false,
        "showErrors": false,
        "showWarnings": true,
        "unitid": "",
        "dataType": "HoldingRegister",
        "adr": "0",
        "quantity": "1",
        "rate": "1",
        "rateUnit": "s",
        "delayOnStart": false,
        "enableDeformedMessages": false,
        "startDelayTime": "",
        "server": "edf5965060113d28",
        "useIOFile": false,
        "ioFile": "",
        "useIOForPayload": false,
        "emptyMsgOnFail": false,
        "x": 670,
        "y": 3680,
        "wires": [
            [],
            [
                "60c03ae15009460a"
            ]
        ]
    },
    {
        "id": "60c03ae15009460a",
        "type": "function",
        "z": "606aeeb2baf6caa6",
        "g": "b32328e98310a432",
        "name": "status Mc on",
        "func": "let value = msg.payload.data[0];\n\nif (value === 1) {\n    msg.payload = \"ON\";\n} else if (value === 0) {\n    msg.payload = \"OFF\";\n} else {\n    msg.payload = \"Unknown\";  // กรณีที่ค่าไม่ใช่ 1 หรือ 0\n}\n msg.topic = \"status_mc_on\"; \nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 790,
        "y": 3680,
        "wires": [
            [
                "9d451139af24c134"
            ]
        ]
    },
    {
        "id": "24a80829a7ac02ae",
        "type": "function",
        "z": "606aeeb2baf6caa6",
        "g": "b32328e98310a432",
        "name": "CAVITY",
        "func": "// ดึงค่าจาก msg.payload.data[0]\nlet rawValue = msg.payload.data[0];\n\n// หาร 10 เพื่อแปลงเป็นค่าทศนิยม\nlet displayValue = rawValue ;\n\n// ใส่ค่าใน msg.payload สำหรับแสดงบน dashboard\nmsg.payload = displayValue;\nmsg.topic = \"cavity\";\n\n\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 780,
        "y": 3800,
        "wires": [
            [
                "9d451139af24c134"
            ]
        ]
    },
    {
        "id": "082bd5c9ae639d20",
        "type": "modbus-read",
        "z": "606aeeb2baf6caa6",
        "g": "b32328e98310a432",
        "name": "40017",
        "topic": "",
        "showStatusActivities": false,
        "logIOActivities": false,
        "showErrors": false,
        "showWarnings": true,
        "unitid": "",
        "dataType": "HoldingRegister",
        "adr": "16",
        "quantity": "1",
        "rate": "1",
        "rateUnit": "s",
        "delayOnStart": false,
        "enableDeformedMessages": false,
        "startDelayTime": "",
        "server": "edf5965060113d28",
        "useIOFile": false,
        "ioFile": "",
        "useIOForPayload": false,
        "emptyMsgOnFail": false,
        "x": 670,
        "y": 3840,
        "wires": [
            [],
            [
                "832d6d385a39f8e2"
            ]
        ]
    },
    {
        "id": "832d6d385a39f8e2",
        "type": "function",
        "z": "606aeeb2baf6caa6",
        "g": "b32328e98310a432",
        "name": "STD CYCLE ",
        "func": "// ดึงค่าจาก msg.payload.data[0]\nlet rawValue = msg.payload.data[0];\n\n// หาร 10 เพื่อแปลงเป็นค่าทศนิยม\nlet displayValue = rawValue ;\n\n// ใส่ค่าใน msg.payload สำหรับแสดงบน dashboard\nmsg.payload = displayValue;\nmsg.topic = \"std_cycle\";\n\n\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 790,
        "y": 3840,
        "wires": [
            [
                "9d451139af24c134"
            ]
        ]
    },
    {
        "id": "fb8d23eaa721f58a",
        "type": "modbus-read",
        "z": "606aeeb2baf6caa6",
        "g": "b32328e98310a432",
        "name": "40016",
        "topic": "",
        "showStatusActivities": false,
        "logIOActivities": false,
        "showErrors": false,
        "showWarnings": true,
        "unitid": "",
        "dataType": "HoldingRegister",
        "adr": "15",
        "quantity": "1",
        "rate": "1",
        "rateUnit": "s",
        "delayOnStart": false,
        "enableDeformedMessages": false,
        "startDelayTime": "",
        "server": "edf5965060113d28",
        "useIOFile": false,
        "ioFile": "",
        "useIOForPayload": false,
        "emptyMsgOnFail": false,
        "x": 670,
        "y": 3800,
        "wires": [
            [],
            [
                "24a80829a7ac02ae"
            ]
        ]
    },
    {
        "id": "9d451139af24c134",
        "type": "join",
        "z": "606aeeb2baf6caa6",
        "g": "b32328e98310a432",
        "name": "รวมข้อมูล (Join)",
        "mode": "custom",
        "build": "object",
        "property": "payload",
        "propertyType": "msg",
        "key": "topic",
        "joiner": "\\n",
        "joinerType": "str",
        "useparts": true,
        "accumulate": true,
        "timeout": "15",
        "count": "7",
        "reduceRight": false,
        "reduceExp": "",
        "reduceInit": "",
        "reduceInitType": "",
        "reduceFixup": "",
        "x": 1030,
        "y": 3720,
        "wires": [
            [
                "e268a0c2c3d8c6b0"
            ]
        ]
    },
    {
        "id": "e268a0c2c3d8c6b0",
        "type": "function",
        "z": "606aeeb2baf6caa6",
        "g": "b32328e98310a432",
        "name": "เช็คความครบ",
        "func": "// รายชื่อหัวข้อข้อมูลที่ต้องมีให้ครบ 7 ตัว\nvar requiredKeys = [\n    \"present_cycle\", \n    \"last_cycle\", \n    \"cavity\", \n    \"std_cycle\", \n    \"status_mc_on\", \n    \"model\", \n    \"total_pcs\"\n];\n\n// ดึงคีย์ที่มีอยู่ใน msg.payload ตอนนี้\nvar currentKeys = Object.keys(msg.payload);\n\n// เช็คว่าขาดตัวไหนไปบ้าง\nvar missing = requiredKeys.filter(function(key) {\n    return !currentKeys.includes(key);\n});\n\n// ถ้ามีตัวที่ขาด (missing > 0)\nif (missing.length > 0) {\n    // บันทึก Log ว่าขาดอะไร (ดูใน Debug)\n    node.warn(\"ข้อมูลไม่ครบ! ขาด: \" + missing.join(\", \"));\n    return null; // *** หยุดการส่งข้อมูลทันที ไม่ไปต่อ ***\n}\n\n// ถ้าครบถ้วน ให้ไปต่อ\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1250,
        "y": 3720,
        "wires": [
            [
                "5cbbe6d00d701907"
            ]
        ]
    },
    {
        "id": "5cbbe6d00d701907",
        "type": "function",
        "z": "606aeeb2baf6caa6",
        "g": "b32328e98310a432",
        "name": "ตั้งค่า Data & Save Global V2",
        "func": "// 1. --- ตั้งค่า Config ---\nvar mySheetID = \"1RJ9OI8Bz8Xy_7HW7fZVQnjeYshDd0BZUZrkG3ycJfy0\"; // ใส่ ID Sheet\nvar machineID = 11;\nvar machineName = \"1400-11\"; // <--- ชื่อที่จะไปโชว์ใน Excel ช่อง B\n\n// รับข้อมูลรวมจาก Join\nvar data = msg.payload;\nvar now = new Date().toLocaleString(\"th-TH\", { timeZone: \"Asia/Bangkok\" });\n\n// 2. --- อัปเดตข้อมูลสำหรับ React (Global Variable) ---\nvar reactData = {\n    id: machineID,\n    name: machineName,\n    machine_no: machineName,\n    status: (data.status_mc_on == 1) ? 1 : 0,\n    present_cycle: parseFloat(data.present_cycle || 0),\n    last_cycle: parseFloat(data.last_cycle || 0),\n    std_cycle: parseFloat(data.std_cycle || 0),\n    \n    // *** แก้ตรงนี้ด้วยนิดนึงครับ ***\n    // Model มักเป็นตัวหนังสือ (เช่น HC00443E) ห้ามใช้ parseFloat ไม่งั้นค่าจะเพี้ยนเป็น NaN หรือ 0\n    model: data.model || \"-\", \n    \n    cavity: parseFloat(data.cavity || 0),\n    total_pcs: parseFloat(data.total_pcs || 0),\n    timestamp: now\n};\n\n// เก็บลงตัวแปรกลาง\nvar allMachines = global.get(\"machineData\") || [];\nvar idx = allMachines.findIndex(m => m.id === machineID);\nif (idx !== -1) allMachines[idx] = Object.assign(allMachines[idx], reactData);\nelse allMachines.push(reactData);\nglobal.set(\"machineData\", allMachines);\n\n// 3. --- เตรียมข้อมูลส่ง Google Sheet ---\ndata.spreadsheetId = mySheetID;\ndata.timestamp = now;\n\n// >>> เติมบรรทัดนี้ครับ เพื่อให้ Google Sheet รู้จักชื่อเครื่อง <<<\ndata.machine_no = machineName; \n\nmsg.payload = data;\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1480,
        "y": 3720,
        "wires": [
            [
                "87800c3820e811a1"
            ]
        ]
    },
    {
        "id": "87800c3820e811a1",
        "type": "link out",
        "z": "606aeeb2baf6caa6",
        "g": "b32328e98310a432",
        "name": "IN 11",
        "mode": "link",
        "links": [
            "fa3a60522d5cf7fe"
        ],
        "x": 1645,
        "y": 3720,
        "wires": []
    },
    {
        "id": "edf5965060113d28",
        "type": "modbus-client",
        "name": "1400-11",
        "clienttype": "tcp",
        "bufferCommands": true,
        "stateLogEnabled": false,
        "queueLogEnabled": false,
        "failureLogEnabled": true,
        "tcpHost": "192.168.7.135",
        "tcpPort": 502,
        "tcpType": "DEFAULT",
        "serialPort": "/dev/ttyUSB",
        "serialType": "RTU-BUFFERD",
        "serialBaudrate": 9600,
        "serialDatabits": 8,
        "serialStopbits": 1,
        "serialParity": "none",
        "serialConnectionDelay": 100,
        "serialAsciiResponseStartDelimiter": "0x3A",
        "unit_id": 11,
        "commandDelay": 1,
        "clientTimeout": 1000,
        "reconnectOnTimeout": true,
        "reconnectTimeout": 2000,
        "parallelUnitIdsAllowed": true,
        "showErrors": false,
        "showWarnings": true,
        "showLogs": true
    },
    {
        "id": "02d870e848997f02",
        "type": "group",
        "z": "606aeeb2baf6caa6",
        "g": "7351bc4077f8b06d",
        "style": {
            "stroke": "#999999",
            "stroke-opacity": "1",
            "fill": "none",
            "fill-opacity": "1",
            "label": true,
            "label-position": "nw",
            "color": "#a4a4a4"
        },
        "nodes": [
            "d72d74e0b39d41b4",
            "b2b28ce13575146c",
            "f822acfc7d470e33",
            "41cb6dbabcd69020",
            "c9d64d7fa1a4f4b3",
            "75919a54fb21aaf3",
            "cf08551c465f4117",
            "88bd04ac5236fb0d",
            "a0510eb2650a0800",
            "288e446e2cdec6c5",
            "596f9ef2b555e76c",
            "e4fe522529caf463",
            "6f2683872114cb68",
            "779bf52c42dd7a61",
            "6acfb06bcd1c7618",
            "71200deb8dfe69a8",
            "334cc6b4cd946aca"
        ],
        "x": 574,
        "y": 3899,
        "w": 1102,
        "h": 322
    },
    {
        "id": "d72d74e0b39d41b4",
        "type": "function",
        "z": "606aeeb2baf6caa6",
        "g": "02d870e848997f02",
        "name": "Model",
        "func": "\nif (Array.isArray(msg.payload)) {\n    var match = msg.payload.find(item => item.machine === \"1300/3\");\n    if (match) {\n        msg.payload = match.detail_g; \n        msg.topic = \"model\"; \n        return msg;\n    }\n}\n\nreturn null;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 770,
        "y": 4060,
        "wires": [
            [
                "779bf52c42dd7a61"
            ]
        ]
    },
    {
        "id": "b2b28ce13575146c",
        "type": "function",
        "z": "606aeeb2baf6caa6",
        "g": "02d870e848997f02",
        "name": "Total Pcs.",
        "func": "// 1. ตรวจสอบก่อนว่าเป็น Array (รายการ) หรือไม่ เพื่อกัน Error\nif (!Array.isArray(msg.payload)) {\n    // ถ้าไม่ใช่ List รายการ ให้ข้ามไป\n    return null; \n}\n\n// 2. ค้นหาเครื่องจักรชื่อ \"1200/1\" (แก้ชื่อตรงนี้ได้ตามจริง)\nvar match = msg.payload.find(item => item.machine === \"1300/3\");\n\nif (match) {\n    // 3. ดึงค่าผลรวม Z มาใส่ payload\n    msg.payload = match.detail_z; \n\n    // 4. --- กำหนดชื่อหัวข้อ (สำคัญมาก) ---\n    // เพื่อให้ Join Node รู้ว่าค่านี่คือ \"detail_z\"\n    msg.topic = \"total_pcs\"; \n\n    return msg;\n}\n\n// ถ้าหาไม่เจอ ให้คืนค่า null\nreturn null;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 780,
        "y": 4100,
        "wires": [
            [
                "779bf52c42dd7a61"
            ]
        ]
    },
    {
        "id": "f822acfc7d470e33",
        "type": "comment",
        "z": "606aeeb2baf6caa6",
        "g": "02d870e848997f02",
        "name": "12",
        "info": "",
        "x": 1030,
        "y": 3960,
        "wires": []
    },
    {
        "id": "41cb6dbabcd69020",
        "type": "modbus-read",
        "z": "606aeeb2baf6caa6",
        "g": "02d870e848997f02",
        "name": "40002",
        "topic": "",
        "showStatusActivities": false,
        "logIOActivities": false,
        "showErrors": false,
        "showWarnings": true,
        "unitid": "",
        "dataType": "HoldingRegister",
        "adr": "1",
        "quantity": "1",
        "rate": "1",
        "rateUnit": "s",
        "delayOnStart": false,
        "enableDeformedMessages": false,
        "startDelayTime": "",
        "server": "a2dde42cdd791965",
        "useIOFile": false,
        "ioFile": "",
        "useIOForPayload": false,
        "emptyMsgOnFail": false,
        "x": 670,
        "y": 3940,
        "wires": [
            [],
            [
                "c9d64d7fa1a4f4b3"
            ]
        ]
    },
    {
        "id": "c9d64d7fa1a4f4b3",
        "type": "function",
        "z": "606aeeb2baf6caa6",
        "g": "02d870e848997f02",
        "name": "Present cycle",
        "func": "// ดึงค่าจาก msg.payload.data[0]\nlet rawValue = msg.payload.data[0];\n\n// หาร 10 เพื่อแปลงเป็นค่าทศนิยม\nlet displayValue = rawValue / 10;\n\n// ใส่ค่าใน msg.payload สำหรับแสดงบน dashboard\nmsg.payload = displayValue;\n\nmsg.topic = \"present_cycle\";\n\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 800,
        "y": 3940,
        "wires": [
            [
                "779bf52c42dd7a61"
            ]
        ]
    },
    {
        "id": "75919a54fb21aaf3",
        "type": "modbus-read",
        "z": "606aeeb2baf6caa6",
        "g": "02d870e848997f02",
        "name": "40003",
        "topic": "",
        "showStatusActivities": false,
        "logIOActivities": false,
        "showErrors": false,
        "showWarnings": true,
        "unitid": "",
        "dataType": "HoldingRegister",
        "adr": "2",
        "quantity": "1",
        "rate": "1",
        "rateUnit": "s",
        "delayOnStart": false,
        "enableDeformedMessages": false,
        "startDelayTime": "",
        "server": "a2dde42cdd791965",
        "useIOFile": false,
        "ioFile": "",
        "useIOForPayload": false,
        "emptyMsgOnFail": false,
        "x": 670,
        "y": 3980,
        "wires": [
            [],
            [
                "cf08551c465f4117"
            ]
        ]
    },
    {
        "id": "cf08551c465f4117",
        "type": "function",
        "z": "606aeeb2baf6caa6",
        "g": "02d870e848997f02",
        "name": "Last cycle",
        "func": "// ดึงค่าจาก msg.payload.data[0]\nlet rawValue = msg.payload.data[0];\n\n// หาร 10 เพื่อแปลงเป็นค่าทศนิยม\nlet displayValue = rawValue / 10;\n\n// ใส่ค่าใน msg.payload สำหรับแสดงบน dashboard\nmsg.payload = displayValue;\nmsg.topic = \"last_cycle\";\n\n\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 790,
        "y": 3980,
        "wires": [
            [
                "779bf52c42dd7a61"
            ]
        ]
    },
    {
        "id": "88bd04ac5236fb0d",
        "type": "modbus-read",
        "z": "606aeeb2baf6caa6",
        "g": "02d870e848997f02",
        "name": "40001",
        "topic": "",
        "showStatusActivities": false,
        "logIOActivities": false,
        "showErrors": false,
        "showWarnings": true,
        "unitid": "",
        "dataType": "HoldingRegister",
        "adr": "0",
        "quantity": "1",
        "rate": "1",
        "rateUnit": "s",
        "delayOnStart": false,
        "enableDeformedMessages": false,
        "startDelayTime": "",
        "server": "a2dde42cdd791965",
        "useIOFile": false,
        "ioFile": "",
        "useIOForPayload": false,
        "emptyMsgOnFail": false,
        "x": 670,
        "y": 4020,
        "wires": [
            [],
            [
                "a0510eb2650a0800"
            ]
        ]
    },
    {
        "id": "a0510eb2650a0800",
        "type": "function",
        "z": "606aeeb2baf6caa6",
        "g": "02d870e848997f02",
        "name": "status Mc on",
        "func": "let value = msg.payload.data[0];\n\nif (value === 1) {\n    msg.payload = \"ON\";\n} else if (value === 0) {\n    msg.payload = \"OFF\";\n} else {\n    msg.payload = \"Unknown\";  // กรณีที่ค่าไม่ใช่ 1 หรือ 0\n}\n msg.topic = \"status_mc_on\"; \nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 790,
        "y": 4020,
        "wires": [
            [
                "779bf52c42dd7a61"
            ]
        ]
    },
    {
        "id": "288e446e2cdec6c5",
        "type": "function",
        "z": "606aeeb2baf6caa6",
        "g": "02d870e848997f02",
        "name": "CAVITY",
        "func": "// ดึงค่าจาก msg.payload.data[0]\nlet rawValue = msg.payload.data[0];\n\n// หาร 10 เพื่อแปลงเป็นค่าทศนิยม\nlet displayValue = rawValue ;\n\n// ใส่ค่าใน msg.payload สำหรับแสดงบน dashboard\nmsg.payload = displayValue;\nmsg.topic = \"cavity\";\n\n\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 780,
        "y": 4140,
        "wires": [
            [
                "779bf52c42dd7a61"
            ]
        ]
    },
    {
        "id": "596f9ef2b555e76c",
        "type": "modbus-read",
        "z": "606aeeb2baf6caa6",
        "g": "02d870e848997f02",
        "name": "40017",
        "topic": "",
        "showStatusActivities": false,
        "logIOActivities": false,
        "showErrors": false,
        "showWarnings": true,
        "unitid": "",
        "dataType": "HoldingRegister",
        "adr": "16",
        "quantity": "1",
        "rate": "1",
        "rateUnit": "s",
        "delayOnStart": false,
        "enableDeformedMessages": false,
        "startDelayTime": "",
        "server": "a2dde42cdd791965",
        "useIOFile": false,
        "ioFile": "",
        "useIOForPayload": false,
        "emptyMsgOnFail": false,
        "x": 670,
        "y": 4180,
        "wires": [
            [],
            [
                "e4fe522529caf463"
            ]
        ]
    },
    {
        "id": "e4fe522529caf463",
        "type": "function",
        "z": "606aeeb2baf6caa6",
        "g": "02d870e848997f02",
        "name": "STD CYCLE ",
        "func": "// ดึงค่าจาก msg.payload.data[0]\nlet rawValue = msg.payload.data[0];\n\n// หาร 10 เพื่อแปลงเป็นค่าทศนิยม\nlet displayValue = rawValue ;\n\n// ใส่ค่าใน msg.payload สำหรับแสดงบน dashboard\nmsg.payload = displayValue;\nmsg.topic = \"std_cycle\";\n\n\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 790,
        "y": 4180,
        "wires": [
            [
                "779bf52c42dd7a61"
            ]
        ]
    },
    {
        "id": "6f2683872114cb68",
        "type": "modbus-read",
        "z": "606aeeb2baf6caa6",
        "g": "02d870e848997f02",
        "name": "40016",
        "topic": "",
        "showStatusActivities": false,
        "logIOActivities": false,
        "showErrors": false,
        "showWarnings": true,
        "unitid": "",
        "dataType": "HoldingRegister",
        "adr": "15",
        "quantity": "1",
        "rate": "1",
        "rateUnit": "s",
        "delayOnStart": false,
        "enableDeformedMessages": false,
        "startDelayTime": "",
        "server": "a2dde42cdd791965",
        "useIOFile": false,
        "ioFile": "",
        "useIOForPayload": false,
        "emptyMsgOnFail": false,
        "x": 670,
        "y": 4140,
        "wires": [
            [],
            [
                "288e446e2cdec6c5"
            ]
        ]
    },
    {
        "id": "779bf52c42dd7a61",
        "type": "join",
        "z": "606aeeb2baf6caa6",
        "g": "02d870e848997f02",
        "name": "รวมข้อมูล (Join)",
        "mode": "custom",
        "build": "object",
        "property": "payload",
        "propertyType": "msg",
        "key": "topic",
        "joiner": "\\n",
        "joinerType": "str",
        "useparts": true,
        "accumulate": true,
        "timeout": "15",
        "count": "7",
        "reduceRight": false,
        "reduceExp": "",
        "reduceInit": "",
        "reduceInitType": "",
        "reduceFixup": "",
        "x": 1030,
        "y": 4060,
        "wires": [
            [
                "6acfb06bcd1c7618"
            ]
        ]
    },
    {
        "id": "6acfb06bcd1c7618",
        "type": "function",
        "z": "606aeeb2baf6caa6",
        "g": "02d870e848997f02",
        "name": "เช็คความครบ",
        "func": "// รายชื่อหัวข้อข้อมูลที่ต้องมีให้ครบ 7 ตัว\nvar requiredKeys = [\n    \"present_cycle\", \n    \"last_cycle\", \n    \"cavity\", \n    \"std_cycle\", \n    \"status_mc_on\", \n    \"model\", \n    \"total_pcs\"\n];\n\n// ดึงคีย์ที่มีอยู่ใน msg.payload ตอนนี้\nvar currentKeys = Object.keys(msg.payload);\n\n// เช็คว่าขาดตัวไหนไปบ้าง\nvar missing = requiredKeys.filter(function(key) {\n    return !currentKeys.includes(key);\n});\n\n// ถ้ามีตัวที่ขาด (missing > 0)\nif (missing.length > 0) {\n    // บันทึก Log ว่าขาดอะไร (ดูใน Debug)\n    node.warn(\"ข้อมูลไม่ครบ! ขาด: \" + missing.join(\", \"));\n    return null; // *** หยุดการส่งข้อมูลทันที ไม่ไปต่อ ***\n}\n\n// ถ้าครบถ้วน ให้ไปต่อ\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1250,
        "y": 4060,
        "wires": [
            [
                "71200deb8dfe69a8"
            ]
        ]
    },
    {
        "id": "71200deb8dfe69a8",
        "type": "function",
        "z": "606aeeb2baf6caa6",
        "g": "02d870e848997f02",
        "name": "ตั้งค่า Data & Save Global V2",
        "func": "// 1. --- ตั้งค่า Config ---\nvar mySheetID = \"1RJ9OI8Bz8Xy_7HW7fZVQnjeYshDd0BZUZrkG3ycJfy0\"; // ใส่ ID Sheet\nvar machineID = 12;\nvar machineName = \"1100-12\"; // <--- ชื่อที่จะไปโชว์ใน Excel ช่อง B\n\n// รับข้อมูลรวมจาก Join\nvar data = msg.payload;\nvar now = new Date().toLocaleString(\"th-TH\", { timeZone: \"Asia/Bangkok\" });\n\n// 2. --- อัปเดตข้อมูลสำหรับ React (Global Variable) ---\nvar reactData = {\n    id: machineID,\n    name: machineName,\n    machine_no: machineName,\n    status: (data.status_mc_on == 1) ? 1 : 0,\n    present_cycle: parseFloat(data.present_cycle || 0),\n    last_cycle: parseFloat(data.last_cycle || 0),\n    std_cycle: parseFloat(data.std_cycle || 0),\n    \n    // *** แก้ตรงนี้ด้วยนิดนึงครับ ***\n    // Model มักเป็นตัวหนังสือ (เช่น HC00443E) ห้ามใช้ parseFloat ไม่งั้นค่าจะเพี้ยนเป็น NaN หรือ 0\n    model: data.model || \"-\", \n    \n    cavity: parseFloat(data.cavity || 0),\n    total_pcs: parseFloat(data.total_pcs || 0),\n    timestamp: now\n};\n\n// เก็บลงตัวแปรกลาง\nvar allMachines = global.get(\"machineData\") || [];\nvar idx = allMachines.findIndex(m => m.id === machineID);\nif (idx !== -1) allMachines[idx] = Object.assign(allMachines[idx], reactData);\nelse allMachines.push(reactData);\nglobal.set(\"machineData\", allMachines);\n\n// 3. --- เตรียมข้อมูลส่ง Google Sheet ---\ndata.spreadsheetId = mySheetID;\ndata.timestamp = now;\n\n// >>> เติมบรรทัดนี้ครับ เพื่อให้ Google Sheet รู้จักชื่อเครื่อง <<<\ndata.machine_no = machineName; \n\nmsg.payload = data;\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1480,
        "y": 4060,
        "wires": [
            [
                "334cc6b4cd946aca"
            ]
        ]
    },
    {
        "id": "334cc6b4cd946aca",
        "type": "link out",
        "z": "606aeeb2baf6caa6",
        "g": "02d870e848997f02",
        "name": "IN 12",
        "mode": "link",
        "links": [
            "9672ada0254f7796"
        ],
        "x": 1635,
        "y": 4060,
        "wires": []
    },
    {
        "id": "a2dde42cdd791965",
        "type": "modbus-client",
        "name": "1100-12",
        "clienttype": "tcp",
        "bufferCommands": true,
        "stateLogEnabled": false,
        "queueLogEnabled": false,
        "failureLogEnabled": true,
        "tcpHost": "192.168.7.136",
        "tcpPort": 502,
        "tcpType": "DEFAULT",
        "serialPort": "/dev/ttyUSB",
        "serialType": "RTU-BUFFERD",
        "serialBaudrate": 9600,
        "serialDatabits": 8,
        "serialStopbits": 1,
        "serialParity": "none",
        "serialConnectionDelay": 100,
        "serialAsciiResponseStartDelimiter": "0x3A",
        "unit_id": 12,
        "commandDelay": 1,
        "clientTimeout": 1000,
        "reconnectOnTimeout": true,
        "reconnectTimeout": 2000,
        "parallelUnitIdsAllowed": true,
        "showErrors": false,
        "showWarnings": true,
        "showLogs": true
    },
    {
        "id": "41a814b251b3d9c1",
        "type": "inject",
        "z": "606aeeb2baf6caa6",
        "g": "7351bc4077f8b06d",
        "name": "",
        "props": [
            {
                "p": "payload"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 120,
        "y": 1020,
        "wires": [
            [
                "22143cf47a240b92",
                "f5859804d4cb24fa",
                "425c5212a151b142"
            ]
        ]
    },
    {
        "id": "b028d24f4566ecc8",
        "type": "function",
        "z": "606aeeb2baf6caa6",
        "g": "7351bc4077f8b06d",
        "name": "Fix data & Save Global",
        "func": "// 1. --- ดึงข้อมูลจาก Global Context (ที่คุณบันทึกไว้ก่อนหน้า) ---\nvar machineID = 1; // ระบุ ID เครื่องที่ต้องการส่ง\nvar allMachines = global.get(\"machineData\") || [];\nvar machineData = allMachines.find(m => m.id === machineID);\n\n// 2. --- ตรวจสอบว่ามีข้อมูลเครื่องนี้ไหม ---\nif (!machineData) {\n    node.warn(\"ยังไม่มีข้อมูลเครื่องที่ \" + machineID + \" ใน Global Context\");\n    return null; \n}\n\n// 3. --- ตรวจสอบเงื่อนไขการส่ง (เช่น ต้องมี Model ถึงจะส่ง) ---\n// เพื่อป้องกันการส่งบรรทัดว่างที่ค่าไม่ครบ\nif (machineData.model === \"-\" || !machineData.model) {\n    return null; // ข้อมูลยังไม่พร้อม ไม่ต้องส่ง\n}\n\n// 4. --- ประกอบร่าง Payload สำหรับ Google Sheet (ส่งบรรทัดเดียวครบทุกช่อง) ---\nmsg.payload = {\n    \"spreadsheetId\": \"1RJ9OI8Bz8Xy_7HW7fZVQnjeYshDd0BZUZrkG3ycJfy0\",\n    \"timestamp\": new Date().toLocaleString(\"th-TH\", { timeZone: \"Asia/Bangkok\" }),\n    \"machine_no\": machineData.machine_no,\n    \"status_mc_on\": (machineData.status == 1) ? \"TRUE\" : \"FALSE\", // ปรับตามที่คุณต้องการใน Sheet\n    \"model\": machineData.model,\n    \"present_cycle\": machineData.present_cycle,\n    \"last_cycle\": machineData.last_cycle,\n    \"std_cycle\": machineData.std_cycle,\n    \"cavity\": machineData.cavity,\n    \"total_pcs\": machineData.total_pcs\n};\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 2140,
        "y": 380,
        "wires": [
            []
        ]
    },
    {
        "id": "691f4ec5ad460365",
        "type": "group",
        "z": "606aeeb2baf6caa6",
        "g": "7351bc4077f8b06d",
        "name": "ส่งข้อมูลไปยังเว็ป",
        "style": {
            "fill": "#ffdf7f",
            "label": true
        },
        "nodes": [
            "72f77014531cf291",
            "9a9ea46bb16a702b",
            "864df1266a2e4c6d"
        ],
        "x": 2014,
        "y": 519,
        "w": 552,
        "h": 82
    },
    {
        "id": "72f77014531cf291",
        "type": "http in",
        "z": "606aeeb2baf6caa6",
        "g": "691f4ec5ad460365",
        "name": "API: GET /machines",
        "url": "/machines",
        "method": "get",
        "upload": false,
        "swaggerDoc": "",
        "x": 2130,
        "y": 560,
        "wires": [
            [
                "864df1266a2e4c6d"
            ]
        ]
    },
    {
        "id": "9a9ea46bb16a702b",
        "type": "http response",
        "z": "606aeeb2baf6caa6",
        "g": "691f4ec5ad460365",
        "name": "",
        "statusCode": "",
        "headers": {},
        "x": 2490,
        "y": 560,
        "wires": []
    },
    {
        "id": "864df1266a2e4c6d",
        "type": "function",
        "z": "606aeeb2baf6caa6",
        "g": "691f4ec5ad460365",
        "name": "ดึงข้อมูลจาก Global",
        "func": "// ดึงข้อมูลล่าสุดที่ function ด้านบนบันทึกไว้\nmsg.payload = global.get(\"machineData\") || [];\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 2330,
        "y": 560,
        "wires": [
            [
                "9a9ea46bb16a702b"
            ]
        ]
    },
    {
        "id": "6656abfed82220f2",
        "type": "group",
        "z": "606aeeb2baf6caa6",
        "g": "7351bc4077f8b06d",
        "style": {
            "stroke": "#999999",
            "stroke-opacity": "1",
            "fill": "none",
            "fill-opacity": "1",
            "label": true,
            "label-position": "nw",
            "color": "#a4a4a4"
        },
        "nodes": [
            "ac51a8d4b7063108",
            "fdcd0c85287c426f",
            "1b37248b4eb95c13",
            "dd26c36cf98dcfbe",
            "4745b480c5d40a69",
            "5396a9baa56ce2ee",
            "3a682ac01f47ea82",
            "6478dc45f9f0fc0b",
            "6eb85d63cf4a88f4",
            "fa3a60522d5cf7fe",
            "147d89461f6414d0",
            "9672ada0254f7796",
            "54dd0d0df0b4968c",
            "42abad236eecfdfa"
        ],
        "x": 1784,
        "y": 919,
        "w": 708,
        "h": 562
    },
    {
        "id": "ac51a8d4b7063108",
        "type": "link in",
        "z": "606aeeb2baf6caa6",
        "g": "6656abfed82220f2",
        "name": "7",
        "links": [
            "aee3135d05b2733f"
        ],
        "x": 1825,
        "y": 1200,
        "wires": [
            [
                "d0fc9b194ba4d22c"
            ]
        ]
    },
    {
        "id": "fdcd0c85287c426f",
        "type": "link in",
        "z": "606aeeb2baf6caa6",
        "g": "6656abfed82220f2",
        "name": "8",
        "links": [
            "03c12b3e612c6a24"
        ],
        "x": 1825,
        "y": 1240,
        "wires": [
            [
                "d0fc9b194ba4d22c"
            ]
        ]
    },
    {
        "id": "1b37248b4eb95c13",
        "type": "link in",
        "z": "606aeeb2baf6caa6",
        "g": "6656abfed82220f2",
        "name": "6",
        "links": [
            "cb5eaddab28a5168"
        ],
        "x": 1825,
        "y": 1160,
        "wires": [
            [
                "d0fc9b194ba4d22c"
            ]
        ]
    },
    {
        "id": "dd26c36cf98dcfbe",
        "type": "link in",
        "z": "606aeeb2baf6caa6",
        "g": "6656abfed82220f2",
        "name": "5",
        "links": [
            "0722e294ab5a22d4"
        ],
        "x": 1825,
        "y": 1120,
        "wires": [
            [
                "d0fc9b194ba4d22c"
            ]
        ]
    },
    {
        "id": "4745b480c5d40a69",
        "type": "link in",
        "z": "606aeeb2baf6caa6",
        "g": "6656abfed82220f2",
        "name": "9",
        "links": [
            "cdb1a6d4eb39aa94"
        ],
        "x": 1825,
        "y": 1280,
        "wires": [
            [
                "d0fc9b194ba4d22c"
            ]
        ]
    },
    {
        "id": "5396a9baa56ce2ee",
        "type": "link in",
        "z": "606aeeb2baf6caa6",
        "g": "6656abfed82220f2",
        "name": "4",
        "links": [
            "8b9c091eb4bf58a2"
        ],
        "x": 1825,
        "y": 1080,
        "wires": [
            [
                "d0fc9b194ba4d22c"
            ]
        ]
    },
    {
        "id": "3a682ac01f47ea82",
        "type": "link in",
        "z": "606aeeb2baf6caa6",
        "g": "6656abfed82220f2",
        "name": "3",
        "links": [
            "e34c799b4b07deb8"
        ],
        "x": 1825,
        "y": 1040,
        "wires": [
            [
                "d0fc9b194ba4d22c"
            ]
        ]
    },
    {
        "id": "6478dc45f9f0fc0b",
        "type": "link in",
        "z": "606aeeb2baf6caa6",
        "g": "6656abfed82220f2",
        "name": "10",
        "links": [
            "8f3e8388797e3ed5"
        ],
        "x": 1825,
        "y": 1320,
        "wires": [
            [
                "d0fc9b194ba4d22c"
            ]
        ]
    },
    {
        "id": "6eb85d63cf4a88f4",
        "type": "link in",
        "z": "606aeeb2baf6caa6",
        "g": "6656abfed82220f2",
        "name": "2",
        "links": [
            "4fadd2c29a6a3b3e"
        ],
        "x": 1825,
        "y": 1000,
        "wires": [
            [
                "d0fc9b194ba4d22c"
            ]
        ]
    },
    {
        "id": "fa3a60522d5cf7fe",
        "type": "link in",
        "z": "606aeeb2baf6caa6",
        "g": "6656abfed82220f2",
        "name": "11",
        "links": [
            "87800c3820e811a1"
        ],
        "x": 1825,
        "y": 1360,
        "wires": [
            [
                "d0fc9b194ba4d22c"
            ]
        ]
    },
    {
        "id": "147d89461f6414d0",
        "type": "link in",
        "z": "606aeeb2baf6caa6",
        "g": "6656abfed82220f2",
        "name": "13",
        "links": [
            "e2b734d38a046417"
        ],
        "x": 1825,
        "y": 1440,
        "wires": [
            [
                "d0fc9b194ba4d22c"
            ]
        ]
    },
    {
        "id": "9672ada0254f7796",
        "type": "link in",
        "z": "606aeeb2baf6caa6",
        "g": "6656abfed82220f2",
        "name": "12",
        "links": [
            "334cc6b4cd946aca"
        ],
        "x": 1825,
        "y": 1400,
        "wires": [
            [
                "d0fc9b194ba4d22c"
            ]
        ]
    },
    {
        "id": "54dd0d0df0b4968c",
        "type": "link in",
        "z": "606aeeb2baf6caa6",
        "g": "6656abfed82220f2",
        "name": "1",
        "links": [
            "b59f491af3680035"
        ],
        "x": 1825,
        "y": 960,
        "wires": [
            [
                "d0fc9b194ba4d22c"
            ]
        ]
    },
    {
        "id": "42abad236eecfdfa",
        "type": "group",
        "z": "606aeeb2baf6caa6",
        "g": "6656abfed82220f2",
        "name": "3. ส่งออก Google Sheet",
        "style": {
            "stroke": "#5b9bd5",
            "fill": "#dcecf9",
            "label": true
        },
        "nodes": [
            "d0fc9b194ba4d22c",
            "197037776ba7dc66"
        ],
        "x": 2014,
        "y": 1119,
        "w": 452,
        "h": 82
    },
    {
        "id": "d0fc9b194ba4d22c",
        "type": "http request",
        "z": "606aeeb2baf6caa6",
        "g": "42abad236eecfdfa",
        "name": "Google Sheet POST",
        "method": "POST",
        "ret": "txt",
        "paytoqs": "ignore",
        "url": "https://script.google.com/macros/s/AKfycbwaxSSrSiftaqOQjxaf7SnrXhTC2Y-AfhgqHExAbmzhtBNjmiS9woGSbhkzO_Hd4Ubc/exec",
        "tls": "",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [],
        "x": 2140,
        "y": 1160,
        "wires": [
            [
                "197037776ba7dc66"
            ]
        ]
    },
    {
        "id": "197037776ba7dc66",
        "type": "debug",
        "z": "606aeeb2baf6caa6",
        "g": "42abad236eecfdfa",
        "name": "ผลลัพธ์ Sheet",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 2340,
        "y": 1160,
        "wires": []
    },
    {
        "id": "1484cab31fed3268",
        "type": "group",
        "z": "606aeeb2baf6caa6",
        "g": "7351bc4077f8b06d",
        "name": "",
        "style": {
            "stroke": "#92d04f",
            "fill": "#c8e7a7",
            "label": true
        },
        "nodes": [
            "599175baf5f13179",
            "30d66094049224e6",
            "3ca7fa3841c37af7",
            "796bd2252fbbdcb5",
            "e116fe4cccab6c90",
            "34abc589ae4db28d",
            "2cc2c92634b1fd28",
            "b2152f6e44fc5d4e",
            "ce7d0137e81bfb7f",
            "a0dcfbcf7248afa1",
            "1e4a5d19797b0a2e",
            "940fa8e44e589e23",
            "2bfe06a53df9198d",
            "00a343b78808169e",
            "90dc4ed392226d2a",
            "6cb1ad65c5fac8a8",
            "e2094c34aa35a69e",
            "bc458b54619070dd",
            "237102653f6ab44a",
            "63e11e3cda445bde",
            "2f0c43fa5fa45cf0",
            "0c3d64b554bf5d27",
            "5af9b91fc6f42e24",
            "fdc357aea879887a",
            "27acb9ac6e27af79",
            "23376f8715e44660",
            "d62edf7d30c67f4d",
            "d8eb364fe72ea2e3",
            "8e8c74255b9764ad",
            "918c21e119a7e767",
            "2053869f04797f9e",
            "011f8fdf75116093"
        ],
        "x": 1834,
        "y": 1739,
        "w": 1412,
        "h": 442
    },
    {
        "id": "599175baf5f13179",
        "type": "Ind MC Read",
        "z": "606aeeb2baf6caa6",
        "g": "1484cab31fed3268",
        "name": "STEAM",
        "topic": "",
        "connection": "b449c13f6e1052fa",
        "address": "D337",
        "addressType": "str",
        "outputFormat": 0,
        "errorHandling": "throw",
        "outputs": 1,
        "x": 2140,
        "y": 1820,
        "wires": [
            [
                "a0dcfbcf7248afa1",
                "918c21e119a7e767"
            ]
        ]
    },
    {
        "id": "30d66094049224e6",
        "type": "Ind MC Read",
        "z": "606aeeb2baf6caa6",
        "g": "1484cab31fed3268",
        "name": "AIR",
        "topic": "",
        "connection": "b449c13f6e1052fa",
        "address": "D343",
        "addressType": "str",
        "outputFormat": 0,
        "errorHandling": "throw",
        "outputs": 1,
        "x": 2130,
        "y": 1860,
        "wires": [
            [
                "1e4a5d19797b0a2e"
            ]
        ]
    },
    {
        "id": "3ca7fa3841c37af7",
        "type": "Ind MC Read",
        "z": "606aeeb2baf6caa6",
        "g": "1484cab31fed3268",
        "name": "WATER",
        "topic": "",
        "connection": "b449c13f6e1052fa",
        "address": "D339",
        "addressType": "str",
        "outputFormat": 0,
        "errorHandling": "throw",
        "outputs": 1,
        "x": 2140,
        "y": 1900,
        "wires": [
            [
                "940fa8e44e589e23"
            ]
        ]
    },
    {
        "id": "796bd2252fbbdcb5",
        "type": "Ind MC Read",
        "z": "606aeeb2baf6caa6",
        "g": "1484cab31fed3268",
        "name": "VAC.",
        "topic": "",
        "connection": "b449c13f6e1052fa",
        "address": "D272",
        "addressType": "str",
        "outputFormat": 0,
        "errorHandling": "throw",
        "outputs": 1,
        "x": 2130,
        "y": 1940,
        "wires": [
            [
                "2bfe06a53df9198d"
            ]
        ]
    },
    {
        "id": "e116fe4cccab6c90",
        "type": "Ind MC Read",
        "z": "606aeeb2baf6caa6",
        "g": "1484cab31fed3268",
        "name": "Temp บ่อ RT200",
        "topic": "",
        "connection": "b449c13f6e1052fa",
        "address": "D323",
        "addressType": "str",
        "outputFormat": 0,
        "errorHandling": "throw",
        "outputs": 1,
        "x": 2160,
        "y": 2060,
        "wires": [
            [
                "6cb1ad65c5fac8a8"
            ]
        ]
    },
    {
        "id": "34abc589ae4db28d",
        "type": "Ind MC Read",
        "z": "606aeeb2baf6caa6",
        "g": "1484cab31fed3268",
        "name": "Temp บ่อน้ำร้อน",
        "topic": "",
        "connection": "b449c13f6e1052fa",
        "address": "D325",
        "addressType": "str",
        "outputFormat": 0,
        "errorHandling": "throw",
        "outputs": 1,
        "x": 2160,
        "y": 2100,
        "wires": [
            [
                "e2094c34aa35a69e"
            ]
        ]
    },
    {
        "id": "2cc2c92634b1fd28",
        "type": "Ind MC Read",
        "z": "606aeeb2baf6caa6",
        "g": "1484cab31fed3268",
        "name": "Temp ผสม",
        "topic": "",
        "connection": "b449c13f6e1052fa",
        "address": "D327",
        "addressType": "str",
        "outputFormat": 0,
        "errorHandling": "throw",
        "outputs": 1,
        "x": 2150,
        "y": 2140,
        "wires": [
            [
                "bc458b54619070dd"
            ]
        ]
    },
    {
        "id": "b2152f6e44fc5d4e",
        "type": "Ind MC Read",
        "z": "606aeeb2baf6caa6",
        "g": "1484cab31fed3268",
        "name": "ระดับน้ำในถังดีแอร์",
        "topic": "",
        "connection": "b449c13f6e1052fa",
        "address": "D167",
        "addressType": "str",
        "outputFormat": 0,
        "errorHandling": "throw",
        "outputs": 1,
        "x": 2170,
        "y": 1980,
        "wires": [
            [
                "00a343b78808169e"
            ]
        ]
    },
    {
        "id": "ce7d0137e81bfb7f",
        "type": "Ind MC Read",
        "z": "606aeeb2baf6caa6",
        "g": "1484cab31fed3268",
        "name": "Temp บ่อ RT100",
        "topic": "",
        "connection": "b449c13f6e1052fa",
        "address": "D321",
        "addressType": "str",
        "outputFormat": 0,
        "errorHandling": "throw",
        "outputs": 1,
        "x": 2160,
        "y": 2020,
        "wires": [
            [
                "90dc4ed392226d2a"
            ]
        ]
    },
    {
        "id": "a0dcfbcf7248afa1",
        "type": "function",
        "z": "606aeeb2baf6caa6",
        "g": "1484cab31fed3268",
        "name": "D337",
        "func": "msg.payload = (msg.payload.D337/10)\nmsg.topic = \"STEAM\";\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 2350,
        "y": 1820,
        "wires": [
            [
                "237102653f6ab44a",
                "63e11e3cda445bde",
                "011f8fdf75116093"
            ]
        ]
    },
    {
        "id": "1e4a5d19797b0a2e",
        "type": "function",
        "z": "606aeeb2baf6caa6",
        "g": "1484cab31fed3268",
        "name": "D343",
        "func": "msg.payload = (msg.payload.D343/10)\nmsg.topic = \"AIR\";\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 2350,
        "y": 1860,
        "wires": [
            [
                "237102653f6ab44a",
                "2f0c43fa5fa45cf0",
                "011f8fdf75116093"
            ]
        ]
    },
    {
        "id": "940fa8e44e589e23",
        "type": "function",
        "z": "606aeeb2baf6caa6",
        "g": "1484cab31fed3268",
        "name": "D339",
        "func": "msg.payload = (msg.payload.D339/10)\nmsg.topic = \"WATER\";\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 2350,
        "y": 1900,
        "wires": [
            [
                "237102653f6ab44a",
                "0c3d64b554bf5d27",
                "011f8fdf75116093"
            ]
        ]
    },
    {
        "id": "2bfe06a53df9198d",
        "type": "function",
        "z": "606aeeb2baf6caa6",
        "g": "1484cab31fed3268",
        "name": "D272",
        "func": "msg.payload = (msg.payload.D272/10)\nmsg.topic = \"VAC.\";\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 2350,
        "y": 1940,
        "wires": [
            [
                "237102653f6ab44a",
                "5af9b91fc6f42e24",
                "011f8fdf75116093"
            ]
        ]
    },
    {
        "id": "00a343b78808169e",
        "type": "function",
        "z": "606aeeb2baf6caa6",
        "g": "1484cab31fed3268",
        "name": "D167",
        "func": "msg.payload = (msg.payload.D167/10)\nmsg.topic = \"LEVELWATERDAIR\";\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 2350,
        "y": 1980,
        "wires": [
            [
                "237102653f6ab44a",
                "fdc357aea879887a",
                "011f8fdf75116093"
            ]
        ]
    },
    {
        "id": "90dc4ed392226d2a",
        "type": "function",
        "z": "606aeeb2baf6caa6",
        "g": "1484cab31fed3268",
        "name": "D321",
        "func": "msg.payload = (msg.payload.D321/10)\nmsg.topic = \"Temp_RT100\";\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 2350,
        "y": 2020,
        "wires": [
            [
                "237102653f6ab44a",
                "27acb9ac6e27af79",
                "011f8fdf75116093"
            ]
        ]
    },
    {
        "id": "6cb1ad65c5fac8a8",
        "type": "function",
        "z": "606aeeb2baf6caa6",
        "g": "1484cab31fed3268",
        "name": "D323",
        "func": "msg.payload = (msg.payload.D323/10)\nmsg.topic = \"Temp_200\";\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 2350,
        "y": 2060,
        "wires": [
            [
                "237102653f6ab44a",
                "23376f8715e44660",
                "011f8fdf75116093"
            ]
        ]
    },
    {
        "id": "e2094c34aa35a69e",
        "type": "function",
        "z": "606aeeb2baf6caa6",
        "g": "1484cab31fed3268",
        "name": "D325",
        "func": "msg.payload = (msg.payload.D325/10)\nmsg.topic = \"Temp_hot_water\";\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 2350,
        "y": 2100,
        "wires": [
            [
                "237102653f6ab44a",
                "d62edf7d30c67f4d",
                "011f8fdf75116093"
            ]
        ]
    },
    {
        "id": "bc458b54619070dd",
        "type": "function",
        "z": "606aeeb2baf6caa6",
        "g": "1484cab31fed3268",
        "name": "D327",
        "func": "msg.payload = (msg.payload.D327/10)\nmsg.topic = \"Temp_mix\";\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 2350,
        "y": 2140,
        "wires": [
            [
                "237102653f6ab44a",
                "d8eb364fe72ea2e3",
                "011f8fdf75116093"
            ]
        ]
    },
    {
        "id": "237102653f6ab44a",
        "type": "ui-chart",
        "z": "606aeeb2baf6caa6",
        "g": "1484cab31fed3268",
        "group": "daf82c4fefdf591d",
        "name": "",
        "label": "chart",
        "order": 12,
        "chartType": "line",
        "category": "topic",
        "categoryType": "msg",
        "xAxisLabel": "",
        "xAxisProperty": "",
        "xAxisPropertyType": "timestamp",
        "xAxisType": "time",
        "xAxisFormat": "",
        "xAxisFormatType": "auto",
        "xmin": "",
        "xmax": "",
        "yAxisLabel": "",
        "yAxisProperty": "payload",
        "yAxisPropertyType": "msg",
        "ymin": "",
        "ymax": "",
        "bins": 10,
        "action": "append",
        "stackSeries": false,
        "pointShape": "circle",
        "pointRadius": 4,
        "showLegend": true,
        "removeOlder": 1,
        "removeOlderUnit": "3600",
        "removeOlderPoints": "20",
        "colors": [
            "#0095ff",
            "#ff0000",
            "#ff7f0e",
            "#2ca02c",
            "#a347e1",
            "#d62728",
            "#ff9896",
            "#9467bd",
            "#c5b0d5"
        ],
        "textColor": [
            "#666666"
        ],
        "textColorDefault": true,
        "gridColor": [
            "#e5e5e5"
        ],
        "gridColorDefault": true,
        "width": 12,
        "height": 8,
        "className": "",
        "interpolation": "linear",
        "x": 2750,
        "y": 1960,
        "wires": [
            []
        ]
    },
    {
        "id": "63e11e3cda445bde",
        "type": "ui-text",
        "z": "606aeeb2baf6caa6",
        "g": "1484cab31fed3268",
        "group": "daf82c4fefdf591d",
        "order": 1,
        "width": 0,
        "height": 0,
        "name": "",
        "label": "STEAM",
        "format": "{{msg.payload}}",
        "layout": "row-spread",
        "style": false,
        "font": "",
        "fontSize": 16,
        "color": "#717171",
        "wrapText": false,
        "className": "",
        "value": "",
        "valueType": "msg",
        "x": 2520,
        "y": 1820,
        "wires": []
    },
    {
        "id": "2f0c43fa5fa45cf0",
        "type": "ui-text",
        "z": "606aeeb2baf6caa6",
        "g": "1484cab31fed3268",
        "group": "daf82c4fefdf591d",
        "order": 8,
        "width": 0,
        "height": 0,
        "name": "AIR",
        "label": "AIR",
        "format": "{{msg.payload}}",
        "layout": "row-spread",
        "style": false,
        "font": "",
        "fontSize": 16,
        "color": "#717171",
        "wrapText": false,
        "className": "",
        "value": "",
        "valueType": "msg",
        "x": 2510,
        "y": 1860,
        "wires": []
    },
    {
        "id": "0c3d64b554bf5d27",
        "type": "ui-text",
        "z": "606aeeb2baf6caa6",
        "g": "1484cab31fed3268",
        "group": "daf82c4fefdf591d",
        "order": 9,
        "width": 0,
        "height": 0,
        "name": "",
        "label": "WATER",
        "format": "{{msg.payload}}",
        "layout": "row-spread",
        "style": false,
        "font": "",
        "fontSize": 16,
        "color": "#717171",
        "wrapText": false,
        "className": "",
        "value": "",
        "valueType": "msg",
        "x": 2520,
        "y": 1900,
        "wires": []
    },
    {
        "id": "5af9b91fc6f42e24",
        "type": "ui-text",
        "z": "606aeeb2baf6caa6",
        "g": "1484cab31fed3268",
        "group": "daf82c4fefdf591d",
        "order": 6,
        "width": 0,
        "height": 0,
        "name": "",
        "label": "VAC.",
        "format": "{{msg.payload}}",
        "layout": "row-spread",
        "style": false,
        "font": "",
        "fontSize": 16,
        "color": "#717171",
        "wrapText": false,
        "className": "",
        "value": "",
        "valueType": "msg",
        "x": 2510,
        "y": 1940,
        "wires": []
    },
    {
        "id": "fdc357aea879887a",
        "type": "ui-text",
        "z": "606aeeb2baf6caa6",
        "g": "1484cab31fed3268",
        "group": "daf82c4fefdf591d",
        "order": 10,
        "width": 0,
        "height": 0,
        "name": "",
        "label": "LEVENWATERDAIR",
        "format": "{{msg.payload}}",
        "layout": "row-spread",
        "style": false,
        "font": "",
        "fontSize": 16,
        "color": "#717171",
        "wrapText": false,
        "className": "",
        "value": "payload",
        "valueType": "msg",
        "x": 2560,
        "y": 1980,
        "wires": []
    },
    {
        "id": "27acb9ac6e27af79",
        "type": "ui-text",
        "z": "606aeeb2baf6caa6",
        "g": "1484cab31fed3268",
        "group": "daf82c4fefdf591d",
        "order": 5,
        "width": 0,
        "height": 0,
        "name": "",
        "label": "TEMP 100",
        "format": "{{msg.payload}}",
        "layout": "row-spread",
        "style": false,
        "font": "",
        "fontSize": 16,
        "color": "#717171",
        "wrapText": false,
        "className": "",
        "value": "",
        "valueType": "msg",
        "x": 2530,
        "y": 2020,
        "wires": []
    },
    {
        "id": "23376f8715e44660",
        "type": "ui-text",
        "z": "606aeeb2baf6caa6",
        "g": "1484cab31fed3268",
        "group": "daf82c4fefdf591d",
        "order": 11,
        "width": 0,
        "height": 0,
        "name": "",
        "label": "TEMP 200",
        "format": "{{msg.payload}}",
        "layout": "row-spread",
        "style": false,
        "font": "",
        "fontSize": 16,
        "color": "#717171",
        "wrapText": false,
        "className": "",
        "value": "",
        "valueType": "msg",
        "x": 2530,
        "y": 2060,
        "wires": []
    },
    {
        "id": "d62edf7d30c67f4d",
        "type": "ui-text",
        "z": "606aeeb2baf6caa6",
        "g": "1484cab31fed3268",
        "group": "daf82c4fefdf591d",
        "order": 4,
        "width": 0,
        "height": 0,
        "name": "",
        "label": "TEMP WATER HOT",
        "format": "{{msg.payload}}",
        "layout": "row-spread",
        "style": false,
        "font": "",
        "fontSize": 16,
        "color": "#717171",
        "wrapText": false,
        "className": "",
        "value": "",
        "valueType": "msg",
        "x": 2560,
        "y": 2100,
        "wires": []
    },
    {
        "id": "d8eb364fe72ea2e3",
        "type": "ui-text",
        "z": "606aeeb2baf6caa6",
        "g": "1484cab31fed3268",
        "group": "daf82c4fefdf591d",
        "order": 7,
        "width": 0,
        "height": 0,
        "name": "",
        "label": "TMEP MIX",
        "format": "{{msg.payload}}",
        "layout": "row-spread",
        "style": false,
        "font": "",
        "fontSize": 16,
        "color": "#717171",
        "wrapText": false,
        "className": "",
        "value": "",
        "valueType": "msg",
        "x": 2530,
        "y": 2140,
        "wires": []
    },
    {
        "id": "8e8c74255b9764ad",
        "type": "inject",
        "z": "606aeeb2baf6caa6",
        "g": "1484cab31fed3268",
        "name": "",
        "props": [
            {
                "p": "payload"
            }
        ],
        "repeat": "1",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 1950,
        "y": 1980,
        "wires": [
            [
                "599175baf5f13179",
                "30d66094049224e6",
                "3ca7fa3841c37af7",
                "796bd2252fbbdcb5",
                "b2152f6e44fc5d4e",
                "ce7d0137e81bfb7f",
                "e116fe4cccab6c90",
                "34abc589ae4db28d",
                "2cc2c92634b1fd28"
            ]
        ]
    },
    {
        "id": "918c21e119a7e767",
        "type": "debug",
        "z": "606aeeb2baf6caa6",
        "g": "1484cab31fed3268",
        "name": "debug 104",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 2170,
        "y": 1780,
        "wires": []
    },
    {
        "id": "2053869f04797f9e",
        "type": "http request",
        "z": "606aeeb2baf6caa6",
        "g": "1484cab31fed3268",
        "name": "",
        "method": "POST",
        "ret": "obj",
        "paytoqs": "query",
        "url": "https://script.google.com/macros/s/AKfycbyWMMyxFodgynt4KGyuIqLJNYYG2Jw-opPshkZtJ721kxmwl-bXctjn7Y3bljDnWzp3wg/exec",
        "tls": "",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [],
        "x": 3150,
        "y": 1960,
        "wires": [
            []
        ]
    },
    {
        "id": "011f8fdf75116093",
        "type": "function",
        "z": "606aeeb2baf6caa6",
        "g": "1484cab31fed3268",
        "name": "sent to Google sheet",
        "func": "// 1. --- ตั้งค่า Config ---\nvar mySheetID = \"1RJ9OI8Bz8Xy_7HW7fZVQnjeYshDd0BZUZrkG3ycJfy0\"; \n\n\n// รับข้อมูลที่เข้ามา (ซึ่งอาจจะมาไม่ครบในรอบเดียว เพราะ Join ตัดรอบก่อน)\nvar data = msg.payload;\nvar now = new Date().toLocaleString(\"th-TH\", { timeZone: \"Asia/Bangkok\" });\n\n// 2. --- ดึงค่า \"ล่าสุด\" จากความจำ (Global) มาก่อน ---\n// ตรงนี้สำคัญ! มันช่วยจำค่าเดิมไว้ ถ้าข้อมูลใหม่มาไม่ครบ บรรทัดก็จะไม่แหว่ง\nvar savedData = global.get(\"utilityData\") || {};\n\n// ฟังก์ชันช่วยเช็คและอัปเดตค่า (ถ้ามีค่าใหม่มาให้ทับของเก่า ถ้าไม่มีให้ข้าม)\nfunction updateVal(key, val) {\n    if (val !== undefined && val !== null && val !== \"\") {\n        savedData[key] = parseFloat(val);\n    }\n}\n\n// อัปเดตข้อมูลใหม่ลงไปทับของเก่า\nupdateVal(\"STEAM\", data.STEAM);\nupdateVal(\"AIR\", data.AIR);\nupdateVal(\"WATER\", data.WATER);\nupdateVal(\"LEVELWATERDAIR\", data.LEVELWATERDAIR); // จากระดับน้ำในถังดีแอร์\nupdateVal(\"Temp_RT100\", data.Temp_RT100);\nupdateVal(\"Temp_200\", data.Temp_200);\nupdateVal(\"Temp_hot_water\", data.Temp_hot_water);\nupdateVal(\"Temp_mix\", data.Temp_mix);\n\n// บันทึกค่าล่าสุดกลับลง Global เพื่อใช้รอบหน้า\nglobal.set(\"utilityData\", savedData);\n\n\n// 3. --- ส่วน React Dashboard (ถ้าใช้แสดงผลบนเว็บ) ---\nvar reactData = {\n    id: machineName,\n    name: machineName,\n    ...savedData, // กระจายข้อมูลทั้งหมดเข้าไป\n    timestamp: now\n};\n// เก็บลงตัวแปรกลางสำหรับ Dashboard (ถ้าจำเป็น)\nvar allMachines = global.get(\"machineData\") || [];\n// (ส่วนนี้ถ้าไม่ได้ใช้ Dashboard รวมกับเครื่องจักรอื่น อาจจะไม่ต้องซีเรียสมากครับ)\n\n\n// 4. --- เตรียมส่ง Google Sheet (ส่งทีเดียวครบทุกตัว) ---\nmsg.payload = {\n    \"spreadsheetId\": mySheetID,\n    \"timestamp\": now,\n    \"machine_no\": machineName,\n    \n    // ดึงค่าจาก savedData (ตัวที่รวมร่างสมบูรณ์แล้ว)\n    \"STEAM\": savedData.STEAM || 0,\n    \"AIR\": savedData.AIR || 0,\n    \"WATER\": savedData.WATER || 0,\n    \"LEVELWATERDAIR\": savedData.LEVELWATERDAIR || 0,\n    \"Temp_RT100\": savedData.Temp_RT100 || 0,\n    \"Temp_200\": savedData.Temp_200 || 0,\n    \"Temp_hot_water\": savedData.Temp_hot_water || 0,\n    \"Temp_mix\": savedData.Temp_mix || 0\n};\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 2940,
        "y": 1960,
        "wires": [
            []
        ]
    },
    {
        "id": "b449c13f6e1052fa",
        "type": "Ind MC Protocol Connection",
        "name": "ตู้รวม",
        "host": "192.168.7.115",
        "port": "9030",
        "protocol": "TCP",
        "frame": "1E",
        "plcType": "Q",
        "ascii": false,
        "PLCStation": "",
        "PCStation": "",
        "PLCModuleNo": "",
        "network": "",
        "octalInputOutput": true,
        "timeout": 1000,
        "autoConnect": true
    },
    {
        "id": "daf82c4fefdf591d",
        "type": "ui-group",
        "name": "Group 1",
        "page": "ddbc4b8948de9b88",
        "width": 12,
        "height": 1,
        "order": 1,
        "showTitle": true,
        "className": "",
        "visible": "true",
        "disabled": "false",
        "groupType": "default"
    },
    {
        "id": "ddbc4b8948de9b88",
        "type": "ui-page",
        "name": "Page 1",
        "ui": "7bb7adaaddc0953a",
        "path": "/page1",
        "icon": "home",
        "layout": "grid",
        "theme": "1fbd4067e521f2d3",
        "breakpoints": [
            {
                "name": "Default",
                "px": "0",
                "cols": "3"
            },
            {
                "name": "Tablet",
                "px": "576",
                "cols": "6"
            },
            {
                "name": "Small Desktop",
                "px": "768",
                "cols": "9"
            },
            {
                "name": "Desktop",
                "px": "1024",
                "cols": "12"
            }
        ],
        "order": 14,
        "className": "",
        "visible": "true",
        "disabled": "false"
    },
    {
        "id": "7bb7adaaddc0953a",
        "type": "ui-base",
        "name": "My Dashboard",
        "path": "/dashboard",
        "appIcon": "",
        "includeClientData": true,
        "acceptsClientConfig": [
            "ui-notification",
            "ui-control",
            "ui-button"
        ],
        "showPathInSidebar": false,
        "headerContent": "dashboard",
        "navigationStyle": "default",
        "titleBarStyle": "default",
        "showReconnectNotification": true,
        "notificationDisplayTime": 1,
        "showDisconnectNotification": true,
        "allowInstall": true
    },
    {
        "id": "1fbd4067e521f2d3",
        "type": "ui-theme",
        "name": "Default Theme",
        "colors": {
            "surface": "#ffffff",
            "primary": "#0094ce",
            "bgPage": "#ffffff",
            "groupBg": "#ffffff",
            "groupOutline": "#cccccc"
        },
        "sizes": {
            "density": "default",
            "pagePadding": "12px",
            "groupGap": "12px",
            "groupBorderRadius": "4px",
            "widgetGap": "12px"
        }
    },
    {
        "id": "a811b8754360ea14",
        "type": "global-config",
        "env": [],
        "modules": {
            "node-red-contrib-modbus": "5.45.2",
            "node-red-contrib-mcprotocol-ind": "1.7.0",
            "@flowfuse/node-red-dashboard": "1.30.1"
        }
    }
]